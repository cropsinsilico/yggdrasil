

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>OpenMP Threading in Models &mdash; yggdrasil v1.6.3+1.g236eabc85.dirty documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Examples" href="examples/examples_toc.html" />
    <link rel="prev" title="Debugging" href="debugging.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> yggdrasil
          

          
          </a>

          
            
            
              <div class="version">
                v1.6.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="includeme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="formatted_io.html">Formatted I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="server_client_io.html">Server/Client I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="autowrap.html">Autowrapping Model Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="autowrap.html#notes-on-autowrapping-c-c-model-functions">Notes on Autowrapping C/C++ Model Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_io.html">Conditional I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="transformed_io.html">Transformed I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="timesync_io.html">Timestep Synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="yaml.html">YAML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_format_strings.html">C-Style Format Strings</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">OpenMP Threading in Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/examples_toc.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced/index.html">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="hackathon2018/index.html">Welcome to the 2018 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="hackathon2019/index.html">Welcome to the 2019 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="hackathon2021/index.html">Welcome to the 2021 Crops in Silico Hackathon!</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">yggdrasil</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>OpenMP Threading in Models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/threading.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="openmp-threading-in-models">
<span id="threading-rst"></span><h1>OpenMP Threading in Models<a class="headerlink" href="#openmp-threading-in-models" title="Permalink to this headline">Â¶</a></h1>
<p>Models written in C, C++, or Fortran can make use of threading via OpenMP, but
need to follow a few rules to work nicely with yggdrasil.</p>
<ol class="arabic simple">
<li><p>Models that will use threading need to have <code class="docutils literal notranslate"><span class="pre">allow_threading:</span> <span class="pre">true</span></code> in
their YAML specification to tell yggdrasil that comms should allow
multiple threads to connect to the same comm.</p></li>
<li><p>In their source code, models need to call the <code class="docutils literal notranslate"><span class="pre">ygg_init()</span></code> funciton
before any threaded sections that make calls to the yggdrasil interface.</p></li>
<li><p>Comms that are used inside threads must be initialized by the thread that
will use it. Each thread can connect to the same channel (use the same
name etc.), but it must be initialized on the thread.</p></li>
<li><p>Comms that are used inside threads must be initialized using the
<code class="docutils literal notranslate"><span class="pre">WITH_GLOBAL_SCOPE</span></code> macro so that comms are stored for reuse during
subsequent calls to the same interface initialization.</p></li>
<li><p>Do not explicitly cleanup comms that are used inside threads. Doing so
may cause the connection to be permanently disconnected. yggdrasil
will clean these up at exit.</p></li>
</ol>
<p>An example using threading can be seen below that follows these rules</p>
<p>Model Code:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">model_function</span><span class="p">(</span><span class="n">in_buf</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;server</span><span class="si">%s</span><span class="s2">(Python): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;YGG_MODEL_COPY&#39;</span><span class="p">],</span> <span class="n">in_buf</span><span class="p">))</span>
    <span class="n">out_buf</span> <span class="o">=</span> <span class="n">in_buf</span>
    <span class="k">return</span> <span class="n">out_buf</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;YggInterface.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>


<span class="kt">int</span> <span class="nf">model_function</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">in_buf</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">length_in_buf</span><span class="p">,</span>
		   <span class="kt">char</span><span class="o">**</span> <span class="n">out_buf</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="o">*</span> <span class="n">length_out_buf</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ygg_init</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">error_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nthreads</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;NTHREAD&quot;</span><span class="p">));</span>
<span class="cp">#ifdef _OPENMP</span>
  <span class="n">omp_set_num_threads</span><span class="p">(</span><span class="n">nthreads</span><span class="p">);</span>
<span class="cp">#pragma omp parallel for shared(error_code)</span>
<span class="cp">#endif</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nthreads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
<span class="cp">#ifdef _OPENMP</span>
<span class="cp">#pragma omp critical</span>
    <span class="p">{</span>
<span class="cp">#endif</span>
      <span class="n">flag</span> <span class="o">=</span> <span class="n">error_code</span><span class="p">;</span>
<span class="cp">#ifdef _OPENMP</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">char</span><span class="o">*</span> <span class="n">out_temp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="kt">uint64_t</span> <span class="n">length_out_temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">char</span><span class="o">**</span> <span class="n">out_buf_temp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">out_temp</span><span class="p">;</span>
      <span class="kt">uint64_t</span><span class="o">*</span> <span class="n">length_out_buf_temp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">length_out_temp</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">out_buf_temp</span> <span class="o">=</span> <span class="n">out_buf</span><span class="p">;</span>
	<span class="n">length_out_buf_temp</span> <span class="o">=</span> <span class="n">length_out_buf</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// The WITH_GLOBAL_SCOPE macro is required to ensure that the</span>
      <span class="c1">// comm persists between function calls</span>
      <span class="n">WITH_GLOBAL_SCOPE</span><span class="p">(</span><span class="n">yggRpc_t</span> <span class="n">rpc</span> <span class="o">=</span> <span class="n">yggRpcClient</span><span class="p">(</span><span class="s">&quot;server_client&quot;</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">));</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Sending %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">i</span><span class="p">,</span> <span class="n">in_buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
      <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">rpcCallRealloc</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span> <span class="n">in_buf</span><span class="p">,</span> <span class="n">length_in_buf</span><span class="p">,</span>
			       <span class="n">out_buf_temp</span><span class="p">,</span> <span class="n">length_out_buf_temp</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Received %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">i</span><span class="p">,</span> <span class="n">in_buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): RPC CALL ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#ifdef _OPENMP</span>
<span class="cp">#pragma omp critical</span>
	<span class="p">{</span>
<span class="cp">#endif</span>
	  <span class="n">error_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef _OPENMP</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">free</span><span class="p">(</span><span class="n">out_temp</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">error_code</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>(<a class="reference external" href="examples/rpc_lesson3b.html">Example in other languages</a>)</p>
<p>Model YAML:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">server</span>
  <span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
  <span class="nt">args</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./src/server.py</span>
  <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">model_function</span>
  <span class="nt">is_server</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
  <span class="nt">copies</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">client</span>
  <span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">c</span>
  <span class="nt">args</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./src/client.c</span>
  <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">model_function</span>
  <span class="nt">client_of</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">server</span>
  <span class="nt">compiler_flags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
  <span class="nt">linker_flags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
  <span class="nt">allow_threading</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">env</span><span class="p">:</span>
    <span class="nt">NTHREAD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
  <span class="nt">inputs</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">in_buf</span>
    <span class="nt">default_file</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./Input/input.txt</span>
      <span class="nt">filetype</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ascii</span>
  <span class="nt">outputs</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">out_buf</span>
    <span class="nt">default_file</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./client_output.txt</span>
      <span class="nt">in_temp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</td></tr></table></div>
<p>(<a class="reference external" href="examples/rpc_lesson3b.html">Example in other languages</a>)</p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="examples/examples_toc.html" class="btn btn-neutral float-right" title="Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="debugging.html" class="btn btn-neutral float-left" title="Debugging" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, Meagan Lang, David Raila.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>