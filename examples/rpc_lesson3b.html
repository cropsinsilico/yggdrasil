<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rpc_lesson3b &mdash; yggdrasil v1.9.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            yggdrasil
          </a>
              <div class="version">
                v1.9.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../includeme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../formatted_io.html">Formatted I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server_client_io.html">Server/Client I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autowrap.html">Autowrapping Model Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conditional_io.html">Conditional I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transformed_io.html">Transformed I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timesync_io.html">Timestep Synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../yaml.html">YAML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Command Line Interface (CLI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc.html">High Performance Computing (HPC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote.html">Running Integrations as Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker.html">Docker Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../c_format_strings.html">C-Style Format Strings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../threading.html">OpenMP Threading in Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples_toc.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hackathon2018/index.html">Welcome to the 2018 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hackathon2019/index.html">Welcome to the 2019 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hackathon2021/index.html">Welcome to the 2021 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">yggdrasil</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">rpc_lesson3b</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/rpc_lesson3b.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="rpc-lesson3b">
<span id="rpc-lesson3b-rst"></span><h1>rpc_lesson3b<a class="headerlink" href="#rpc-lesson3b" title="Permalink to this heading">¶</a></h1>
<p>This example is identical to the <cite>rpc_lesson3</cite> example except that 10 copies of the <cite>server</cite> model are run via the <cite>copies</cite> model parameter and the <cite>client</cite> model makes calls the server from inside an OpenMP threaded loop. This example demonstrates the use of the RPC communication pattern in conjunction with automated model wrapping, OpenMP threading, and model duplication.</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#c-version" id="id2">C Version</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id3">C++ Version</a></p></li>
<li><p><a class="reference internal" href="#fortran-version" id="id4">Fortran Version</a></p></li>
<li><p><a class="reference internal" href="#matlab-version" id="id5">Matlab Version</a></p></li>
<li><p><a class="reference internal" href="#python-version" id="id6">Python Version</a></p></li>
<li><p><a class="reference internal" href="#r-version" id="id7">R Version</a></p></li>
</ul>
</nav>
<section id="c-version">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">C Version</a><a class="headerlink" href="#c-version" title="Permalink to this heading">¶</a></h2>
<p>Model Code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">model_function</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos"> 4</span><span class="w">		   </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="n">length_out_buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;server%d(C): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;YGG_MODEL_COPY&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">in_buf</span><span class="p">);</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="n">length_out_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="n">out_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">length_in_buf</span><span class="p">);</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">out_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">);</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">out_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">length_in_buf</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos">10</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">11</span><span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;YggInterface.h&quot;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">model_function</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">		   </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="c1">// Initialize yggdrasil outside the threaded section</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">ygg_init</span><span class="p">();</span>
<span class="linenos">10</span><span class="w">  </span>
<span class="linenos">11</span><span class="w">  </span><span class="c1">// Get the number of threads from an environment variable set in the yaml</span>
<span class="linenos">12</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nthreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;NTHREAD&quot;</span><span class="p">));</span>
<span class="linenos">13</span><span class="w">  </span>
<span class="linenos">14</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">omp_set_num_threads</span><span class="p">(</span><span class="n">nthreads</span><span class="p">);</span>
<span class="linenos">17</span><span class="cp">#pragma omp parallel for shared(error_code)</span>
<span class="linenos">18</span><span class="cp">#endif</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nthreads</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>
<span class="linenos">21</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">22</span><span class="cp">#pragma omp critical</span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">24</span><span class="cp">#endif</span>
<span class="linenos">25</span><span class="w">      </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">26</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">28</span><span class="cp">#endif</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">30</span><span class="w">      </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">31</span><span class="w">      </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">      </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_temp</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">      </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length_out_temp</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">35</span><span class="w">	</span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out_buf</span><span class="p">;</span>
<span class="linenos">36</span><span class="w">	</span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">;</span>
<span class="linenos">37</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">38</span><span class="w">      </span>
<span class="linenos">39</span><span class="w">      </span><span class="c1">// The WITH_GLOBAL_SCOPE macro is required to ensure that the</span>
<span class="linenos">40</span><span class="w">      </span><span class="c1">// comm persists between function calls</span>
<span class="linenos">41</span><span class="w">      </span><span class="n">WITH_GLOBAL_SCOPE</span><span class="p">(</span><span class="n">yggRpc_t</span><span class="w"> </span><span class="n">rpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yggRpcClient</span><span class="p">(</span><span class="s">&quot;server_client&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">));</span>
<span class="linenos">42</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Sending %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">43</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">44</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpcCallRealloc</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos">45</span><span class="w">			       </span><span class="n">out_buf_temp</span><span class="p">,</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="p">);</span>
<span class="linenos">46</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Received %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">47</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">48</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">49</span><span class="w">	</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): RPC CALL ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">50</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">51</span><span class="cp">#pragma omp critical</span>
<span class="linenos">52</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">53</span><span class="cp">#endif</span>
<span class="linenos">54</span><span class="w">	  </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">55</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">56</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">57</span><span class="cp">#endif</span>
<span class="linenos">58</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">59</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">60</span><span class="w">	</span><span class="n">free</span><span class="p">(</span><span class="n">out_temp</span><span class="p">);</span>
<span class="linenos">61</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">62</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">63</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">64</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">65</span><span class="p">}</span>
</pre></div>
</div>
<p>Model YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nn">---</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/server.c</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="nt">is_server</span><span class="p">:</span><span class="w">  </span><span class="c1"># Creates a RPC server queue called &quot;server&quot;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">in_buf</span>
<span class="linenos">10</span><span class="w">    </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">out_buf</span>
<span class="linenos">11</span><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">in_buf</span>
<span class="linenos">12</span><span class="w">  </span><span class="nt">outputs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">out_buf</span>
<span class="linenos">13</span><span class="w">  </span><span class="nt">copies</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/client.c</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="nt">client_of</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="nt">compiler_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="nt">linker_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="nt">allow_threading</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">10</span><span class="w">  </span><span class="nt">env</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">    </span><span class="nt">NTHREAD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="linenos">12</span><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">in_buf</span>
<span class="linenos">14</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./Input/input.txt</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">filetype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ascii</span>
<span class="linenos">17</span><span class="w">  </span><span class="nt">outputs</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">out_buf</span>
<span class="linenos">19</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./client_output.txt</span>
<span class="linenos">21</span><span class="w">      </span><span class="nt">in_temp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="id1">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">C++ Version</a><a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h2>
<p>Model Code:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">model_function</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos"> 4</span><span class="w">		   </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length_out_buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;server&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;YGG_MODEL_COPY&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;(C++): &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">in_buf</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="n">length_out_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="n">out_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">realloc</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">);</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">);</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">out_buf</span><span class="p">[</span><span class="n">length_in_buf</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos">10</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">11</span><span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;YggInterface.h&quot;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">model_function</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">		   </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="c1">// Initialize yggdrasil outside the threaded section</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">ygg_init</span><span class="p">();</span>
<span class="linenos">10</span><span class="w">  </span>
<span class="linenos">11</span><span class="w">  </span><span class="c1">// Get the number of threads from an environment variable set in the yaml</span>
<span class="linenos">12</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nthreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;NTHREAD&quot;</span><span class="p">));</span>
<span class="linenos">13</span><span class="w">  </span>
<span class="linenos">14</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">omp_set_num_threads</span><span class="p">(</span><span class="n">nthreads</span><span class="p">);</span>
<span class="linenos">17</span><span class="cp">#pragma omp parallel for shared(error_code)</span>
<span class="linenos">18</span><span class="cp">#endif</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nthreads</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>
<span class="linenos">21</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">22</span><span class="cp">#pragma omp critical</span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">24</span><span class="cp">#endif</span>
<span class="linenos">25</span><span class="w">      </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">26</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">28</span><span class="cp">#endif</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">30</span><span class="w">      </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">31</span><span class="w">      </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">      </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_temp</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">      </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length_out_temp</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">35</span><span class="w">	</span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out_buf</span><span class="p">;</span>
<span class="linenos">36</span><span class="w">	</span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">;</span>
<span class="linenos">37</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">38</span><span class="w">      </span>
<span class="linenos">39</span><span class="w">      </span><span class="c1">// The WITH_GLOBAL_SCOPE macro is required to ensure that the</span>
<span class="linenos">40</span><span class="w">      </span><span class="c1">// comm persists between function calls</span>
<span class="linenos">41</span><span class="w">      </span><span class="n">WITH_GLOBAL_SCOPE</span><span class="p">(</span><span class="n">yggRpc_t</span><span class="w"> </span><span class="n">rpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yggRpcClient</span><span class="p">(</span><span class="s">&quot;server_client&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">));</span>
<span class="linenos">42</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Sending %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">43</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">44</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpcCallRealloc</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos">45</span><span class="w">			       </span><span class="n">out_buf_temp</span><span class="p">,</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="p">);</span>
<span class="linenos">46</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Received %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">47</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">48</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">49</span><span class="w">	</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): RPC CALL ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">50</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">51</span><span class="cp">#pragma omp critical</span>
<span class="linenos">52</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">53</span><span class="cp">#endif</span>
<span class="linenos">54</span><span class="w">	  </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">55</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">56</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">57</span><span class="cp">#endif</span>
<span class="linenos">58</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">59</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">60</span><span class="w">	</span><span class="n">free</span><span class="p">(</span><span class="n">out_temp</span><span class="p">);</span>
<span class="linenos">61</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">62</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">63</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">64</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">65</span><span class="p">}</span>
</pre></div>
</div>
<p>Model YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nn">---</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos">4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos">5</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c++</span>
<span class="linenos">6</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/server.cpp</span>
<span class="linenos">7</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos">8</span><span class="w">  </span><span class="nt">is_server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">  </span><span class="c1"># Creates a RPC server queue called &quot;server&quot;</span>
<span class="linenos">9</span><span class="w">  </span><span class="nt">copies</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/client.c</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="nt">client_of</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="nt">compiler_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="nt">linker_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="nt">allow_threading</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">10</span><span class="w">  </span><span class="nt">env</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">    </span><span class="nt">NTHREAD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="linenos">12</span><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">in_buf</span>
<span class="linenos">14</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./Input/input.txt</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">filetype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ascii</span>
<span class="linenos">17</span><span class="w">  </span><span class="nt">outputs</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">out_buf</span>
<span class="linenos">19</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./client_output.txt</span>
<span class="linenos">21</span><span class="w">      </span><span class="nt">in_temp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="fortran-version">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Fortran Version</a><a class="headerlink" href="#fortran-version" title="Permalink to this heading">¶</a></h2>
<p>Model Code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">function</span> <span class="n">model_function</span><span class="p">(</span><span class="n">in_buf</span><span class="p">,</span> <span class="n">out_buf</span><span class="p">)</span> <span class="n">result</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos"> 2</span>  <span class="n">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="n">intent</span><span class="p">(</span><span class="ow">in</span><span class="p">)</span> <span class="p">::</span> <span class="n">in_buf</span>
<span class="linenos"> 3</span>  <span class="n">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span> <span class="n">pointer</span> <span class="p">::</span> <span class="n">out_buf</span>
<span class="linenos"> 4</span>  <span class="n">logical</span> <span class="p">::</span> <span class="n">out</span>
<span class="linenos"> 5</span>  <span class="n">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span> <span class="p">::</span> <span class="n">copy_str</span>
<span class="linenos"> 6</span>  <span class="n">integer</span> <span class="p">::</span> <span class="n">copy</span>
<span class="linenos"> 7</span>  <span class="n">call</span> <span class="n">get_environment_variable</span><span class="p">(</span><span class="s2">&quot;YGG_MODEL_COPY&quot;</span><span class="p">,</span> <span class="n">copy_str</span><span class="p">)</span>
<span class="linenos"> 8</span>  <span class="n">read</span><span class="p">(</span><span class="n">copy_str</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">copy</span>
<span class="linenos"> 9</span>  <span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(&quot;server&quot;,I1,&quot;(Fortran): &quot;,A)&#39;</span><span class="p">)</span> <span class="n">copy</span><span class="p">,</span> <span class="n">in_buf</span>
<span class="linenos">10</span>  <span class="n">out</span> <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="linenos">11</span>  <span class="n">allocate</span><span class="p">(</span><span class="n">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">in_buf</span><span class="p">))</span> <span class="p">::</span> <span class="n">out_buf</span><span class="p">)</span>
<span class="linenos">12</span>  <span class="n">out_buf</span> <span class="o">=</span> <span class="n">in_buf</span>
<span class="linenos">13</span><span class="n">end</span> <span class="n">function</span> <span class="n">model_function</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;YggInterface.h&quot;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">model_function</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">		   </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="c1">// Initialize yggdrasil outside the threaded section</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">ygg_init</span><span class="p">();</span>
<span class="linenos">10</span><span class="w">  </span>
<span class="linenos">11</span><span class="w">  </span><span class="c1">// Get the number of threads from an environment variable set in the yaml</span>
<span class="linenos">12</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nthreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;NTHREAD&quot;</span><span class="p">));</span>
<span class="linenos">13</span><span class="w">  </span>
<span class="linenos">14</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">omp_set_num_threads</span><span class="p">(</span><span class="n">nthreads</span><span class="p">);</span>
<span class="linenos">17</span><span class="cp">#pragma omp parallel for shared(error_code)</span>
<span class="linenos">18</span><span class="cp">#endif</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nthreads</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>
<span class="linenos">21</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">22</span><span class="cp">#pragma omp critical</span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">24</span><span class="cp">#endif</span>
<span class="linenos">25</span><span class="w">      </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">26</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">28</span><span class="cp">#endif</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">30</span><span class="w">      </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">31</span><span class="w">      </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">      </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_temp</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">      </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length_out_temp</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">35</span><span class="w">	</span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out_buf</span><span class="p">;</span>
<span class="linenos">36</span><span class="w">	</span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">;</span>
<span class="linenos">37</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">38</span><span class="w">      </span>
<span class="linenos">39</span><span class="w">      </span><span class="c1">// The WITH_GLOBAL_SCOPE macro is required to ensure that the</span>
<span class="linenos">40</span><span class="w">      </span><span class="c1">// comm persists between function calls</span>
<span class="linenos">41</span><span class="w">      </span><span class="n">WITH_GLOBAL_SCOPE</span><span class="p">(</span><span class="n">yggRpc_t</span><span class="w"> </span><span class="n">rpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yggRpcClient</span><span class="p">(</span><span class="s">&quot;server_client&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">));</span>
<span class="linenos">42</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Sending %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">43</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">44</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpcCallRealloc</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos">45</span><span class="w">			       </span><span class="n">out_buf_temp</span><span class="p">,</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="p">);</span>
<span class="linenos">46</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Received %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">47</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">48</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">49</span><span class="w">	</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): RPC CALL ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">50</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">51</span><span class="cp">#pragma omp critical</span>
<span class="linenos">52</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">53</span><span class="cp">#endif</span>
<span class="linenos">54</span><span class="w">	  </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">55</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">56</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">57</span><span class="cp">#endif</span>
<span class="linenos">58</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">59</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">60</span><span class="w">	</span><span class="n">free</span><span class="p">(</span><span class="n">out_temp</span><span class="p">);</span>
<span class="linenos">61</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">62</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">63</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">64</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">65</span><span class="p">}</span>
</pre></div>
</div>
<p>Model YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nn">---</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos">4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos">5</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fortran</span>
<span class="linenos">6</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/server.f90</span>
<span class="linenos">7</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos">8</span><span class="w">  </span><span class="nt">is_server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">  </span><span class="c1"># Creates a RPC server queue called &quot;server&quot;</span>
<span class="linenos">9</span><span class="w">  </span><span class="nt">copies</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/client.c</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="nt">client_of</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="nt">compiler_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="nt">linker_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="nt">allow_threading</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">10</span><span class="w">  </span><span class="nt">env</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">    </span><span class="nt">NTHREAD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="linenos">12</span><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">in_buf</span>
<span class="linenos">14</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./Input/input.txt</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">filetype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ascii</span>
<span class="linenos">17</span><span class="w">  </span><span class="nt">outputs</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">out_buf</span>
<span class="linenos">19</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./client_output.txt</span>
<span class="linenos">21</span><span class="w">      </span><span class="nt">in_temp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="matlab-version">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Matlab Version</a><a class="headerlink" href="#matlab-version" title="Permalink to this heading">¶</a></h2>
<p>Model Code:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">function</span><span class="w"> </span>out_buf<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">server</span><span class="p">(</span>in_buf<span class="p">)</span>
<span class="linenos">2</span><span class="w">  </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;server(Matlab): %s\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">);</span>
<span class="linenos">3</span><span class="w">  </span><span class="n">out_buf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">in_buf</span><span class="p">;</span>
<span class="linenos">4</span><span class="k">end</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;YggInterface.h&quot;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">model_function</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">		   </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="c1">// Initialize yggdrasil outside the threaded section</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">ygg_init</span><span class="p">();</span>
<span class="linenos">10</span><span class="w">  </span>
<span class="linenos">11</span><span class="w">  </span><span class="c1">// Get the number of threads from an environment variable set in the yaml</span>
<span class="linenos">12</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nthreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;NTHREAD&quot;</span><span class="p">));</span>
<span class="linenos">13</span><span class="w">  </span>
<span class="linenos">14</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">omp_set_num_threads</span><span class="p">(</span><span class="n">nthreads</span><span class="p">);</span>
<span class="linenos">17</span><span class="cp">#pragma omp parallel for shared(error_code)</span>
<span class="linenos">18</span><span class="cp">#endif</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nthreads</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>
<span class="linenos">21</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">22</span><span class="cp">#pragma omp critical</span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">24</span><span class="cp">#endif</span>
<span class="linenos">25</span><span class="w">      </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">26</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">28</span><span class="cp">#endif</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">30</span><span class="w">      </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">31</span><span class="w">      </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">      </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_temp</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">      </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length_out_temp</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">35</span><span class="w">	</span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out_buf</span><span class="p">;</span>
<span class="linenos">36</span><span class="w">	</span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">;</span>
<span class="linenos">37</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">38</span><span class="w">      </span>
<span class="linenos">39</span><span class="w">      </span><span class="c1">// The WITH_GLOBAL_SCOPE macro is required to ensure that the</span>
<span class="linenos">40</span><span class="w">      </span><span class="c1">// comm persists between function calls</span>
<span class="linenos">41</span><span class="w">      </span><span class="n">WITH_GLOBAL_SCOPE</span><span class="p">(</span><span class="n">yggRpc_t</span><span class="w"> </span><span class="n">rpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yggRpcClient</span><span class="p">(</span><span class="s">&quot;server_client&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">));</span>
<span class="linenos">42</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Sending %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">43</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">44</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpcCallRealloc</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos">45</span><span class="w">			       </span><span class="n">out_buf_temp</span><span class="p">,</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="p">);</span>
<span class="linenos">46</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Received %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">47</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">48</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">49</span><span class="w">	</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): RPC CALL ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">50</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">51</span><span class="cp">#pragma omp critical</span>
<span class="linenos">52</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">53</span><span class="cp">#endif</span>
<span class="linenos">54</span><span class="w">	  </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">55</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">56</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">57</span><span class="cp">#endif</span>
<span class="linenos">58</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">59</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">60</span><span class="w">	</span><span class="n">free</span><span class="p">(</span><span class="n">out_temp</span><span class="p">);</span>
<span class="linenos">61</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">62</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">63</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">64</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">65</span><span class="p">}</span>
</pre></div>
</div>
<p>Model YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nn">---</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos">4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos">5</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matlab</span>
<span class="linenos">6</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/server.m</span>
<span class="linenos">7</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span><span class="w">  </span><span class="c1"># matlab requires function to match file</span>
<span class="linenos">8</span><span class="w">  </span><span class="nt">is_server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">  </span><span class="c1"># Creates a RPC server queue called &quot;server&quot;</span>
<span class="linenos">9</span><span class="w">  </span><span class="nt">copies</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/client.c</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="nt">client_of</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="nt">compiler_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="nt">linker_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="nt">allow_threading</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">10</span><span class="w">  </span><span class="nt">env</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">    </span><span class="nt">NTHREAD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="linenos">12</span><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">in_buf</span>
<span class="linenos">14</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./Input/input.txt</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">filetype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ascii</span>
<span class="linenos">17</span><span class="w">  </span><span class="nt">outputs</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">out_buf</span>
<span class="linenos">19</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./client_output.txt</span>
<span class="linenos">21</span><span class="w">      </span><span class="nt">in_temp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="python-version">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Python Version</a><a class="headerlink" href="#python-version" title="Permalink to this heading">¶</a></h2>
<p>Model Code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos">2</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="k">def</span> <span class="nf">model_function</span><span class="p">(</span><span class="n">in_buf</span><span class="p">):</span>
<span class="linenos">5</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;server</span><span class="si">%s</span><span class="s2">(Python): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;YGG_MODEL_COPY&#39;</span><span class="p">],</span> <span class="n">in_buf</span><span class="p">))</span>
<span class="linenos">6</span>    <span class="n">out_buf</span> <span class="o">=</span> <span class="n">in_buf</span>
<span class="linenos">7</span>    <span class="k">return</span> <span class="n">out_buf</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;YggInterface.h&quot;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">model_function</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">		   </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="c1">// Initialize yggdrasil outside the threaded section</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">ygg_init</span><span class="p">();</span>
<span class="linenos">10</span><span class="w">  </span>
<span class="linenos">11</span><span class="w">  </span><span class="c1">// Get the number of threads from an environment variable set in the yaml</span>
<span class="linenos">12</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nthreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;NTHREAD&quot;</span><span class="p">));</span>
<span class="linenos">13</span><span class="w">  </span>
<span class="linenos">14</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">omp_set_num_threads</span><span class="p">(</span><span class="n">nthreads</span><span class="p">);</span>
<span class="linenos">17</span><span class="cp">#pragma omp parallel for shared(error_code)</span>
<span class="linenos">18</span><span class="cp">#endif</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nthreads</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>
<span class="linenos">21</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">22</span><span class="cp">#pragma omp critical</span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">24</span><span class="cp">#endif</span>
<span class="linenos">25</span><span class="w">      </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">26</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">28</span><span class="cp">#endif</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">30</span><span class="w">      </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">31</span><span class="w">      </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">      </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_temp</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">      </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length_out_temp</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">35</span><span class="w">	</span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out_buf</span><span class="p">;</span>
<span class="linenos">36</span><span class="w">	</span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">;</span>
<span class="linenos">37</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">38</span><span class="w">      </span>
<span class="linenos">39</span><span class="w">      </span><span class="c1">// The WITH_GLOBAL_SCOPE macro is required to ensure that the</span>
<span class="linenos">40</span><span class="w">      </span><span class="c1">// comm persists between function calls</span>
<span class="linenos">41</span><span class="w">      </span><span class="n">WITH_GLOBAL_SCOPE</span><span class="p">(</span><span class="n">yggRpc_t</span><span class="w"> </span><span class="n">rpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yggRpcClient</span><span class="p">(</span><span class="s">&quot;server_client&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">));</span>
<span class="linenos">42</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Sending %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">43</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">44</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpcCallRealloc</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos">45</span><span class="w">			       </span><span class="n">out_buf_temp</span><span class="p">,</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="p">);</span>
<span class="linenos">46</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Received %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">47</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">48</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">49</span><span class="w">	</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): RPC CALL ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">50</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">51</span><span class="cp">#pragma omp critical</span>
<span class="linenos">52</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">53</span><span class="cp">#endif</span>
<span class="linenos">54</span><span class="w">	  </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">55</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">56</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">57</span><span class="cp">#endif</span>
<span class="linenos">58</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">59</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">60</span><span class="w">	</span><span class="n">free</span><span class="p">(</span><span class="n">out_temp</span><span class="p">);</span>
<span class="linenos">61</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">62</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">63</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">64</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">65</span><span class="p">}</span>
</pre></div>
</div>
<p>Model YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos">2</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos">3</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="linenos">4</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/server.py</span>
<span class="linenos">5</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos">6</span><span class="w">  </span><span class="nt">is_server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="linenos">7</span><span class="w">  </span><span class="nt">copies</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/client.c</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="nt">client_of</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="nt">compiler_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="nt">linker_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="nt">allow_threading</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">10</span><span class="w">  </span><span class="nt">env</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">    </span><span class="nt">NTHREAD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="linenos">12</span><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">in_buf</span>
<span class="linenos">14</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./Input/input.txt</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">filetype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ascii</span>
<span class="linenos">17</span><span class="w">  </span><span class="nt">outputs</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">out_buf</span>
<span class="linenos">19</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./client_output.txt</span>
<span class="linenos">21</span><span class="w">      </span><span class="nt">in_temp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="r-version">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">R Version</a><a class="headerlink" href="#r-version" title="Permalink to this heading">¶</a></h2>
<p>Model Code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">model_function</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">in_buf</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">2</span>  <span class="n">fprintf</span><span class="p">(</span><span class="s1">&#39;server(R): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">in_buf</span><span class="p">)</span>
<span class="linenos">3</span>  <span class="n">out_buf</span> <span class="o">&lt;-</span> <span class="n">in_buf</span>
<span class="linenos">4</span>  <span class="k">return</span><span class="p">(</span><span class="n">out_buf</span><span class="p">);</span>
<span class="linenos">5</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;YggInterface.h&quot;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">model_function</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">		   </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="c1">// Initialize yggdrasil outside the threaded section</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">ygg_init</span><span class="p">();</span>
<span class="linenos">10</span><span class="w">  </span>
<span class="linenos">11</span><span class="w">  </span><span class="c1">// Get the number of threads from an environment variable set in the yaml</span>
<span class="linenos">12</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nthreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;NTHREAD&quot;</span><span class="p">));</span>
<span class="linenos">13</span><span class="w">  </span>
<span class="linenos">14</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">omp_set_num_threads</span><span class="p">(</span><span class="n">nthreads</span><span class="p">);</span>
<span class="linenos">17</span><span class="cp">#pragma omp parallel for shared(error_code)</span>
<span class="linenos">18</span><span class="cp">#endif</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nthreads</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>
<span class="linenos">21</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">22</span><span class="cp">#pragma omp critical</span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">24</span><span class="cp">#endif</span>
<span class="linenos">25</span><span class="w">      </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">26</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">28</span><span class="cp">#endif</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">30</span><span class="w">      </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">31</span><span class="w">      </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length_out_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">      </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_temp</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">      </span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length_out_temp</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">35</span><span class="w">	</span><span class="n">out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out_buf</span><span class="p">;</span>
<span class="linenos">36</span><span class="w">	</span><span class="n">length_out_buf_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length_out_buf</span><span class="p">;</span>
<span class="linenos">37</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">38</span><span class="w">      </span>
<span class="linenos">39</span><span class="w">      </span><span class="c1">// The WITH_GLOBAL_SCOPE macro is required to ensure that the</span>
<span class="linenos">40</span><span class="w">      </span><span class="c1">// comm persists between function calls</span>
<span class="linenos">41</span><span class="w">      </span><span class="n">WITH_GLOBAL_SCOPE</span><span class="p">(</span><span class="n">yggRpc_t</span><span class="w"> </span><span class="n">rpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yggRpcClient</span><span class="p">(</span><span class="s">&quot;server_client&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">));</span>
<span class="linenos">42</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Sending %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">43</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">44</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpcCallRealloc</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="n">length_in_buf</span><span class="p">,</span>
<span class="linenos">45</span><span class="w">			       </span><span class="n">out_buf_temp</span><span class="p">,</span><span class="w"> </span><span class="n">length_out_buf_temp</span><span class="p">);</span>
<span class="linenos">46</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): Received %s (length = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">47</span><span class="w">	     </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">in_buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">length_in_buf</span><span class="p">));</span>
<span class="linenos">48</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">49</span><span class="w">	</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;client(C:%d): RPC CALL ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">50</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">51</span><span class="cp">#pragma omp critical</span>
<span class="linenos">52</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">53</span><span class="cp">#endif</span>
<span class="linenos">54</span><span class="w">	  </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">55</span><span class="cp">#ifdef _OPENMP</span>
<span class="linenos">56</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">57</span><span class="cp">#endif</span>
<span class="linenos">58</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">59</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">60</span><span class="w">	</span><span class="n">free</span><span class="p">(</span><span class="n">out_temp</span><span class="p">);</span>
<span class="linenos">61</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">62</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">63</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">64</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">error_code</span><span class="p">;</span>
<span class="linenos">65</span><span class="p">}</span>
</pre></div>
</div>
<p>Model YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nn">---</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos">4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos">5</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">R</span>
<span class="linenos">6</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/server.R</span>
<span class="linenos">7</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos">8</span><span class="w">  </span><span class="nt">is_server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">  </span><span class="c1"># Creates a RPC server queue called &quot;server&quot;</span>
<span class="linenos">9</span><span class="w">  </span><span class="nt">copies</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">model</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/client.c</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_function</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="nt">client_of</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="nt">compiler_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="nt">linker_flags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-fopenmp</span><span class="p p-Indicator">]</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="nt">allow_threading</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">10</span><span class="w">  </span><span class="nt">env</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">    </span><span class="nt">NTHREAD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="linenos">12</span><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">in_buf</span>
<span class="linenos">14</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./Input/input.txt</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">filetype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ascii</span>
<span class="linenos">17</span><span class="w">  </span><span class="nt">outputs</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">out_buf</span>
<span class="linenos">19</span><span class="w">    </span><span class="nt">default_file</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./client_output.txt</span>
<span class="linenos">21</span><span class="w">      </span><span class="nt">in_temp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Meagan Lang, David Raila.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>