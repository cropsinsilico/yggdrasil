

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Timestep Synchronization &mdash; yggdrasil v1.6.3+2.g5f7bdedf2.dirty documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="YAML Files" href="yaml.html" />
    <link rel="prev" title="Transformed I/O" href="transformed_io.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> yggdrasil
          

          
          </a>

          
            
            
              <div class="version">
                v1.6.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="includeme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="formatted_io.html">Formatted I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="server_client_io.html">Server/Client I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="autowrap.html">Autowrapping Model Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="autowrap.html#notes-on-autowrapping-c-c-model-functions">Notes on Autowrapping C/C++ Model Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_io.html">Conditional I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="transformed_io.html">Transformed I/O</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Timestep Synchronization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example-using-defaults">Example Using Defaults</a></li>
<li class="toctree-l2"><a class="reference internal" href="#controlling-synchonization">Controlling Synchonization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#synonyms-conversion">Synonyms (Conversion)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#additional-variables">Additional Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interpolation">Interpolation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aggregation">Aggregation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#additional-tips">Additional Tips</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="yaml.html">YAML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_format_strings.html">C-Style Format Strings</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="threading.html">OpenMP Threading in Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/examples_toc.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced/index.html">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="hackathon2018/index.html">Welcome to the 2018 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="hackathon2019/index.html">Welcome to the 2019 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="hackathon2021/index.html">Welcome to the 2021 Crops in Silico Hackathon!</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">yggdrasil</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Timestep Synchronization</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/timesync_io.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="timestep-synchronization">
<span id="timesync-io-rst"></span><h1>Timestep Synchronization<a class="headerlink" href="#timestep-synchronization" title="Permalink to this headline">¶</a></h1>
<p>Many models are time dependent with variables being updated as the time is incremented. When integrating two (or more) models that have timesteps, care must be taken to ensure that variables are correctly synchonized between the models at each timestep. To aid in this process yggdrasil provides a special timestep synchronization interface and model driver. Synchronizations proceeds as follows:</p>
<ol class="arabic simple">
<li><p>A client model <strong>requests</strong> synchronization at a given timestep by calling the synchronization interface with the time of the desired timestep (with units) and any local state variables to the synchronization driver.</p></li>
<li><p>The synchronization driver <strong>converts</strong> synonymous state variables from all models to a base set of state variables.</p></li>
<li><p>The synchronization driver <strong>interpolates</strong> state variables from all models to get values at the time received from the client.</p></li>
<li><p>The synchronization driver <strong>aggregates</strong> state variables across models for the requested time (including interpolated values).</p></li>
<li><p>The synchronization driver <strong>converts</strong> the aggregated base set of state variables to the synonymous state variables used by the client model.</p></li>
<li><p>The synchronization driver <strong>responds</strong> to the client model that issued the request with the resulting state variables.</p></li>
</ol>
<div class="section" id="example-using-defaults">
<h2>Example Using Defaults<a class="headerlink" href="#example-using-defaults" title="Permalink to this headline">¶</a></h2>
<p>In the example below, two model are initialized from the same source code. Both models have two state variables (<code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>) that are calculated as a sine and cosine with periods of 10 days and 5 days respectively; the two models differ only in the size of their timesteps and the units that they use to represent time (the timestep and units for each model are set by input arguments to the model as passed in the yaml).</p>
<p>In the yaml file below, the models are defined as usual, but they also have the <code class="docutils literal notranslate"><span class="pre">timesync</span></code> parameter set to <code class="docutils literal notranslate"><span class="pre">True</span></code>. Setting the <code class="docutils literal notranslate"><span class="pre">timesync</span></code> parameter tells yggdrasil that the model has time dependent variables that need to be synchonized. The <code class="docutils literal notranslate"><span class="pre">timesync</span></code> parameter can also be set to a string that will be used to group models that should be synchronized; in this way, sets of models can be independently synchronized (e.g. if there are unrelated processes that don’t need to be synced). For each unique value of the <code class="docutils literal notranslate"><span class="pre">timesync</span></code> parameter in the provided yamls, yggdrasil sets up a specialized model with that name to handle synchronization between the models with the same <code class="docutils literal notranslate"><span class="pre">timesync</span></code> parameter value (setting <code class="docutils literal notranslate"><span class="pre">timesync</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> creates a specialized timestep synchronization model with the name <code class="docutils literal notranslate"><span class="pre">timesync</span></code>).</p>
<p>Model YAML:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="nt">models</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">modelA</span>
    <span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./src/timesync.py</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">7</span>  <span class="c1"># Pass the timestep in hours</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hr</span>
    <span class="nt">timesync</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
    <span class="nt">outputs</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">output</span>
      <span class="nt">default_file</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">modelA_output.txt</span>
        <span class="nt">in_temp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
        <span class="nt">filetype</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">table</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">modelB</span>
    <span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./src/timesync.py</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>  <span class="c1"># Pass the timestep in days</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">day</span>
    <span class="nt">timesync</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
    <span class="nt">outputs</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">output</span>
      <span class="nt">default_file</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">modelB_output.txt</span>
        <span class="nt">in_temp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
        <span class="nt">filetype</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">table</span>
</pre></div>
</td></tr></table></div>
<p>(<a class="reference external" href="examples/timesync1.html">Example in other languages</a>)</p>
<p>In addition to the yaml parameter, models performing timestep synchronization will need to make use of the timestep synchronization interface. In Python, this is <code class="docutils literal notranslate"><span class="pre">YggTimesync</span></code>. At each timestep (including the initial time), the model executes the <code class="docutils literal notranslate"><span class="pre">call</span></code> method for the timestep synchronization interface. The output variable (the variable being sent as a request by the <code class="docutils literal notranslate"><span class="pre">call</span></code> method) is excepted to be the time of the timestep and a mapping type between state varaible names and their values at the timestep. The return variable (the variable received in response by the <code class="docutils literal notranslate"><span class="pre">call</span></code> method) will be a mapping type between state variable names and their values that have been updated with information from the other models.</p>
<p>Model Code:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">yggdrasil</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">yggdrasil.interface.YggInterface</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">YggTimesync</span><span class="p">,</span> <span class="n">YggOutput</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">timestep_calc</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Updates the state based on the time where x is a sine wave</span>
<span class="sd">    with period of 10 days and y is a cosine wave with a period of 5 days.</span>

<span class="sd">    Args:</span>
<span class="sd">        t (float): Current time.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Map of state parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">add_units</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">)),</span>
        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">add_units</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">))}</span>
    <span class="k">return</span> <span class="n">state</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">t_step</span><span class="p">,</span> <span class="n">t_units</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function to execute integration.</span>

<span class="sd">    Args:</span>
<span class="sd">        t_step (float): The time step that should be used.</span>
<span class="sd">        t_units (str): Units of the time step.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Hello from Python timesync: timestep = </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t_step</span><span class="p">,</span> <span class="n">t_units</span><span class="p">))</span>
    <span class="n">t_step</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">add_units</span><span class="p">(</span><span class="n">t_step</span><span class="p">,</span> <span class="n">t_units</span><span class="p">)</span>
    <span class="n">t_start</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">add_units</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">t_units</span><span class="p">)</span>
    <span class="n">t_end</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">add_units</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">timestep_calc</span><span class="p">(</span><span class="n">t_start</span><span class="p">)</span>

    <span class="c1"># Set up connections matching yaml</span>
    <span class="c1"># Timestep synchonization connection will default to &#39;timesync&#39;</span>
    <span class="n">timesync</span> <span class="o">=</span> <span class="n">YggTimesync</span><span class="p">(</span><span class="s1">&#39;timesync&#39;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">YggOutput</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize state and synchronize with other models</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t_start</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">timesync</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;timesync(Python): Initial sync failed.&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;timesync(Python): t = </span><span class="si">% 8s</span><span class="s1">, x = </span><span class="si">%+ 5.2f</span><span class="s1">, y = </span><span class="si">%+ 5.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span>

    <span class="c1"># Send initial state to output</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;timesync(Python): Failed to send &quot;</span>
                           <span class="s2">&quot;initial output for t=</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
    
    <span class="c1"># Iterate until end</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">:</span>

        <span class="c1"># Perform calculations to update the state</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">t_step</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">timestep_calc</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Synchronize the state</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">timesync</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;timesync(Python): sync for t=</span><span class="si">%f</span><span class="s2"> failed.&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;timesync(Python): t = </span><span class="si">% 8s</span><span class="s1">, x = </span><span class="si">%+ 5.2f</span><span class="s1">, y = </span><span class="si">%+ 5.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span>

        <span class="c1"># Send output</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;timesync(Python): Failed to send output for t=</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Goodbye from Python timesync&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Take time step from the first argument</span>
    <span class="n">main</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
<p>(<a class="reference external" href="examples/timesync1.html">Example in other languages</a>)</p>
<p>Below is the result of the synchronization between the two models. The states variable <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are shown in blue and red respectively, solid lines show results for model A, dashed lines show results for model B, and the True values for <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are plotted in black.</p>
<img alt="_images/timesync1_result.png" src="_images/timesync1_result.png" />
<p>Model B has a larger timestep than model A so values for model B are interpolated to get values at the timesteps for model A. The default interpolation method assumes a linear relationship between values and the default aggregation method averages across all models; as a result, the values for the model with the smaller timestep (model A) end up being pulled away from the “True” value when aggregated with the interpolated with the values from the model with the larger timestep (model B). There are ways to control how timesteps are synchronized (as discussed below), but in practice, integrating two models of the same process with the same degree of accuracy that use different timesteps is unlikely to be useful.</p>
</div>
<div class="section" id="controlling-synchonization">
<h2>Controlling Synchonization<a class="headerlink" href="#controlling-synchonization" title="Permalink to this headline">¶</a></h2>
<p>There are several ways to customize how timesteps are merged between models. In order to set these options, an explicit entry must be added to the yaml for the timestep synchronization model. At a minimum the timestep synchronization model yaml entry should have <code class="docutils literal notranslate"><span class="pre">language:</span> <span class="pre">timesync</span></code> and it’s name should be the same as the <code class="docutils literal notranslate"><span class="pre">timesync</span></code> parameter value for the models it will synchronize (<code class="docutils literal notranslate"><span class="pre">'timesync'</span></code> if the models have <code class="docutils literal notranslate"><span class="pre">timesync:</span> <span class="pre">True</span></code>). Additional parameters in the timestep synchronization model yaml entry will be used to control how timesteps are synchronized.</p>
<p>In the example below, these parameters are used to modify how the state variables are synchronized. Models A and B are identical except:</p>
<ul class="simple">
<li><p>Model A has state variables <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> while Model B has state variables <code class="docutils literal notranslate"><span class="pre">xvar</span></code> and <code class="docutils literal notranslate"><span class="pre">yvar</span></code> (set in the yaml)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xvar</span></code> in Model B is equal to half of <code class="docutils literal notranslate"><span class="pre">x</span></code> in Model A</p></li>
<li><p>Model A has state variables <code class="docutils literal notranslate"><span class="pre">z1</span></code> and <code class="docutils literal notranslate"><span class="pre">z2</span></code> which can be used to calculate <code class="docutils literal notranslate"><span class="pre">z</span></code>, a state variable calculated directly by Model B.</p></li>
<li><p>Model A alone calculates state variable <code class="docutils literal notranslate"><span class="pre">a</span></code>, while model B alone calculates state variable <code class="docutils literal notranslate"><span class="pre">b</span></code>. The models need to exchange these variables.</p></li>
</ul>
<p>Model YAML:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="nt">models</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">statesync</span>
    <span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">timesync</span>
    <span class="nt">synonyms</span><span class="p">:</span>
      <span class="nt">modelB</span><span class="p">:</span>
        <span class="nt">x</span><span class="p">:</span>
          <span class="nt">alt</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">xvar</span>
          <span class="nt">alt2base</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./src/timesync.py:xvar2x</span>
          <span class="nt">base2alt</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./src/timesync.py:x2xvar</span>
        <span class="nt">y</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yvar</span>
      <span class="nt">modelA</span><span class="p">:</span>
        <span class="nt">z</span><span class="p">:</span>
          <span class="nt">alt</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">z1</span><span class="p p-Indicator">,</span> <span class="nv">z2</span><span class="p p-Indicator">]</span>
          <span class="nt">alt2base</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./src/timesync.py:merge_z</span>
          <span class="nt">base2alt</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./src/timesync.py:split_z</span>
    <span class="nt">interpolation</span><span class="p">:</span>
      <span class="nt">modelA</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">krogh</span>
      <span class="nt">modelB</span><span class="p">:</span>
        <span class="nt">method</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">spline</span>
        <span class="nt">order</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
    <span class="nt">aggregation</span><span class="p">:</span>
      <span class="nt">x</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./src/timesync.py:xagg</span>
      <span class="nt">y</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sum</span>
    <span class="nt">additional_variables</span><span class="p">:</span>
      <span class="nt">modelA</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">b</span><span class="p p-Indicator">]</span>
      <span class="nt">modelB</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">a</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">modelA</span>
    <span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./src/timesync.py</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">7</span>  <span class="c1"># Pass the timestep in hours</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hr</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">A</span>
    <span class="nt">timesync</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">statesync</span>
    <span class="nt">outputs</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">output</span>
      <span class="nt">default_file</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">modelA_output.txt</span>
        <span class="nt">in_temp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
        <span class="nt">filetype</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">table</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">modelB</span>
    <span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./src/timesync.py</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>  <span class="c1"># Pass the timestep in days</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">day</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B</span>
    <span class="nt">timesync</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">statesync</span>
    <span class="nt">outputs</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">output</span>
      <span class="nt">default_file</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">modelB_output.txt</span>
        <span class="nt">in_temp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
        <span class="nt">filetype</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">table</span>
</pre></div>
</td></tr></table></div>
<p>(<a class="reference external" href="examples/timesync2.html">Example in other languages</a>)</p>
<img alt="_images/timesync2_result.png" src="_images/timesync2_result.png" />
<p>(The source code associated with this model is very similar to the souce code above, but can be found <a class="reference external" href="examples/timesync2.html">here</a> for reference.)</p>
<div class="section" id="synonyms-conversion">
<h3>Synonyms (Conversion)<a class="headerlink" href="#synonyms-conversion" title="Permalink to this headline">¶</a></h3>
<p>It is unlikely that variables will match perfectly between models, beit in name or definition. For example, in the model defined above, model A and B use different names to describe the same variable (<code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">yvar</span></code> respectively). Similarly the variables <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">xvar</span></code> used by models A and B respectively are analagous, but <code class="docutils literal notranslate"><span class="pre">xvar</span></code> is defined slightly differently (namely <code class="docutils literal notranslate"><span class="pre">xvar=x/2</span></code>).</p>
<p>To handle reconcilation between analagous variables, yggdrasil allows users to define relationships between variables in different models using the <code class="docutils literal notranslate"><span class="pre">synonyms</span></code> parameter. The value for the <code class="docutils literal notranslate"><span class="pre">synonyms</span></code> parameter should be a mapping between model names and mapping from base variable names (these should be variables named by one or more models) and the analogous variable that the model uses. If the model just uses a different name for the same concept as the base, this can be just a string (e.g. the <code class="docutils literal notranslate"><span class="pre">synonyms</span></code> entry for <code class="docutils literal notranslate"><span class="pre">y</span></code> in <code class="docutils literal notranslate"><span class="pre">modelB</span></code> above). If additional calculations are required to convert between the variables used in the models, a mapping can be provided (e.g. the <code class="docutils literal notranslate"><span class="pre">synonyms</span></code> entry for <code class="docutils literal notranslate"><span class="pre">x</span></code> in <code class="docutils literal notranslate"><span class="pre">modelB</span></code>). In addition, calculation mapping from one model to another can also involve more than one variable (e.g. the <code class="docutils literal notranslate"><span class="pre">synonyms</span></code> entry for <code class="docutils literal notranslate"><span class="pre">z</span></code> in <code class="docutils literal notranslate"><span class="pre">modelA</span></code>). The keys in the entry should be:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alt</span></code>: One or more state variables used by the model to calculate the base state variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alt2base</span></code>: Function for converting from the state variable(s) used by the model to the base variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">base2alt</span></code>: Function for converting from the base variable to the state variable(s) used by the model.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Units conversions will be handled by yggdrasil and do not need to be addressed by the <code class="docutils literal notranslate"><span class="pre">synonyms</span></code> parameters so long as the state variables have units when passed to the timestep synchronization interface <code class="docutils literal notranslate"><span class="pre">call</span></code> method.</p>
</div>
</div>
<div class="section" id="additional-variables">
<h3>Additional Variables<a class="headerlink" href="#additional-variables" title="Permalink to this headline">¶</a></h3>
<p>Models can also request state variables from other models that they do not calculate themselves via the <code class="docutils literal notranslate"><span class="pre">additional_variables</span></code> parameter in the yaml. The value for this parameter should be a mapping from model name to a list of external variables that should be returned to the model. For example, in the above yaml, model A requests state variable <code class="docutils literal notranslate"><span class="pre">b</span></code> from model B and model B requests state variable <code class="docutils literal notranslate"><span class="pre">a</span></code> from model A.</p>
</div>
<div class="section" id="interpolation">
<h3>Interpolation<a class="headerlink" href="#interpolation" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">interpolation</span></code> parameter controls how data is obtained for timesteps that are not sampled by the model. This is particularly important for models that have very different timesteps. Values for the <code class="docutils literal notranslate"><span class="pre">interpolation</span></code> parameter can be strings specifying the method that should be used to interpolate or mapping of keyword arguments to <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.interpolate.html">pandas.DataFrame.interpolate</a>. A single <code class="docutils literal notranslate"><span class="pre">interpolation</span></code> parameter can be used for all models or specialed <code class="docutils literal notranslate"><span class="pre">interpolation</span></code> parameters can be specified a model-by-model basis using a mapping as in the example above. Interpolation is done on the data from each model independently after applying the transformations described by the <code class="docutils literal notranslate"><span class="pre">synonyms</span></code> parameter.</p>
</div>
<div class="section" id="aggregation">
<h3>Aggregation<a class="headerlink" href="#aggregation" title="Permalink to this headline">¶</a></h3>
<p>After the model data is interpolated to get missing timesteps, the data samples at each timestep are aggregated. By default, the samples from each model are averaged, but there are many ways to aggregate data. In the example above, the data for the <code class="docutils literal notranslate"><span class="pre">x</span></code> variable are aggregated using a function <code class="docutils literal notranslate"><span class="pre">xagg</span></code> from the <code class="docutils literal notranslate"><span class="pre">./src/timesync.py</span></code> file which always returns the largest absolute value. The data for the <code class="docutils literal notranslate"><span class="pre">y</span></code> variable are aggregated by summing as would be the case when two models represent separate processes that modify a cumulative variable (e.g. mass added/subtracted by different processes).</p>
</div>
<div class="section" id="additional-tips">
<h3>Additional Tips<a class="headerlink" href="#additional-tips" title="Permalink to this headline">¶</a></h3>
<p>In addition to dictionaries mapping from variable to method, a single value can be provided for the <code class="docutils literal notranslate"><span class="pre">aggregation</span></code> and <code class="docutils literal notranslate"><span class="pre">interpolation</span></code> parameter; the same method will the be used for all of the variables e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">statesync</span>
  <span class="n">language</span><span class="p">:</span> <span class="n">timesync</span>
  <span class="n">synonyms</span><span class="p">:</span>
    <span class="n">modelB</span><span class="p">:</span>
      <span class="n">x</span><span class="p">:</span>
        <span class="n">alt</span><span class="p">:</span> <span class="n">xvar</span>
        <span class="n">alt2base</span><span class="p">:</span> <span class="o">./</span><span class="n">src</span><span class="o">/</span><span class="n">timesync</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="n">xvar2x</span>
        <span class="n">base2alt</span><span class="p">:</span> <span class="o">./</span><span class="n">src</span><span class="o">/</span><span class="n">timesync</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="n">x2xvar</span>
      <span class="n">y</span><span class="p">:</span> <span class="n">yvar</span>
  <span class="n">interpolation</span><span class="p">:</span> <span class="n">nearest</span>
  <span class="n">aggregation</span><span class="p">:</span> <span class="nb">min</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since each synchronization call invokes overhead, it is not advised that the <code class="docutils literal notranslate"><span class="pre">call</span></code> method be executed inside integration methods. Instead, synchonization <code class="docutils literal notranslate"><span class="pre">call</span></code> methods should be executed at larger timesteps.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="yaml.html" class="btn btn-neutral float-right" title="YAML Files" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="transformed_io.html" class="btn btn-neutral float-left" title="Transformed I/O" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, Meagan Lang, David Raila.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>