<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding Support for a New Language &mdash; yggdrasil v1.9.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="TODO" href="todo.html" />
    <link rel="prev" title="Release Steps" href="release.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            yggdrasil
          </a>
              <div class="version">
                v1.9.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../includeme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../formatted_io.html">Formatted I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server_client_io.html">Server/Client I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autowrap.html">Autowrapping Model Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conditional_io.html">Conditional I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transformed_io.html">Transformed I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timesync_io.html">Timestep Synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../yaml.html">YAML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Command Line Interface (CLI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc.html">High Performance Computing (HPC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote.html">Running Integrations as Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker.html">Docker Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../c_format_strings.html">C-Style Format Strings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../threading.html">OpenMP Threading in Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/examples_toc.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html">Advanced</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="general.html">General Development Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="release.html">Release Steps</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Adding Support for a New Language</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#write-the-language-driver">Write the Language Driver</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#interpreted-languages">Interpreted Languages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compiled-languages">Compiled Languages</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#write-the-language-communication-interface">Write the Language Communication Interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#from-an-interface-in-a-supported-language-recommnded">From an Interface in a Supported Language (Recommnded)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#from-scratch">From Scratch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#installation-script-optional">Installation Script [OPTIONAL]</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="todo.html">TODO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hackathon2018/index.html">Welcome to the 2018 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hackathon2019/index.html">Welcome to the 2019 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hackathon2021/index.html">Welcome to the 2021 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">yggdrasil</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Development</a></li>
      <li class="breadcrumb-item active">Adding Support for a New Language</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/development/new_language.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="adding-support-for-a-new-language">
<h1>Adding Support for a New Language<a class="headerlink" href="#adding-support-for-a-new-language" title="Permalink to this heading">¶</a></h1>
<p>The yggdrasil package has been redesigned to make adding support for a new language
as easy as possible, but developers will need some Python programming knowledge and
a descent familiarity with the language being added.</p>
<section id="write-the-language-driver">
<h2>Write the Language Driver<a class="headerlink" href="#write-the-language-driver" title="Permalink to this heading">¶</a></h2>
<p>The first step in adding language support is to write a driver for the language.
Model drivers take care of things like writting any necessary wrappers, compiling
the code (if necessary), and running the code. Generally, new languages will fall
into one of two categories, interpreted or compiled. Based on the category that
the language falls under, developers should use the associated base class
(<a class="reference internal" href="../yggdrasil.drivers.html#yggdrasil.drivers.InterpretedModelDriver.InterpretedModelDriver" title="yggdrasil.drivers.InterpretedModelDriver.InterpretedModelDriver"><code class="xref py py-class docutils literal notranslate"><span class="pre">yggdrasil.drivers.InterpretedModelDriver.InterpretedModelDriver</span></code></a> or
<a class="reference internal" href="../yggdrasil.drivers.html#yggdrasil.drivers.CompiledModelDriver.CompiledModelDriver" title="yggdrasil.drivers.CompiledModelDriver.CompiledModelDriver"><code class="xref py py-class docutils literal notranslate"><span class="pre">yggdrasil.drivers.CompiledModelDriver.CompiledModelDriver</span></code></a>) as a parent class.
These base classes parameterize the required model driver operations so that
developers should not have to write a large amount of code.</p>
<p>In addition to the type specific steps below, developers can control the behavior of
their class by defining the following class attributes:</p>
<p>and the class method <code class="docutils literal notranslate"><span class="pre">is_library_installed</span></code>, which is used to determine if
dependencies are installed.</p>
<p>Model drivers should go in the <code class="docutils literal notranslate"><span class="pre">yggdrasil/drivers</span></code> directory and tests should
go in the <code class="docutils literal notranslate"><span class="pre">yggdrasil/drivers/tests</span></code> directory.</p>
<section id="interpreted-languages">
<h3>Interpreted Languages<a class="headerlink" href="#interpreted-languages" title="Permalink to this heading">¶</a></h3>
<p>Additional class attributes specific to interpreted model drivers include:</p>
</section>
<section id="compiled-languages">
<h3>Compiled Languages<a class="headerlink" href="#compiled-languages" title="Permalink to this heading">¶</a></h3>
<p>Additional class attributes specific to compiled model drivers include:</p>
<section id="compilation-tools">
<h4>Compilation Tools<a class="headerlink" href="#compilation-tools" title="Permalink to this heading">¶</a></h4>
<p>For compiled languages, yggdrasil allows multiple compilation tools to be defined for
the same language, particularly when different tools are required on different
operating systems. In these cases, developers should create classes for the
compilation tools (i.e. compilers, linkers, archivers) associated with the language.
yggdrasil defines several base classes for this purpose which should be used
as parent classes for any new tools.</p>
<p>For compilers, the class is <a class="reference internal" href="../yggdrasil.drivers.html#yggdrasil.drivers.CompiledModelDriver.CompilerBase" title="yggdrasil.drivers.CompiledModelDriver.CompilerBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">yggdrasil.drivers.CompiledModelDriver.CompilerBase</span></code></a>.
The behavior of the compiler is defined by these class attributes:</p>
<p>Most compilers, also serve as linkers so it is unlikely that developers will
need to define new linkers (outside of the linker related compiler class attributes
above), but there is also a linker base class if developers need finer tuned access
to the class’s behavior. For linkers, the class is
<a class="reference internal" href="../yggdrasil.drivers.html#yggdrasil.drivers.CompiledModelDriver.LinkerBase" title="yggdrasil.drivers.CompiledModelDriver.LinkerBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">yggdrasil.drivers.CompiledModelDriver.LinkerBase</span></code></a> adn the behavior of the
linker is defined by these class attributes:</p>
<p>Many archivers can be used for multiple languages so check the other languages
before adding a new one. If the target archiver already exists for other languages,
developers should add the new language to the accepted list of languages on the
class associated with the archiver. For archivers, the base class is
<a class="reference internal" href="../yggdrasil.drivers.html#yggdrasil.drivers.CompiledModelDriver.ArchiverBase" title="yggdrasil.drivers.CompiledModelDriver.ArchiverBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">yggdrasil.drivers.CompiledModelDriver.ArchiverBase</span></code></a>.
The behavior of the archiver is defined by these class attributes:</p>
</section>
</section>
</section>
<section id="write-the-language-communication-interface">
<h2>Write the Language Communication Interface<a class="headerlink" href="#write-the-language-communication-interface" title="Permalink to this heading">¶</a></h2>
<p>The second phase of adding support for a new language is to write the language
interface. This step is more involved than writing the model driver for the
language, but the majority of the required development will be in the language
being added. Tools required for language support that are not meant to be
accessed via the yggdrasil Python package (e.g. the language interface or
conversion functions) should go in specific language directory under
<cite>yggdrasil/languages</cite> with a name identifying the languagye
(e.g. <cite>yggdrasil/languages/MATLAB</cite> for the MATLAB interface contains conversion
functions and the interface classes/functions written in MATLAB).</p>
<p>For new languages, developers should first do a review to
identify existing tools for calling code in one of the languages that yggdrasil
already supports (e.g. the R interface uses the
<a class="reference external" href="https://rstudio.github.io/reticulate/">reticulate</a> package to
call the Python interface from R). If such a tool exists, then the developers task is
must easier.</p>
<section id="from-an-interface-in-a-supported-language-recommnded">
<h3>From an Interface in a Supported Language (Recommnded)<a class="headerlink" href="#from-an-interface-in-a-supported-language-recommnded" title="Permalink to this heading">¶</a></h3>
<p>If there is an existing tool for accessing code written in one of the supporting
languages, the developer will use that tool to wrap the interface from the already
supported language. Examples of this can be found in the Matlab and R interface
which both wrap the Python interface. The wrapper interface must have, at minimum:</p>
<ol class="arabic simple">
<li><p><em>Functions/Classes for creating communicator objects.</em> The created functions/classes
should take as input a channel name (and optional format string for creating
communicator objects for output), calls the wrapped interface, and
returns the class/object representing the communicator in a form that can be used
in the language being added. For object oriented languages, it may be easiest
to create a new class that wraps access to the object returned by the wrapped
interface. There must be a way to distinguish from input and output communicators
either by exposing separate functions/classes or via an explicit argument.</p></li>
<li><p><em>Functions/Methods for calling the wrapped send/recv functions/methods.</em> The
created functions/classes must be able to access the wrapped communicator class
or data object and call the appropriate send/recv function or method, converting
the inputs and outputs of these functions into forms that make sense for the
language being added (See next point).</p></li>
<li><p><em>Conversion functions/methods.</em> While tools for calling external programming
languages often handle most of the type conversion necessary for the two
languages to interact, these conversions are often incomplete or insufficient
for the purposes of yggdrasil (e.g. R does not have built-in support for
variable precision integers and float). In such cases, the developer adding the
language may need to write a conversion function that handles these
inconsistencies.</p></li>
</ol>
</section>
<section id="from-scratch">
<h3>From Scratch<a class="headerlink" href="#from-scratch" title="Permalink to this heading">¶</a></h3>
<section id="create-comm-class-object">
<h4>Create “Comm” Class/Object<a class="headerlink" href="#create-comm-class-object" title="Permalink to this heading">¶</a></h4>
<p>For a language to added,
there must be an interface to at least one of the supported communication
mechanisms. Because it is widely supported in different programming languages,
we recommend adding a ZeroMQ communication interface as a starting point. The
new interface will need to defined a class or data object that wraps access to
the underlying communication mechanism (e.g. ZeroMQ).</p>
<p>This includes creating
the communication connection based on a channel name. yggdrasil will store
information about the communication associated with the connection in an
environment variable with the name <code class="docutils literal notranslate"><span class="pre">'&lt;channel_name&gt;_IN'</span></code> if the channel
is providing input to the model and <code class="docutils literal notranslate"><span class="pre">'&lt;channel_name&gt;_OUT'</span></code> if the channel is
handling output from the model. The exact content of the environment variable
depends on the communication mechanisms as shown in the table below.</p>
</section>
<section id="required-methods-functions">
<h4>Required Methods/Functions<a class="headerlink" href="#required-methods-functions" title="Permalink to this heading">¶</a></h4>
<p>The interface must also provide methods/functions for accesing the underlying
communication class’s methods for sending and receiving messages. This is
usually straight forward (assuming serialization is implemented), but there
are some communication mechanisms with require some additional features (e.g.
ZeroMQ). The table below includes some notes on implementing each of the
supported communication mechanisms.</p>
<table class="docutils align-default" id="comm-devnotes-table-rst">
<thead>
<tr class="row-odd"><th class="head"><p>Comm</p></th>
<th class="head"><p>Address</p></th>
<th class="head"><p>Developer Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>buffer</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>ipc</p></td>
<td><p>An IPC message queue key.</p></td>
<td><p>The default size limit for IPC message queues is 2048 bytes on Mac operating
systems so it is important that implementation of this communication mechanism
properly split and send messages larger than this limit as more than one
message.</p></td>
</tr>
<tr class="row-even"><td><p>mpi</p></td>
<td><p>The partner communicator ID(s).</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>rest</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>rmq</p></td>
<td><p>AMPQ queue address of the form <code class="docutils literal notranslate"><span class="pre">&lt;url&gt;_R</span>
<span class="pre">MQPARAM_&lt;exchange&gt;_RMQPARAM_&lt;queue&gt;</span></code>
where <code class="docutils literal notranslate"><span class="pre">url</span></code> is the broker address (see
explanation <a class="reference external" href="https://pika.readthedocs.io/en/stable/examples/using_urlparameters.html">here</a>), <code class="docutils literal notranslate"><span class="pre">exchange</span></code> is the name
of the exchange on the queue that should
be used, and <code class="docutils literal notranslate"><span class="pre">queue</span></code> is the name of
the queue.</p></td>
<td><p>It is not advised that new language implement a RabbitMQ communication
interface. Rather RMQ communication is included explicitly for connections
between models that are not co-located on the same machine and are used by the
yggdrasil framework connections on the Python side.</p></td>
</tr>
<tr class="row-odd"><td><p>value</p></td>
<td></td>
<td><p>[]</p></td>
</tr>
<tr class="row-even"><td><p>zmq</p></td>
<td><p>A ZeroMQ endpoint of the form
&lt;transport&gt;://&lt;address&gt;, where the
format of address depends on the
transport. Additional information can be
found <a class="reference external" href="http://api.zeromq.org/3-2:zmq-bind">here</a>.</p></td>
<td><p>yggdrasil uses the tcp transport by default with a PAIR socket type. For every
connection, yggdrasil establishes a second request/reply connection that is
used to confirm messages passed between the primary PAIR of sockets. On the
first send, the model should create a REP socket on an open tcp address and send
that address in the header of the first message under the key ‘zmq_reply’.
Receiving models should check message headers for this key and, on receipt,
establish the partner REQ socket with the specified address (receiving comms can
receive from more than one source so they can have more than one request
addresses at at time for this purpose). Following every message, the sending
model should wait for a message on the reply socket and, on receipt, return the
message. Following every message, the receiving model should send the message
‘YGG_REPLY’ on the request socket and wait for a reply. When creating worker
comms for sending large messages, the sending model should create the reply comm
for the worker in advanced and send it in the header with the worker address
under the key ‘zmq_reply_worker’.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="implement-serialization">
<h4>Implement Serialization<a class="headerlink" href="#implement-serialization" title="Permalink to this heading">¶</a></h4>
<p>The most involved part of writing the interface will be writing the
serialization and deserialization routines. The specific serialization protocol
used by yggdrasil is described in detail here <a class="reference internal" href="../advanced/serialization.html#serialization-rst"><span class="std std-ref">here</span></a>.
The developer adding support for the new language will need to add support for
serialization of all of the datatypes listed in
<a class="reference internal" href="../tables/datatype_mapping_table.html#datatype-mapping-table-rst"><span class="std std-ref">this table</span></a>.</p>
</section>
<section id="sending-large-messages">
<h4>Sending Large Messages<a class="headerlink" href="#sending-large-messages" title="Permalink to this heading">¶</a></h4>
<p>Most communication mechanisms have limits on the sizes of messages that can be
sent as single messages (e.g. 2048 for IPC on MacOS). To overcome this yggdrasil
splits up serialized messages that are larger than the limit (including the
serialized header) into smaller messages and sending them through a new
connection created explicitly for carrying the large message.</p>
<p>When a model is sending to output, it should check the size of each outgoing message
(including the header). If a message exceeds the limit, it should</p>
<ol class="arabic simple">
<li><p>Create a new work comm and add the work comm’s address to the message header
under the ‘address’ key.</p></li>
<li><p>Send the revised header with as much of the message as will fit within the limit.</p></li>
<li><p>Send the remains of the message as chunks with sizes set by the limit
through the new work comm.</p></li>
</ol>
<p>When a model is receiving, it should check that the message is not smaller than
the size indicated by the header. If the message is smaller, it should</p>
<ol class="arabic simple">
<li><p>Create a new work comm using the address in the message header.</p></li>
<li><p>Continue receiving messages through the work comm until the message is
complete (or the connection is closed).</p></li>
<li><p>Combine the received message chunks to form the complete messages and
deserialize them.</p></li>
</ol>
<p>When creating an interface in a new language, the developer must replicate this
behavior.</p>
</section>
</section>
</section>
<section id="installation-script-optional">
<h2>Installation Script [OPTIONAL]<a class="headerlink" href="#installation-script-optional" title="Permalink to this heading">¶</a></h2>
<p>If there are additional steps that should be taken during the installation of
yggdrasil to allow a language to be supported (e.g. installing dependencies
that are not covered by a Python package manager), developers can add these
to a script called <code class="docutils literal notranslate"><span class="pre">install.py</span></code> in the directory they create for their language
under <code class="docutils literal notranslate"><span class="pre">yggdrasil/languages</span></code>. This file should, at minimum, include a function
called <code class="docutils literal notranslate"><span class="pre">install</span></code> that dosn’t require any input and returns a boolean indicating
the success or failuer of the additional installation steps. This function can
also be used to check for the existance of dependencies so that a warning is
printed during install to advise the user. In addition to the <code class="docutils literal notranslate"><span class="pre">install</span></code> function
developer can also set a <code class="docutils literal notranslate"><span class="pre">name_in_pragmas</span></code> variable. This should be a string
that is used to set coverage pragmas that will be ignored during coverage if
a language will not be set. (e.g. lines marked by <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">pragma:</span> <span class="pre">matlab</span></code> are
not covered if MATLAB is not supported while lines marked with <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">pragma:</span> <span class="pre">no</span> <span class="pre">matlab</span></code>
are not covered if MATLAB is installed). If not set, the lower case version of
the language directory name is assumed for the pragmas. This does not change the
behavior of the code, only how the coverage report is generated.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="release.html" class="btn btn-neutral float-left" title="Release Steps" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="todo.html" class="btn btn-neutral float-right" title="TODO" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Meagan Lang, David Raila.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>