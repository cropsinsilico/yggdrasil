

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>yggdrasil.drivers.ModelDriver &mdash; yggdrasil v1.7.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> yggdrasil
          

          
          </a>

          
            
            
              <div class="version">
                v1.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../includeme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../formatted_io.html">Formatted I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server_client_io.html">Server/Client I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autowrap.html">Autowrapping Model Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conditional_io.html">Conditional I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transformed_io.html">Transformed I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../timesync_io.html">Timestep Synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yaml.html">YAML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc.html">High Performance Computing (HPC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../c_format_strings.html">C-Style Format Strings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../threading.html">OpenMP Threading in Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/examples_toc.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced/index.html">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hackathon2018/index.html">Welcome to the 2018 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hackathon2019/index.html">Welcome to the 2019 Crops in Silico Hackathon!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hackathon2021/index.html">Welcome to the 2021 Crops in Silico Hackathon!</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">yggdrasil</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../drivers.html">yggdrasil.drivers</a> &raquo;</li>
        
      <li>yggdrasil.drivers.ModelDriver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for yggdrasil.drivers.ModelDriver</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">yggdrasil</span> <span class="kn">import</span> <span class="n">platform</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">languages</span><span class="p">,</span> <span class="n">multitasking</span>
<span class="kn">from</span> <span class="nn">yggdrasil.components</span> <span class="kn">import</span> <span class="n">import_component</span><span class="p">,</span> <span class="n">import_all_components</span>
<span class="kn">from</span> <span class="nn">yggdrasil.drivers.Driver</span> <span class="kn">import</span> <span class="n">Driver</span>
<span class="kn">from</span> <span class="nn">yggdrasil.metaschema.datatypes</span> <span class="kn">import</span> <span class="n">is_default_typedef</span>
<span class="kn">from</span> <span class="nn">yggdrasil.metaschema.properties.ScalarMetaschemaProperties</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_valid_types</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">_map_language_ext</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>


<div class="viewcode-block" id="remove_product"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.remove_product">[docs]</a><span class="k">def</span> <span class="nf">remove_product</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">check_for_source</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Delete a single product after checking that the product is not (or</span>
<span class="sd">    does not contain, in the case of directories), source files.</span>

<span class="sd">    Args:</span>
<span class="sd">        product (str): Full path to a file or directory that should be</span>
<span class="sd">            removed.</span>
<span class="sd">        check_for_source (bool, optional): If True, the specified product</span>
<span class="sd">            will be checked to ensure that no source files are present. If</span>
<span class="sd">            a source file is present, a RuntimeError will be raised.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        **kwargs: Additional keyword arguments are passed to tools.remove_path.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If the specified product is a source file and</span>
<span class="sd">            check_for_source is False.</span>
<span class="sd">        RuntimeError: If the specified product is a directory that contains</span>
<span class="sd">            a source file and check_for_source is False.</span>
<span class="sd">        RuntimeError: If the product cannot be removed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">import_all_components</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="n">source_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_map_language_ext</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="s1">&#39;.exe&#39;</span> <span class="ow">in</span> <span class="n">source_keys</span><span class="p">:</span>  <span class="c1"># pragma: windows</span>
        <span class="n">source_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;.exe&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check_for_source</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">product</span><span class="p">):</span>
            <span class="n">ext_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">source_keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">product</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext_tuple</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> contains a source file &quot;</span>
                                            <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">product</span><span class="p">):</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">product</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">source_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is a source file.&quot;</span> <span class="o">%</span> <span class="n">product</span><span class="p">)</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">remove_path</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="remove_products"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.remove_products">[docs]</a><span class="k">def</span> <span class="nf">remove_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">source_products</span><span class="p">,</span> <span class="n">timer_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Delete products produced during the process of running the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        products (list): List of products that should be removed after</span>
<span class="sd">            checking that they are not source files.</span>
<span class="sd">        source_products (list): List of products that should be removed</span>
<span class="sd">            without checking that they are not source files.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">source_products</span><span class="p">:</span>
        <span class="n">remove_product</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">timer_class</span><span class="o">=</span><span class="n">timer_class</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
        <span class="n">remove_product</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">timer_class</span><span class="o">=</span><span class="n">timer_class</span><span class="p">,</span> <span class="n">check_for_source</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="ModelDriver"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver">[docs]</a><span class="k">class</span> <span class="nc">ModelDriver</span><span class="p">(</span><span class="n">Driver</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Base class for Model drivers and for running executable based models.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): Unique name used to identify the model. This will</span>
<span class="sd">            be used to report errors associated with the model.</span>
<span class="sd">        args (str or list): The full path to the file containing the</span>
<span class="sd">            model program that will be run by the driver or a list</span>
<span class="sd">            starting with the program file and including any arguments</span>
<span class="sd">            that should be passed as input to the program.</span>
<span class="sd">        products (list, optional): Paths to files created by the model that</span>
<span class="sd">            should be cleaned up when the model exits. Entries can be absolute</span>
<span class="sd">            paths or paths relative to the working directory. Defaults to [].</span>
<span class="sd">        function (str, optional): If provided, an integrated model is</span>
<span class="sd">            created by wrapping the function named here. The function must be</span>
<span class="sd">            located within the file specified by the source file listed in the</span>
<span class="sd">            first argument. If not provided, the model must contain it&#39;s own</span>
<span class="sd">            calls to the |yggdrasil| interface.</span>
<span class="sd">        iter_function_over (array, optional): Variable(s) that should be</span>
<span class="sd">            received or sent as an array, but iterated over. Defaults to an</span>
<span class="sd">            empty array and is ignored.</span>
<span class="sd">        source_products (list, optional): Files created by running the model</span>
<span class="sd">            that are source files. These files will be removed without checking</span>
<span class="sd">            their extension so users should avoid adding files to this list</span>
<span class="sd">            unless they are sure they should be deleted. Defaults to [].</span>
<span class="sd">        is_server (bool, dict, optional): If `True`, the model is assumed to be a</span>
<span class="sd">            server for one or more client models and an instance of</span>
<span class="sd">            :class:`yggdrasil.drivers.ServerDriver` is started. The</span>
<span class="sd">            corresponding channel that should be passed to the yggdrasil API</span>
<span class="sd">            will be the name of the model. If is_server is a dictionary, it</span>
<span class="sd">            should contain an &#39;input&#39; key and an &#39;output&#39; key. These are</span>
<span class="sd">            required to be the names of existing input and output channels in</span>
<span class="sd">            the model that will be co-opted by the server. (Note: This requires</span>
<span class="sd">            that the co-opted output channel&#39;s send method is called once for</span>
<span class="sd">            each time the co-opted input channel&#39;s recv method is called. If</span>
<span class="sd">            used with the `function` parameter, `is_server` must be a dictionary.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        client_of (str, list, optional): The names of one or more models that</span>
<span class="sd">            this model will call as a server. If there are more than one, this</span>
<span class="sd">            should be specified as a sequence collection (list). The</span>
<span class="sd">            corresponding channel(s) that should be passed to the yggdrasil API</span>
<span class="sd">            will be the name of the server model joined with the name of the</span>
<span class="sd">            client model with an underscore `&lt;server_model&gt;_&lt;client_model&gt;`.</span>
<span class="sd">            There will be one channel created for each server the model is a</span>
<span class="sd">            client of. Defaults to empty list. Use of `client_of` with `function`</span>
<span class="sd">            is not currently supported.</span>
<span class="sd">        timesync (bool, str, optional): If set, the model is assumed to</span>
<span class="sd">            call a send then receive of the state at each timestep</span>
<span class="sd">            for syncronization with other models that are also</span>
<span class="sd">            integrating in time. If a string is provided, it is assumed</span>
<span class="sd">            to be the name of the server that will handle timestep</span>
<span class="sd">            synchronization. If a boolean is provided, the name of the</span>
<span class="sd">            server will be assumed to be &#39;timestep&#39;. Defaults to False.</span>
<span class="sd">        overwrite (bool, optional): If True, any existing model products</span>
<span class="sd">            (compilation products, wrapper scripts, etc.) are removed prior to</span>
<span class="sd">            the run. If False, the products are not removed. Defaults to True.</span>
<span class="sd">            Setting this to False can improve the performance, particularly for</span>
<span class="sd">            models that take a long time to compile, but this should only be</span>
<span class="sd">            done once the model has been fully debugged to ensure that each run</span>
<span class="sd">            is tested on a clean copy of the model. The value of this keyword</span>
<span class="sd">            also determines whether or not products are removed after a run.</span>
<span class="sd">        preserve_cache (bool, optional): If True model products will be kept</span>
<span class="sd">            following the run, otherwise all products will be cleaned up.</span>
<span class="sd">            Defaults to False. This keyword is superceeded by overwrite.</span>
<span class="sd">        with_strace (bool, optional): If True, the command is run with strace (on</span>
<span class="sd">            Linux) or dtrace (on MacOS). Defaults to False.</span>
<span class="sd">        strace_flags (list, optional): Flags to pass to strace (or dtrace).</span>
<span class="sd">            Defaults to [].</span>
<span class="sd">        with_valgrind (bool, optional): If True, the command is run with valgrind.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        valgrind_flags (list, optional): Flags to pass to valgrind. Defaults to [].</span>
<span class="sd">        model_index (int, optional): Index of model in list of models being run.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        copy_index (int, optional): Index of model in set of copies. Defaults</span>
<span class="sd">            to -1 indicating there is only one copy of the model.</span>
<span class="sd">        outputs_in_inputs (bool, optional): If True, outputs from wrapped model</span>
<span class="sd">            functions are passed by pointer as inputs for modification and the</span>
<span class="sd">            return value will be a flag. If False, outputs are limited to</span>
<span class="sd">            return values. Defaults to the value of the class attribute</span>
<span class="sd">            outputs_in_inputs.</span>
<span class="sd">        logging_level (str, optional): The level of logging messages that should</span>
<span class="sd">            be displayed by the model. Defaults to the logging level as</span>
<span class="sd">            determined by the configuration file and environment variables.</span>
<span class="sd">        allow_threading (bool, optional): If True, comm connections will be set up</span>
<span class="sd">            so that the model-side comms can be used by more than one thread.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        copies (int, optional): The number of copies of the model that should be</span>
<span class="sd">            created. Defaults to 1.</span>
<span class="sd">        **kwargs: Additional keyword arguments are passed to parent class.</span>

<span class="sd">    Class Attributes:</span>
<span class="sd">        language (str): Primary name for the programming language that this</span>
<span class="sd">            compiler should be used for. [REQUIRED]</span>
<span class="sd">        language_aliases (list): Additional/alternative names that the language</span>
<span class="sd">            may be known by.</span>
<span class="sd">        language_ext (list): Extensions for programs written in the target</span>
<span class="sd">            language. [REQUIRED]</span>
<span class="sd">        base_languages (list): Other programming languages that this driver</span>
<span class="sd">            and the interpreter for the target language are dependent on (e.g.</span>
<span class="sd">            Matlab models require Python).</span>
<span class="sd">        executable_type (str): &#39;compiler&#39; or &#39;interpreter&#39; to indicate the type</span>
<span class="sd">            of the executable for the language. [AUTOMATED]</span>
<span class="sd">        interface_library (list): Name of the library containing the yggdrasil</span>
<span class="sd">            interface for the target language. [REQUIRED]</span>
<span class="sd">        interface_directories (list): Directories containing code in the</span>
<span class="sd">            interface library for the target language.</span>
<span class="sd">        interface_dependencies (list): List of names of libraries that are</span>
<span class="sd">            required to use the interface on the current platform. This dosn&#39;t</span>
<span class="sd">            include libraries required by specific communication types which are</span>
<span class="sd">            described by supported_comm_options.</span>
<span class="sd">        supported_comms (list): Name of comms supported in the target language.</span>
<span class="sd">            [REQUIRED]</span>
<span class="sd">        supported_comm_options (dict): Options for the supported comms like the</span>
<span class="sd">            platforms they are available on and the external libraries required</span>
<span class="sd">            to use them. [REQUIRED]</span>
<span class="sd">        external_libraries (dict): Information on external libraries required</span>
<span class="sd">            for running models in the target language using yggdrasil.</span>
<span class="sd">        internal_libraries (dict): Information on internal libraries required</span>
<span class="sd">            for running models in the target language using yggdrasil.</span>
<span class="sd">        type_map (dict): Mapping of |yggdrasil| extended JSON types to</span>
<span class="sd">            datatypes in the target programming language. [REQUIRED]</span>
<span class="sd">        function_param (dict): Options specifying how different operations</span>
<span class="sd">            would be encoded in the target language (e.g. if statements, for</span>
<span class="sd">            loops, while loops). [REQUIRED]</span>
<span class="sd">        version_flags (list): Flags that should be called with the language</span>
<span class="sd">            executable to determine the version of the compiler/interpreter.</span>
<span class="sd">            Defaults to [&#39;--version&#39;].</span>
<span class="sd">        outputs_in_inputs (bool): If True, outputs are passed by pointer as</span>
<span class="sd">            inputs for modification and the return value should be a flag.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        include_arg_count (bool): If True, the number of arguments passed</span>
<span class="sd">            to send/recv calls is prepended to the arguments to the function.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        include_channel_obj (bool): If True, the channel object is passed as</span>
<span class="sd">            input to the send/recv calls (after the argument count if it is</span>
<span class="sd">            also present due to include_arg_count being True). Defaults to</span>
<span class="sd">            False.</span>
<span class="sd">        is_typed (bool): True if the language is typed, False otherwise.</span>
<span class="sd">        brackets (tuple): A pair of opening and clossing characters that</span>
<span class="sd">            are used by the language to mark blocks. Set to None and</span>
<span class="sd">            ignored by default.</span>
<span class="sd">        no_executable (bool): True if there is not an executable associated</span>
<span class="sd">            with the language driver. Defaults to False.</span>
<span class="sd">        comms_implicit (bool): True if the comms installed for this driver</span>
<span class="sd">            are not explicitly defined (depend on input parameters). Defaults</span>
<span class="sd">            to False.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        args (list): Argument(s) for running the model on the command line.</span>
<span class="sd">        model_file (str): Full path to the model executable or interpretable</span>
<span class="sd">            script.</span>
<span class="sd">        model_args (list): Runtime arguments for running the model on the</span>
<span class="sd">            command line.</span>
<span class="sd">        model_src (str): Full path to the model source code. For interpreted</span>
<span class="sd">            languages, this will be the same as model_file.</span>
<span class="sd">        model_function_info (dict): Parameters recovered by parsing the</span>
<span class="sd">            provided model function definition.</span>
<span class="sd">        overwrite (bool): If True, any existing compilation products will be</span>
<span class="sd">            overwritten by compilation and cleaned up following the run.</span>
<span class="sd">            Otherwise, existing products will be used and will remain after</span>
<span class="sd">            the run.</span>
<span class="sd">        products (list): Files created by running the model. This includes</span>
<span class="sd">            compilation products such as executables and/or object files.</span>
<span class="sd">        source_products (list): Files created by running the model that</span>
<span class="sd">            are source files. These files will be removed without checking</span>
<span class="sd">            their extension so users should avoid adding files to this list</span>
<span class="sd">            unless they are sure they should be deleted.</span>
<span class="sd">        wrapper_products (list): Files created in order to wrap the model.</span>
<span class="sd">        process (:class:`yggdrasil.tools.YggPopen`): Process used to run</span>
<span class="sd">            the model.</span>
<span class="sd">        function (str): The name of the model function that should be wrapped.</span>
<span class="sd">        iter_function_over (array): Variable(s) that should be received or</span>
<span class="sd">            sent as an array, but iterated over.</span>
<span class="sd">        is_server (bool, dict): If True, the model is assumed to be a server</span>
<span class="sd">            and an instance of :class:`yggdrasil.drivers.ServerDriver` is</span>
<span class="sd">            started. If a dict, the input/output channels with the specified</span>
<span class="sd">            names in the dict will be replaced with a server.</span>
<span class="sd">        client_of (list): The names of server models that this model is a</span>
<span class="sd">            client of.</span>
<span class="sd">        timesync (str): If set, the name of the server performing</span>
<span class="sd">            timestep synchronization for the model.</span>
<span class="sd">        with_strace (bool): If True, the command is run with strace or dtrace.</span>
<span class="sd">        strace_flags (list): Flags to pass to strace/dtrace.</span>
<span class="sd">        with_valgrind (bool): If True, the command is run with valgrind.</span>
<span class="sd">        valgrind_flags (list): Flags to pass to valgrind.</span>
<span class="sd">        model_index (int): Index of model in list of models being run.</span>
<span class="sd">        copy_index (int): Index of model in set of copies.</span>
<span class="sd">        modified_files (list): List of pairs of originals and copies of files</span>
<span class="sd">            that should be restored during cleanup.</span>
<span class="sd">        allow_threading (bool): If True, comm connections will be set up so that</span>
<span class="sd">            the model-side comms can be used by more than one thread.</span>
<span class="sd">        copies (int): The number of copies of the model that should be created.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If both with_strace and with_valgrind are True.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_schema_type</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span>
    <span class="n">_schema_subtype_key</span> <span class="o">=</span> <span class="s1">&#39;language&#39;</span>
    <span class="n">_schema_required</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="s1">&#39;working_dir&#39;</span><span class="p">]</span>
    <span class="n">_schema_properties</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
        <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;executable&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">(</span>
                         <span class="s1">&#39;The programming language that the model &#39;</span>
                         <span class="s1">&#39;is written in. A list of available &#39;</span>
                         <span class="s1">&#39;languages can be found :ref:`here &lt;&#39;</span>
                         <span class="s1">&#39;schema_table_model_subtype_rst&gt;`.&#39;</span><span class="p">)},</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
        <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[],</span>
                   <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$ref&#39;</span><span class="p">:</span> <span class="s1">&#39;#/definitions/comm&#39;</span><span class="p">},</span>
                   <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">(</span>
                       <span class="s1">&#39;A mapping object containing the entry for a &#39;</span>
                       <span class="s1">&#39;model input channel or a list of input &#39;</span>
                       <span class="s1">&#39;channel entries. If the model does not get &#39;</span>
                       <span class="s1">&#39;input from another model, this may be &#39;</span>
                       <span class="s1">&#39;ommitted. A full description of channel &#39;</span>
                       <span class="s1">&#39;entries and the options available for &#39;</span>
                       <span class="s1">&#39;channels can be found :ref:`here&lt;&#39;</span>
                       <span class="s1">&#39;yaml_comm_options&gt;`.&#39;</span><span class="p">)},</span>
        <span class="s1">&#39;outputs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$ref&#39;</span><span class="p">:</span> <span class="s1">&#39;#/definitions/comm&#39;</span><span class="p">},</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s1">&#39;A mapping object containing the entry for a &#39;</span>
                        <span class="s1">&#39;model output channel or a list of output &#39;</span>
                        <span class="s1">&#39;channel entries. If the model does not &#39;</span>
                        <span class="s1">&#39;output to another model, this may be &#39;</span>
                        <span class="s1">&#39;ommitted. A full description of channel &#39;</span>
                        <span class="s1">&#39;entries and the options available for &#39;</span>
                        <span class="s1">&#39;channels can be found :ref:`here&lt;&#39;</span>
                        <span class="s1">&#39;yaml_comm_options&gt;`.&#39;</span><span class="p">)},</span>
        <span class="s1">&#39;env&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;additional_properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
        <span class="s1">&#39;products&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[],</span>
                     <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
        <span class="s1">&#39;source_products&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
        <span class="s1">&#39;working_dir&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
        <span class="s1">&#39;overwrite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">},</span>
        <span class="s1">&#39;preserve_cache&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
        <span class="s1">&#39;iter_function_over&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[],</span>
                               <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
        <span class="s1">&#39;is_server&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;anyOf&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">},</span>
                                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                                                <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
                                 <span class="s1">&#39;additionalProperties&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}],</span>
                      <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="s1">&#39;client_of&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                      <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[]},</span>
        <span class="s1">&#39;timesync&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;anyOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                 <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                     <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;timesync&#39;</span><span class="p">},</span>
                     <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;anyOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                         <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                         <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}}]},</span>
                     <span class="s1">&#39;outputs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;anyOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                         <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                         <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}}]}}},</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span>
                     <span class="s1">&#39;anyOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                         <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                         <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                              <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;timesync&#39;</span><span class="p">},</span>
                              <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;anyOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                                  <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                                  <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}}]},</span>
                              <span class="s1">&#39;outputs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;anyOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                                  <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                                  <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}}]}}}]}}],</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="s1">&#39;with_strace&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="s1">&#39;strace_flags&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;trace=memory&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
        <span class="s1">&#39;with_valgrind&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="s1">&#39;valgrind_flags&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;--leak-check=full&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;--show-leak-kinds=all&#39;</span><span class="p">],</span>  <span class="c1"># &#39;-v&#39;</span>
                           <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
        <span class="s1">&#39;outputs_in_inputs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">},</span>
        <span class="s1">&#39;logging_level&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
        <span class="s1">&#39;allow_threading&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">},</span>
        <span class="s1">&#39;copies&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;minimum&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>
    <span class="n">_schema_excluded_from_class</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="s1">&#39;working_dir&#39;</span><span class="p">]</span>
    <span class="n">_schema_excluded_from_class_validation</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">]</span>
    
    <span class="n">language</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">language_ext</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">language_aliases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">base_languages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">executable_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">interface_library</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">interface_directories</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">interface_dependencies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">supported_comms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">supported_comm_options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">external_libraries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">internal_libraries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">type_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inverse_type_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">function_param</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">version_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--version&#39;</span><span class="p">]</span>
    <span class="n">full_language</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">outputs_in_inputs</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">include_arg_count</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">include_channel_obj</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_typed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">types_in_funcdef</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">interface_inside_exec</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dont_declare_channel</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_dsl</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">brackets</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">zero_based</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">max_line_width</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">no_executable</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">comms_implicit</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">python_interface</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;table_input&#39;</span><span class="p">:</span> <span class="s1">&#39;YggAsciiTableInput&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;table_output&#39;</span><span class="p">:</span> <span class="s1">&#39;YggAsciiTableOutput&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;array_input&#39;</span><span class="p">:</span> <span class="s1">&#39;YggArrayInput&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;array_output&#39;</span><span class="p">:</span> <span class="s1">&#39;YggArrayOutput&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pandas_input&#39;</span><span class="p">:</span> <span class="s1">&#39;YggPandasInput&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pandas_output&#39;</span><span class="p">:</span> <span class="s1">&#39;YggPandasOutput&#39;</span><span class="p">}</span>
    <span class="n">_library_cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_config_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_config_attr_map</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_executable_search_dirs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_disconnect_attr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Driver</span><span class="o">.</span><span class="n">_disconnect_attr</span>
                        <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;queue&#39;</span><span class="p">,</span> <span class="s1">&#39;queue_thread&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;event_process_kill_called&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;event_process_kill_complete&#39;</span><span class="p">])</span>
    <span class="n">_mpi_tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ENV&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;START&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="s1">&#39;STOP_RANK0&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Stopped by partner</span>
                 <span class="s1">&#39;STOP_RANKX&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="c1"># Stopped by root</span>
                 <span class="s1">&#39;BUILDFILE&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="s1">&#39;LOCK_BUILDFILE&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                 <span class="s1">&#39;UNLOCK_BUILDFILE&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">model_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copy_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">clients</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">preparsed_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mpi_rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mpi_tag_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mpi_tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tags</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_outputs_in_inputs</span> <span class="o">=</span> <span class="n">outputs_in_inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preparsed_function</span> <span class="o">=</span> <span class="n">preparsed_function</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">preserve_cache</span><span class="p">)</span>
        <span class="c1"># Setup process things</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_process_kill_called</span> <span class="o">=</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_process_kill_complete</span> <span class="o">=</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="c1"># Strace/valgrind</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_strace</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_valgrind</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Trying to run with strace and valgrind.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">with_strace</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_valgrind</span><span class="p">)</span>
             <span class="ow">and</span> <span class="n">platform</span><span class="o">.</span><span class="n">_is_win</span><span class="p">)):</span>  <span class="c1"># pragma: windows</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;strace/valgrind options invalid on windows.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_index</span> <span class="o">=</span> <span class="n">model_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_index</span> <span class="o">=</span> <span class="n">copy_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span> <span class="o">=</span> <span class="n">clients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_copy</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LANG&#39;</span><span class="p">,</span> <span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;USER&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_line</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;EXIT&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_copy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_installed</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not installed&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_model_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_function_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_function_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_function_inputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_function_outputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper_products</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_rank</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_requests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tag</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tags</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mpi_tag_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tag</span> <span class="o">+=</span> <span class="n">mpi_tag_start</span>
        <span class="k">if</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">_on_mpi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span> <span class="o">=</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_partner_rank</span> <span class="o">=</span> <span class="n">mpi_rank</span>
        <span class="c1"># Update for function</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_from_function</span><span class="p">(</span><span class="n">args</span><span class="p">)]</span>
        <span class="c1"># Parse arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Remove products</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_products</span><span class="p">()</span>
        <span class="c1"># Write wrapper</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrapper_products</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper_products</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_wrappers</span><span class="p">()</span>

<div class="viewcode-block" id="ModelDriver.before_registration"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.before_registration">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">before_registration</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Operations that should be performed to modify class attributes prior</span>
<span class="sd">        to registration including things like platform dependent properties and</span>
<span class="sd">        checking environment variables for default settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Driver</span><span class="o">.</span><span class="n">before_registration</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">inverse_type_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_language</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_language_aliases</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language_aliases</span>
        <span class="k">if</span> <span class="p">(((</span><span class="bp">cls</span><span class="o">.</span><span class="n">language_ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
             <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language_ext</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))))):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">language_ext</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">language_ext</span><span class="p">]</span></div>
            
<div class="viewcode-block" id="ModelDriver.after_registration"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.after_registration">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">after_registration</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">second_pass</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Operations that should be performed to modify class attributes after</span>
<span class="sd">        registration. For compiled languages this includes selecting the</span>
<span class="sd">        default compiler. The order of precedence is the config file &#39;compiler&#39;</span>
<span class="sd">        option for the language, followed by the environment variable set by</span>
<span class="sd">        _compiler_env, followed by the existing class attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            cfg (YggConfigParser, optional): Config class that should</span>
<span class="sd">                be used to set options for the driver. Defaults to</span>
<span class="sd">                None and yggdrasil.config.ygg_cfg is used.</span>
<span class="sd">            second_pass (bool, optional): If True, the class as already</span>
<span class="sd">                been registered. Defaults to False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">yggdrasil.config</span> <span class="kn">import</span> <span class="n">ygg_cfg</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">ygg_cfg</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="n">Driver</span><span class="o">.</span><span class="n">after_registration</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_config_attr_map</span><span class="p">:</span>
            <span class="n">ka</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span>
            <span class="n">k0</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">ka</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span>
                                         <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ka</span><span class="p">)))</span></div>
        
<div class="viewcode-block" id="ModelDriver.finalize_registration"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.finalize_registration">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">finalize_registration</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Operations that should be performed after a class has been fully</span>
<span class="sd">        initialized and registered.&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_map_language_ext</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_language_ext</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_map_language_ext</span><span class="p">:</span>
                <span class="n">_map_language_ext</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_map_language_ext</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.mpi_partner_init"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.mpi_partner_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">mpi_partner_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions initializing an MPIPartnerModel.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ModelDriver.mpi_partner_cleanup"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.mpi_partner_cleanup">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">mpi_partner_cleanup</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions cleaning up an MPIPartnerModel.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ModelDriver.get_inverse_type_map"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_inverse_type_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_inverse_type_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the inverse type map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Mapping from native type to JSON type.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">inverse_type_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">inverse_type_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">type_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;flag&#39;</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">inverse_type_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">inverse_type_map</span></div>

<div class="viewcode-block" id="ModelDriver.get_language_for_source"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_language_for_source">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_language_for_source</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">early_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine the language that can be used with the provided source</span>
<span class="sd">        file(s). If more than one language applies to a set of multiple files,</span>
<span class="sd">        the language that applies to the most files is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            fname (str, list): The full path to one or more files. If more than</span>
<span class="sd">                one</span>
<span class="sd">            languages (list, optional): The list of languages that are acceptable.</span>
<span class="sd">                Defaults to None and any language will be acceptable.</span>
<span class="sd">            early_exit (bool, optional): If True, the first language identified</span>
<span class="sd">                will be returned if fname is a list of files. Defaults to False.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to recursive calls.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The language that can operate on the specified file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">lang_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ilang</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_language_for_source</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
                                                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">early_exit</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ilang</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">lang_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ilang</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">lang_dict</span><span class="p">[</span><span class="n">ilang</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">lang_dict</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">lang_dict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">lang_dict</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ilang</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_map_language_ext</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">languages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ilang</span> <span class="ow">in</span> <span class="n">languages</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">ilang</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot determine language for file(s): &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span></div>
                
<div class="viewcode-block" id="ModelDriver.get_map_language_ext"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_map_language_ext">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_map_language_ext</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the mapping of all language extensions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_map_language_ext</span></div>

<div class="viewcode-block" id="ModelDriver.get_all_language_ext"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_all_language_ext">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_language_ext</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the list of all language extensions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">_map_language_ext</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="ModelDriver.get_language_dir"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_language_dir">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_language_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the langauge directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">languages</span><span class="o">.</span><span class="n">get_language_dir</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.get_language_ext"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_language_ext">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_language_ext</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the language extension, including from the base classes.&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language_ext</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">base_languages</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">import_component</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">get_language_ext</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span></div>
        
<div class="viewcode-block" id="ModelDriver.parse_arguments"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.parse_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">parse_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">default_model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sort model arguments to determine which one is the executable</span>
<span class="sd">        and which ones are arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (list): List of arguments provided.</span>
<span class="sd">            default_model_dir (str, optional): Path to directory that should be</span>
<span class="sd">                used to normalize the model file path if it is not absolute.</span>
<span class="sd">                Defaults to None and is set to the working_dir.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
            <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">default_model_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_model_file</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_model_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">!=</span> <span class="s1">&#39;executable&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">)):</span>
            <span class="n">model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">default_model_dir</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="o">=</span> <span class="n">model_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;model_file = &#39;</span><span class="si">%s</span><span class="s2">&#39;, model_dir = &#39;</span><span class="si">%s</span><span class="s2">&#39;, model_args = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.init_from_function"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.init_from_function">[docs]</a>    <span class="k">def</span> <span class="nf">init_from_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize model parameters based on the wrapped function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparsed_function</span><span class="p">:</span>
            <span class="n">yml_mock</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
                            <span class="n">is_server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_server</span><span class="p">,</span>
                            <span class="n">client_of</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client_of</span><span class="p">,</span>
                            <span class="n">inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
                            <span class="n">outputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span>
                            <span class="n">iter_function_over</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_function_over</span><span class="p">,</span>
                            <span class="n">copies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copies</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preparsed_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparse_function</span><span class="p">(</span><span class="n">yml_mock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_function_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparsed_function</span><span class="p">[</span><span class="s1">&#39;model_file&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_function_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_function_info</span><span class="p">[</span><span class="s1">&#39;model_file&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_function_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparsed_function</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_function_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparsed_function</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_outputs_in_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparsed_function</span><span class="p">[</span><span class="s1">&#39;outputs_in_inputs&#39;</span><span class="p">]</span>
        <span class="n">model_dir</span><span class="p">,</span> <span class="n">model_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_function_file</span><span class="p">)</span>
        <span class="n">model_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">model_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wrapper_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span>
                                     <span class="s1">&#39;ygg_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">language_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_model_wrapper</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                         <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">preparsed_function</span><span class="p">)</span>
        <span class="c1"># Write file</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">wrapper_fname</span><span class="p">))</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">wrapper_fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">wrapper_fname</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">numeric_logging_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;int: Logging level for the model.&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_sent_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;dict: Number of messages sent by the model via each connection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mpi_rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mpi_request</span><span class="p">(</span><span class="s1">&#39;stopped&#39;</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_requests</span><span class="p">[</span><span class="s1">&#39;stopped&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">result</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_drivers&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">x_inst</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x_inst</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">x_inst</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_inst</span><span class="o">.</span><span class="n">models_recvd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_server</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_drivers&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">x_inst</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x_inst</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_inst</span><span class="o">.</span><span class="n">_connection_type</span> <span class="o">==</span> <span class="s1">&#39;rpc_request&#39;</span><span class="p">):</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">x_inst</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_inst</span><span class="o">.</span><span class="n">servers_recvd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_sent_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;bool: True if output has been received from the model.&quot;&quot;&quot;</span>
        <span class="n">n_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n_msg</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">n_msg</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

<div class="viewcode-block" id="ModelDriver.write_wrappers"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_wrappers">[docs]</a>    <span class="k">def</span> <span class="nf">write_wrappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write any wrappers needed to compile and/or run a model.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Keyword arguments are ignored (only included to</span>
<span class="sd">               allow cascade from child classes).</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Full paths to any created wrappers.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>
        
<div class="viewcode-block" id="ModelDriver.model_command"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.model_command">[docs]</a>    <span class="k">def</span> <span class="nf">model_command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the command that should be used to run the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Any commands/arguments needed to run the model from the</span>
<span class="sd">                command line.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_args</span></div>

<div class="viewcode-block" id="ModelDriver.language_executable"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.language_executable">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">language_executable</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Command required to compile/run a model written in this language</span>
<span class="sd">        from the command line.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Name of (or path to) compiler/interpreter executable required</span>
<span class="sd">                to run the compiler/interpreter from the command line.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">no_executable</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;language_executable not implemented for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                                  <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="ModelDriver.executable_command"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.executable_command">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">executable_command</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">unused_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compose a command for running a program using the exectuable for</span>
<span class="sd">        this language (compiler/interpreter) with the provided arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (list): The program that returned command should run and any</span>
<span class="sd">                arguments that should be provided to it.</span>
<span class="sd">            unused_kwargs (dict, optional): Existing dictionary that unused</span>
<span class="sd">                keyword arguments should be added to. Defaults to None and is</span>
<span class="sd">                ignored.</span>
<span class="sd">            **kwargs: Additional keyword arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Arguments composing the command required to run the program</span>
<span class="sd">                from the command line using the executable for this language.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;executable_command not implemented for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                                  <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.run_executable"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.run_executable">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">run_executable</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">return_process</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug_flags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run a program using the executable for this language and the</span>
<span class="sd">        provided arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (list): The program that should be run and any arguments</span>
<span class="sd">                that should be provided to it.</span>
<span class="sd">            return_process (bool, optional): If True, the process class is</span>
<span class="sd">                returned without checking the process output. If False,</span>
<span class="sd">                communicate is called on the process and the output is parsed</span>
<span class="sd">                for errors. Defaults to False.</span>
<span class="sd">            debug_flags (list, optional): Debug executable and flags that should</span>
<span class="sd">                be prepended to the executable command. Defaults to None and</span>
<span class="sd">                is ignored.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to</span>
<span class="sd">                cls.executable_command and tools.popen_nobuffer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Output to stdout from the run command if return_process is</span>
<span class="sd">                False, the process if return_process is True.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the language is not installed.</span>
<span class="sd">            RuntimeError: If there is an error when running the command.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unused_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">executable_command</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">unused_kwargs</span><span class="o">=</span><span class="n">unused_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">debug_flags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">debug_flags</span> <span class="o">+</span> <span class="n">cmd</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Add default keyword arguments</span>
            <span class="k">if</span> <span class="s1">&#39;working_dir&#39;</span> <span class="ow">in</span> <span class="n">unused_kwargs</span><span class="p">:</span>
                <span class="n">unused_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;cwd&#39;</span><span class="p">,</span> <span class="n">unused_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;working_dir&#39;</span><span class="p">))</span>
            <span class="n">unused_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="n">platform</span><span class="o">.</span><span class="n">_is_win</span><span class="p">)</span>
            <span class="c1"># Call command</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Running &#39;</span><span class="si">%s</span><span class="s2">&#39; from </span><span class="si">%s</span><span class="s2">&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">unused_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cwd&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Process keyword arguments:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">pformat</span><span class="p">(</span><span class="n">unused_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">popen_nobuffer</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_process</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">proc</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Command &#39;</span><span class="si">%s</span><span class="s2">&#39; failed with code </span><span class="si">%d</span><span class="s2">.&quot;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">out</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not call command &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="ModelDriver.run_model"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.run_model">[docs]</a>    <span class="k">def</span> <span class="nf">run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run the model. Unless overridden, the model will be run using</span>
<span class="sd">        run_executable.</span>

<span class="sd">        Args:</span>
<span class="sd">            return_process (bool, optional): If True, the process running</span>
<span class="sd">                the model is returned. If False, the process will block until</span>
<span class="sd">                the model finishes running. Defaults to True.</span>
<span class="sd">            **kwargs: Keyword arguments are passed to run_executable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_env</span><span class="p">()</span>
        <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_command</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_strace</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_valgrind</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;debug_flags&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_flags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Working directory: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Command: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Environment Variables:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">block_indent</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Update keywords</span>
        <span class="c1"># NOTE: Setting forward_signals to False allows faster debugging</span>
        <span class="c1"># but should not be used in deployment for cases where models are not</span>
        <span class="c1"># running locally.</span>
        <span class="n">default_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">working_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span>
                              <span class="n">forward_signals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">shell</span><span class="o">=</span><span class="n">platform</span><span class="o">.</span><span class="n">_is_win</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_executable</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">return_process</span><span class="o">=</span><span class="n">return_process</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">debug_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;list: Flags that should be prepended to an executable command to</span>
<span class="sd">        enable debugging.&quot;&quot;&quot;</span>
        <span class="n">pre_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_strace</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">_is_linux</span><span class="p">:</span>
                <span class="n">pre_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;strace&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">strace_flags</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;strace not supported on this OS.&quot;</span><span class="p">)</span>
            <span class="c1"># TODO: dtruss cannot be run without sudo, sudo cannot be</span>
            <span class="c1"># added to the model process command if it is not in the original</span>
            <span class="c1"># yggdrasil CLI call, and must be tested with an executable that</span>
            <span class="c1"># is not &quot;signed with restricted entitlements&quot; (which most built-in</span>
            <span class="c1"># utilities (e.g. sleep) are).</span>
            <span class="c1"># elif platform._is_mac:</span>
            <span class="c1">#     if &#39;sudo&#39; in sys.argv:</span>
            <span class="c1">#         pre_args += [&#39;sudo&#39;]</span>
            <span class="c1">#     pre_args += [&#39;dtruss&#39;]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_valgrind</span><span class="p">:</span>
            <span class="n">pre_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;valgrind&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">valgrind_flags</span>
        <span class="k">return</span> <span class="n">pre_args</span>
        
<div class="viewcode-block" id="ModelDriver.language_version"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.language_version">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">language_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">version_flags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine the version of this language.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Keyword arguments are passed to cls.run_executable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Version of compiler/interpreter for this language.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">version_flags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">version_flags</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">version_flags</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">run_executable</span><span class="p">(</span><span class="n">version_flags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.is_installed"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.is_installed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_installed</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if this model driver is installed on the current</span>
<span class="sd">        machine.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Truth of if this model driver can be run on the current</span>
<span class="sd">                machine.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">is_language_installed</span><span class="p">()</span>
                <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">are_base_languages_installed</span><span class="p">()</span>
                <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">are_dependencies_installed</span><span class="p">()</span>
                <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_interface_installed</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_comm_installed</span><span class="p">()</span>
                <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_configured</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_disabled</span><span class="p">()))</span></div>

<div class="viewcode-block" id="ModelDriver.are_base_languages_installed"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.are_base_languages_installed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">are_base_languages_installed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if the base languages are installed.</span>

<span class="sd">        Args:</span>
<span class="sd">            missing (list, optional): A pre-existing list that</span>
<span class="sd">                missing base languages should be appended to.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the base langauges are installed. False otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">base_languages</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">out</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">missing</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">break</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">import_component</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">is_installed</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">missing</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">out</span><span class="p">):</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.are_dependencies_installed"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.are_dependencies_installed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">are_dependencies_installed</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if the dependencies are installed for the interface (not</span>
<span class="sd">        including dependencies needed by a particular communication type).</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the dependencies are installed. False otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">interface_dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">break</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_library_installed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.is_interface_installed"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.is_interface_installed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_interface_installed</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if the interface library for the associated programming</span>
<span class="sd">        language is installed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the interface library is installed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">interface_library</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_library_installed</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">interface_library</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="ModelDriver.is_language_installed"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.is_language_installed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_language_installed</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if the interpreter/compiler for the associated programming</span>
<span class="sd">        language is installed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the language interpreter/compiler is installed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language_executable</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="n">out</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.identify_source_files"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.identify_source_files">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">identify_source_files</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">working_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine the source file based on model arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (list, optional): Arguments provided.</span>
<span class="sd">            working_dir (str, optional): Working directory.</span>
<span class="sd">            **kwargs: Additional keyword arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Source files.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(((</span><span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_source_file</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
                 <span class="ow">and</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language_ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                 <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">src</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                      <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_all_language_ext</span><span class="p">()))):</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">src</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">working_dir</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">src</span><span class="p">)):</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.is_source_file"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.is_source_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_source_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if the provided file name points to a source files for</span>
<span class="sd">        the associated programming language by checking the extension.</span>

<span class="sd">        Args:</span>
<span class="sd">            fname (str): Path to file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the provided file is a source file, False otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">model_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_ext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_ext</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_language_ext</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.is_library_installed"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.is_library_installed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_library_installed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if a dependency is installed.</span>

<span class="sd">        Args:</span>
<span class="sd">            lib (str): Name of the library that should be checked.</span>
<span class="sd">            **kwargs: Additional keyword arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the library is installed, False otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Method is_library_installed missing for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                                  <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.is_disabled"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.is_disabled">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_disabled</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="s1">&#39;disable&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.is_configured"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.is_configured">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_configured</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if the appropriate configuration has been performed (e.g.</span>
<span class="sd">        installation of supporting libraries etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the language has been configured.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for section &amp; diable</span>
        <span class="n">disable_flag</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_disabled</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">disable_flag</span><span class="p">))</span>
        <span class="c1"># Check for commtypes</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">base_languages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="s1">&#39;commtypes&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Check for config keys</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_config_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">break</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.is_comm_installed"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.is_comm_installed">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_comm_installed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">commtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_config</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if a comm is installed for the associated programming</span>
<span class="sd">        language.</span>

<span class="sd">        Args:</span>
<span class="sd">            commtype (str, optional): If provided, this method will only test</span>
<span class="sd">                for installation of the specified communication type. Defaults</span>
<span class="sd">                to None and will check for any installed comm.</span>
<span class="sd">            skip_config (bool, optional): If True, the config list of comms</span>
<span class="sd">                installed for this language will not be used to determine if</span>
<span class="sd">                the comm is installed and the class attribute</span>
<span class="sd">                supported_comm_options will be processed. Defaults to False and</span>
<span class="sd">                config options are used in order to improve performance after</span>
<span class="sd">                initial configuration.</span>
<span class="sd">            platforms (list, optional): Platforms on which the comm can be</span>
<span class="sd">                installed. Defaults to None and is ignored unless there is a</span>
<span class="sd">                value for the commtype in supported_comm_options. This</span>
<span class="sd">                keyword argument is ignored if skip_config is False.</span>
<span class="sd">            libraries (list, optional): External libraries that are required</span>
<span class="sd">                by the specified commtype. Defaults to None and is ignored</span>
<span class="sd">                unless there is a value for the commtype in supported_comm_options.</span>
<span class="sd">                This keyword argument is ignored if skip_config is False.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to either</span>
<span class="sd">                is_comm_installed for the base languages, supported languages,</span>
<span class="sd">                or is_library_installed as appropriate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if a comm is installed for this language.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If there are base_languages for this language, use that language&#39;s</span>
        <span class="c1"># driver to check for comm installation.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">base_languages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">base_languages</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">break</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">import_component</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">is_comm_installed</span><span class="p">(</span>
                    <span class="n">commtype</span><span class="o">=</span><span class="n">commtype</span><span class="p">,</span> <span class="n">skip_config</span><span class="o">=</span><span class="n">skip_config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">comms_implicit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">commtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">commtype</span> <span class="ow">in</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_supported_comm</span><span class="p">())</span>
        <span class="c1"># Check for installation based on config option</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_config</span><span class="p">:</span>
            <span class="n">installed_comms</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="s1">&#39;commtypes&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">commtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">installed_comms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">commtype</span> <span class="ow">in</span> <span class="n">installed_comms</span><span class="p">)</span>
        <span class="c1"># Check for any comm</span>
        <span class="k">if</span> <span class="n">commtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">supported_comms</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_comm_installed</span><span class="p">(</span><span class="n">commtype</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">skip_config</span><span class="o">=</span><span class="n">skip_config</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Check that comm is explicitly supported</span>
        <span class="k">if</span> <span class="n">commtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">supported_comms</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Set &amp; pop keywords</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">supported_comm_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commtype</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">platforms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;platforms&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">libraries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;libraries&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># Check platforms</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">platforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">_platform</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">platforms</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># pragma: windows</span>
        <span class="c1"># Check libraries</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">libraries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_library_installed</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Check for server on RabbitMQ</span>
        <span class="k">if</span> <span class="n">commtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rmq&#39;</span><span class="p">,</span> <span class="s1">&#39;rmq_async&#39;</span><span class="p">]:</span>
            <span class="kn">from</span> <span class="nn">yggdrasil.communication.RMQComm</span> <span class="kn">import</span> <span class="n">check_rmq_server</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_rmq_server</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="ModelDriver.configure"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.configure">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Add configuration options for this language.</span>

<span class="sd">        Args:</span>
<span class="sd">            cfg (CisConfigParser): Config class that options should be set for.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            list: Section, option, description tuples for options that could not</span>
<span class="sd">                be set.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Section and executable</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)):</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="c1"># Executable type configuration</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">configure_executable_type</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="c1"># Locate executable</span>
        <span class="k">if</span> <span class="p">(((</span><span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_language_installed</span><span class="p">())</span>
             <span class="ow">and</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">executable_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))):</span>  <span class="c1"># pragma: debug</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exec_file</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language_executable</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">exec_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">locate_file</span><span class="p">(</span>
                        <span class="n">exec_file</span><span class="p">,</span> <span class="n">directory_list</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_executable_search_dirs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fpath</span><span class="p">:</span>
                        <span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">executable_type</span><span class="p">,</span> <span class="n">fpath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># Configure libraries</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">configure_libraries</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="c1"># Only do additional configuration if no base languages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">base_languages</span><span class="p">:</span>
            <span class="c1"># Installed comms</span>
            <span class="n">comms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">supported_comms</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_comm_installed</span><span class="p">(</span><span class="n">commtype</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span> <span class="n">skip_config</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">comms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="s1">&#39;commtypes&#39;</span><span class="p">,</span> <span class="n">comms</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">after_registration</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span> <span class="n">second_pass</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.configure_executable_type"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.configure_executable_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configure_executable_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Add configuration options specific in the executable type</span>
<span class="sd">        before the libraries are configured.</span>

<span class="sd">        Args:</span>
<span class="sd">            cfg (YggConfigParser): Config class that options should be set for.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            list: Section, option, description tuples for options that could not</span>
<span class="sd">                be set.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="ModelDriver.configure_libraries"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.configure_libraries">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configure_libraries</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Add configuration options for external libraries in this language.</span>

<span class="sd">        Args:</span>
<span class="sd">            cfg (YggConfigParser): Config class that options should be set for.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            list: Section, option, description tuples for options that could not</span>
<span class="sd">                be set.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="ModelDriver.get_io_env"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_io_env">[docs]</a>    <span class="k">def</span> <span class="nf">get_io_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_drivers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_drivers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get environment variables set by the input/output drivers.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_drivers (list, optional): Input drivers. Defaults to the</span>
<span class="sd">                yaml entry if not provided.</span>
<span class="sd">            output_drivers (list, optional): Output drivers. Defaults to the</span>
<span class="sd">                yaml entry if not provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Environment variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">input_drivers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_drivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_drivers&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">output_drivers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_drivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_drivers&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">copies</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">yggdrasil.drivers.DuplicatedModelDriver</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">DuplicatedModelDriver</span><span class="p">)</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">DuplicatedModelDriver</span><span class="o">.</span><span class="n">get_base_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">input_drivers</span> <span class="o">+</span> <span class="n">output_drivers</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;instance&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">model_env</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">model_env</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">model_env</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">model_env</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_env</span><span class="p">[</span><span class="n">base_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.set_env_class"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.set_env_class">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_env_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">existing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set environment variables that are instance independent.</span>

<span class="sd">        Args:</span>
<span class="sd">            existing (dict, optional): Existing dictionary of environment</span>
<span class="sd">                variables that new variables should be added to. Defaults</span>
<span class="sd">                to a copy of os.environ.</span>
<span class="sd">            **kwargs: Additional keyword arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Environment variables for the model process.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">existing</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">existing</span></div>

<div class="viewcode-block" id="ModelDriver.set_env"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.set_env">[docs]</a>    <span class="k">def</span> <span class="nf">set_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">existing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get environment variables that should be set for the model process.</span>

<span class="sd">        Args:</span>
<span class="sd">            existing (dict, optional): Existing dictionary of environment</span>
<span class="sd">                variables that new variables should be added to. Defaults</span>
<span class="sd">                to a copy of os.environ.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to set_env_class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Environment variables for the model process.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">yggdrasil.config</span> <span class="kn">import</span> <span class="n">ygg_cfg</span>
        <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">existing</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">))</span>
        <span class="n">existing</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_io_env</span><span class="p">())</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_env_class</span><span class="p">(</span><span class="n">existing</span><span class="o">=</span><span class="n">existing</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">YGG_SUBPROCESS</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
                   <span class="n">YGG_MODEL_INDEX</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_index</span><span class="p">),</span>
                   <span class="n">YGG_MODEL_LANGUAGE</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
                   <span class="n">YGG_MODEL_COPIES</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copies</span><span class="p">),</span>
                   <span class="c1"># YGG_PYTHON_EXEC=sys.executable,</span>
                   <span class="n">YGG_DEFAULT_COMM</span><span class="o">=</span><span class="n">tools</span><span class="o">.</span><span class="n">get_default_comm</span><span class="p">(),</span>
                   <span class="n">YGG_NCLIENTS</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">_on_mpi</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;YGG_MPI_RANK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">multitasking</span><span class="o">.</span><span class="n">_mpi_rank</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">copies</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">yggdrasil.drivers.DuplicatedModelDriver</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">DuplicatedModelDriver</span><span class="p">)</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;YGG_MODEL_COPY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_index</span><span class="p">)</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;YGG_MODEL_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DuplicatedModelDriver</span><span class="o">.</span><span class="n">get_base_name</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;YGG_MODEL_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_threading</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copies</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;YGG_THREADING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_server</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;YGG_SERVER_INPUT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_server</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;YGG_SERVER_OUTPUT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_server</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;YGG_MODEL_DEBUG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span>
        <span class="n">replace</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">replace</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;__COLON__&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ygg_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;general&#39;</span><span class="p">,</span> <span class="s1">&#39;allow_multiple_omp&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;KMP_DUPLICATE_LIB_OK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="k">return</span> <span class="n">env</span></div>

<div class="viewcode-block" id="ModelDriver.before_start"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.before_start">[docs]</a>    <span class="k">def</span> <span class="nf">before_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_queue_thread</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions to perform before the run starts.</span>

<span class="sd">        Args:</span>
<span class="sd">            no_queue_thread (bool, optional): If True, the queue_thread is not</span>
<span class="sd">                created/started. Defaults to False.</span>
<span class="sd">            **kwargs: Keyword arguments are pased to run_model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if multitasking._on_mpi:</span>
        <span class="c1">#     self.init_mpi_env()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Start thread to queue output</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_queue_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span> <span class="o">=</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">YggTaskLoop</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enqueue_output_loop</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.EnqueueLoop&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">_on_mpi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_mpi</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.queue_close"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.queue_close">[docs]</a>    <span class="k">def</span> <span class="nf">queue_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Close the queue for messages from the model process.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.queue_recv"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.queue_recv">[docs]</a>    <span class="k">def</span> <span class="nf">queue_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Receive a message from the model process.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.enqueue_output_loop"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.enqueue_output_loop">[docs]</a>    <span class="k">def</span> <span class="nf">enqueue_output_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Keep passing lines to queue.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_recv</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">set_break_flag</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exit_line</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">AliasDisconnectError</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Queue disconnected&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;End of model output&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue_close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Error in printing output: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.before_loop"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.before_loop">[docs]</a>    <span class="k">def</span> <span class="nf">before_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions before loop.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> with cwd </span><span class="si">%s</span><span class="s1"> and env </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">model_command</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span>
                   <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">))</span></div>

    <span class="c1"># def init_mpi_env(self):</span>
    <span class="c1">#     r&quot;&quot;&quot;Receive env information to the partner model.&quot;&quot;&quot;</span>
    <span class="c1">#     self.env = self.recv_mpi(tag=self._mpi_tags[&#39;ENV&#39;])</span>
        
<div class="viewcode-block" id="ModelDriver.init_mpi"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.init_mpi">[docs]</a>    <span class="k">def</span> <span class="nf">init_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize MPI communicator.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recv_mpi</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tags</span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_requests</span><span class="p">[</span><span class="s1">&#39;stopped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">MPIRequestWrapper</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recv_mpi</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tags</span><span class="p">[</span><span class="s1">&#39;STOP_RANKX&#39;</span><span class="p">],</span>
                              <span class="n">dont_block</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelDriver.send_mpi"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.send_mpi">[docs]</a>    <span class="k">def</span> <span class="nf">send_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dont_block</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Send an MPI message.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;send </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">) [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2"> (blocking=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tag</span> <span class="o">+</span> <span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mpi_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
                   <span class="n">msg</span><span class="p">,</span> <span class="ow">not</span> <span class="n">dont_block</span><span class="p">)</span>
        <span class="n">kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_partner_rank</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tag</span> <span class="o">+</span> <span class="n">tag</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">dont_block</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="c1"># return self._mpi_comm.isend(msg, **kws)</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Non-blocking MPI send not tested.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.recv_mpi"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.recv_mpi">[docs]</a>    <span class="k">def</span> <span class="nf">recv_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dont_block</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Receive an MPI message.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;recv </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">) [</span><span class="si">%s</span><span class="s1">] (blocking=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tag</span> <span class="o">+</span> <span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_mpi_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
                   <span class="ow">not</span> <span class="n">dont_block</span><span class="p">)</span>
        <span class="n">kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_partner_rank</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tag</span> <span class="o">+</span> <span class="n">tag</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">dont_block</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span><span class="o">.</span><span class="n">irecv</span><span class="p">(</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.stop_mpi_partner"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.stop_mpi_partner">[docs]</a>    <span class="k">def</span> <span class="nf">stop_mpi_partner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Send a message to stop the MPI partner model on the main process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mpi_request</span><span class="p">(</span><span class="s1">&#39;stopping&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_tags</span><span class="p">[</span><span class="s1">&#39;STOP_RANK0&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_process_returncode</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;ERROR&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;STOPPING&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;stop_mpi_partner: </span><span class="si">%d</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="c1"># Don&#39;t call test()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_requests</span><span class="p">[</span><span class="s1">&#39;stopping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">MPIRequestWrapper</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_mpi</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">),</span> <span class="n">completed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.wait_on_mpi_request"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.wait_on_mpi_request">[docs]</a>    <span class="k">def</span> <span class="nf">wait_on_mpi_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Wait for a request to be completed.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name that request was registered under.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool, str: Received message or False if the request does not</span>
<span class="sd">                exist or is not complete.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting on &#39;</span><span class="si">%s</span><span class="s2">&#39; (timeout=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_requests</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Timeout for MPI &#39;</span><span class="si">%s</span><span class="s2">&#39; request&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.check_mpi_request"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.check_mpi_request">[docs]</a>    <span class="k">def</span> <span class="nf">check_mpi_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Check if a request has been completed.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name that request was registered under.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool, str: Received message or False if the request does not</span>
<span class="sd">                exist or is not complete.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_comm</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_requests</span><span class="p">):</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_requests</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">and</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">):</span>  <span class="c1"># pragma: debug</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ModelDriver.set_break_flag"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.set_break_flag">[docs]</a>    <span class="k">def</span> <span class="nf">set_break_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Stop the model loop.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_mpi_partner</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_break_flag</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.run_loop"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.run_loop">[docs]</a>    <span class="k">def</span> <span class="nf">run_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Loop to check if model is still running and forward output.&quot;&quot;&quot;</span>
        <span class="c1"># Continue reading until there is not any output</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_process_returncode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_process_returncode</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mpi_request</span><span class="p">(</span><span class="s1">&#39;stopped&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stop requested by MPI partner.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_break_flag</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="c1"># This sleep is necessary to allow changes in queue without lock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">multitasking</span><span class="o">.</span><span class="n">AliasDisconnectError</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Queue disconnected&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_break_flag</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exit_line</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mpi_request</span><span class="p">(</span><span class="s1">&#39;stopped&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No more output&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_break_flag</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_encoded</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.run_finally"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.run_finally">[docs]</a>    <span class="k">def</span> <span class="nf">run_finally</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions to perform in finally clause of try/except wrapping</span>
<span class="sd">        run.&quot;&quot;&quot;</span>
        <span class="c1"># Ensure the MPI partner gets cleaned up following an error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_mpi_partner</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_finally</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.after_loop"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.after_loop">[docs]</a>    <span class="k">def</span> <span class="nf">after_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions to perform after run_loop has finished. Mainly checking</span>
<span class="sd">        if there was an error and then handling it.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleeptime</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Queue thread still alive&quot;</span><span class="p">)</span>
                <span class="c1"># Loop was broken from outside, kill the queueing thread</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kill_process</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">key_suffix</span><span class="o">=</span><span class="s1">&#39;.after_loop&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kill_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span><span class="s2">&quot;Closing input/output drivers:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">input: </span><span class="si">%s</span><span class="se">\n\t</span><span class="s2">output: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
                   <span class="o">%</span> <span class="p">([</span><span class="n">drv</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">drv</span> <span class="ow">in</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_drivers&#39;</span><span class="p">,</span> <span class="p">[])],</span>
                      <span class="p">[</span><span class="n">drv</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">drv</span> <span class="ow">in</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_drivers&#39;</span><span class="p">,</span> <span class="p">[])]))</span>
        <span class="k">for</span> <span class="n">drv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_drivers&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="s1">&#39;instance&#39;</span> <span class="ow">in</span> <span class="n">drv</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;mpi&#39;</span><span class="p">:</span>
                    <span class="n">drv</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">drv</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">on_model_exit</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                              <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">drv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_drivers&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="s1">&#39;instance&#39;</span> <span class="ow">in</span> <span class="n">drv</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;mpi&#39;</span><span class="p">:</span>
                    <span class="n">drv</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">drv</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">on_model_exit</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                              <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">io_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;list: Errors produced by input/output drivers to this model.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">drv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_drivers&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="s1">&#39;instance&#39;</span> <span class="ow">in</span> <span class="n">drv</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="n">drv</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">errors</span>
        <span class="k">for</span> <span class="n">drv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_drivers&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="s1">&#39;instance&#39;</span> <span class="ow">in</span> <span class="n">drv</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="n">drv</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">errors</span>
        <span class="k">return</span> <span class="n">errors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_process_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;bool: Has the process finished or not. Returns True if the process</span>
<span class="sd">        has not started.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_process</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_process_returncode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;int: Return code for the model process where non-zero values</span>
<span class="sd">        indicate that there was an error.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_process_complete</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_process</span><span class="o">.</span><span class="n">returncode</span>
        <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="ModelDriver.wait_process"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.wait_process">[docs]</a>    <span class="k">def</span> <span class="nf">wait_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key_suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Wait for some amount of time for the process to finish.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout (float, optional): Time (in seconds) that should be waited.</span>
<span class="sd">                Defaults to None and is infinite.</span>
<span class="sd">            key (str, optional): Key that should be used to register the timeout.</span>
<span class="sd">                Defaults to None and set based on the stack trace.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the process completed. False otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_started</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_on_function</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_process_complete</span><span class="p">,</span>
                                     <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">key_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                     <span class="n">key_suffix</span><span class="o">=</span><span class="n">key_suffix</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.kill_process"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.kill_process">[docs]</a>    <span class="k">def</span> <span class="nf">kill_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Kill the process running the model, checking return code.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_started</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Process was never started.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_break_flag</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_process_kill_called</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_process_kill_complete</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_process_kill_called</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>  <span class="c1"># pragma: debug</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Process has already been killed.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_process_kill_called</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ignore_error_code</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_process_complete</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Process is still running. Killing it.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model_process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting </span><span class="si">%f</span><span class="s2"> s for process to be killed&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">key_suffix</span><span class="o">=</span><span class="s1">&#39;.kill_process&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error killing model process&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_sent_messages</span><span class="p">:</span>
                    <span class="n">ignore_error_code</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_process_complete</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">model_process_returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                 <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ignore_error_code</span><span class="p">))):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">((</span><span class="s2">&quot;return code of </span><span class="si">%s</span><span class="s2"> indicates model error. &quot;</span>
                            <span class="s2">&quot;(sent messages: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">),</span>
                           <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_process_returncode</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_process_kill_complete</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_break</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                    <span class="c1"># Wait for messages to be printed</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for queue_thread to finish up.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>  <span class="c1"># pragma: debug</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting break flag for queue_thread to finish up.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">set_break_flag</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">queue_close</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Closed during concurrent action&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>  <span class="c1"># pragma: debug</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Queue thread was not terminated.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.graceful_stop"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.graceful_stop">[docs]</a>    <span class="k">def</span> <span class="nf">graceful_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Gracefully stop the driver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_sent_messages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">key_suffix</span><span class="o">=</span><span class="s1">&#39;.graceful_stop&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">graceful_stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.cleanup_products"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.cleanup_products">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_products</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Remove products created in order to run the model.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">preserve_cache</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_products</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore_files</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.cleanup"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Remove compile executable.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_products</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.restore_files"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.restore_files">[docs]</a>    <span class="k">def</span> <span class="nf">restore_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Restore modified files to their original form.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">modified</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">original</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">modified</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">modified</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.remove_products"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.remove_products">[docs]</a>    <span class="k">def</span> <span class="nf">remove_products</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Delete products produced during the process of running the model.&quot;&quot;&quot;</span>
        <span class="n">products</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">products</span>
        <span class="n">source_products</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_products</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrapper_products</span>
        <span class="n">remove_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">source_products</span><span class="p">,</span> <span class="n">timer_class</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="ModelDriver.cleanup_dependencies"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.cleanup_dependencies">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">cleanup_dependencies</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">products</span><span class="o">=</span><span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Cleanup dependencies.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>
                
    <span class="c1"># Methods for automated model wrapping</span>
<div class="viewcode-block" id="ModelDriver.run_code"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.run_code">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">run_code</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">process_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run code by first writing it as an executable and then calling</span>
<span class="sd">        the driver.</span>

<span class="sd">        Args:</span>
<span class="sd">            lines (list): Lines of code to be wrapped as an executable.</span>
<span class="sd">            process_kwargs (dict, optional): Keyword arguments that should</span>
<span class="sd">                be passed to run_model. Defaults to {}.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to the</span>
<span class="sd">                write_executable method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;test_code_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">13</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">code_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
        <span class="c1"># code_dir = working_dir</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_language_ext</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_executable</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">fname</span><span class="p">],</span> <span class="n">working_dir</span><span class="o">=</span><span class="n">working_dir</span><span class="p">)</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="n">return_process</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">process_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed generated code:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">inst</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDriver.format_function_param"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.format_function_param">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">format_function_param</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">ignore_method</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the formatted version of the specified key.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): Key in cls.function_param mapping that should be</span>
<span class="sd">                formatted.</span>
<span class="sd">            default (str, optional): Format that should be returned if key</span>
<span class="sd">                is not in cls.function_param. Defaults to None.</span>
<span class="sd">            replacement (str, optional): Format that should be used instead</span>
<span class="sd">                of the one in cls.function_param. Defaults to None.</span>
<span class="sd">            **kwargs: Additional keyword arguments are used in formatting the</span>
<span class="sd">                request function parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Formatted string.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If key is not in cls.function_param and default</span>
<span class="sd">                is not set.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">replacement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">replacement</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ignore_method</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;format_function_param_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;format_function_param_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">((</span><span class="s2">&quot;Language </span><span class="si">%s</span><span class="s2"> dosn&#39;t have an entry in &quot;</span>
                                           <span class="s2">&quot;function_param for key &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                                          <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.parse_var_definition"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.parse_var_definition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_var_definition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Extract information about input/output variables from a</span>
<span class="sd">        string definition.</span>

<span class="sd">        Args:</span>
<span class="sd">            io (str): Description of variables contained in the provided</span>
<span class="sd">                string. Must be &#39;inputs&#39; or &#39;outputs&#39;.</span>
<span class="sd">            value (str): String containing one or more variable definitions.</span>
<span class="sd">            outputs_in_inputs (bool, optional): If True, the outputs are</span>
<span class="sd">                presented in the function definition as inputs. Defaults</span>
<span class="sd">                to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of information about the variables contained in</span>
<span class="sd">                the provided string.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If io is not &#39;inputs&#39; or &#39;outputs&#39;.</span>
<span class="sd">            NotImplementedError: If the def_regex for the specified</span>
<span class="sd">                io is not defined.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outputs_in_inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">outputs_in_inputs</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">io</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_def_regex&#39;</span> <span class="o">%</span> <span class="n">io</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">_def_regex&#39; not defined for &quot;</span>
                 <span class="s2">&quot;language </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;multiple_outputs&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
            <span class="n">multi_re</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;multiple_outputs&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;[]()&#39;</span><span class="p">:</span>
                <span class="n">multi_re</span> <span class="o">=</span> <span class="n">multi_re</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">multi_re</span> <span class="o">=</span> <span class="n">multi_re</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outputs</span><span class="o">=</span><span class="s1">&#39;(.*?)&#39;</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">multi_re</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">io_re</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_def_regex&#39;</span> <span class="o">%</span> <span class="n">io</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">split_variables</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
            <span class="n">igrp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">ivar</span><span class="p">}</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">io_re</span><span class="p">,</span> <span class="n">ivar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">igrp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">igrp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">igrp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">igrp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;native_type&#39;</span> <span class="ow">in</span> <span class="n">igrp</span><span class="p">:</span>
                <span class="n">igrp</span><span class="p">[</span><span class="s1">&#39;native_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">igrp</span><span class="p">[</span><span class="s1">&#39;native_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">igrp</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_json_type</span><span class="p">(</span><span class="n">igrp</span><span class="p">[</span><span class="s1">&#39;native_type&#39;</span><span class="p">])</span>
            <span class="n">igrp</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">==</span> <span class="s1">&#39;outputs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outputs_in_inputs</span><span class="p">:</span>
                <span class="n">igrp</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">input2output</span><span class="p">(</span><span class="n">igrp</span><span class="p">)</span>
            <span class="n">new_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">igrp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_val</span></div>

<div class="viewcode-block" id="ModelDriver.parse_function_definition"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.parse_function_definition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_function_definition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_file</span><span class="p">,</span> <span class="n">model_function</span><span class="p">,</span>
                                  <span class="n">contents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">expected_outputs</span><span class="o">=</span><span class="p">[],</span> <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get information about the inputs &amp; outputs to a model from its</span>
<span class="sd">        defintition if possible.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_file (str): Full path to the file containing the model</span>
<span class="sd">                function&#39;s declaration.</span>
<span class="sd">            model_function (str): Name of the model function.</span>
<span class="sd">            contents (str, optional): String containing the function definition.</span>
<span class="sd">                If not provided, the function definition is read from model_file.</span>
<span class="sd">            match (re.Match, optional): Match object for the function regex. If</span>
<span class="sd">                not provided, a search is performed using function_def_regex.</span>
<span class="sd">            expected_outputs (list, optional): List of names or variable</span>
<span class="sd">                information dictionaries for outputs that are expected</span>
<span class="sd">                to be extracted from the function&#39;s definition. This</span>
<span class="sd">                variable is only used if outputs_in_inputs is True and</span>
<span class="sd">                outputs are not extracted from the function&#39;s defintion</span>
<span class="sd">                using the regex for this language. Defaults to [].</span>
<span class="sd">            outputs_in_inputs (bool, optional): If True, the outputs are</span>
<span class="sd">                presented in the function definition as inputs. Defaults</span>
<span class="sd">                to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Parameters extracted from the function definitions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outputs_in_inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">outputs_in_inputs</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;function_def_regex&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">function_regex</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;function_def_regex&#39;</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="n">model_function</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">contents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                        <span class="n">contents</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">function_regex</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">((</span><span class="s2">&quot;Could not find function match in file:</span><span class="se">\n</span><span class="s2">&quot;</span>
                                        <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">for regex:</span><span class="se">\n</span><span class="s2">r&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                                       <span class="o">%</span> <span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">contents</span><span class="p">),</span> <span class="n">function_regex</span><span class="p">))</span>
                <span class="c1"># Match brackets to determine where the function definition is</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">brackets</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">brackets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">brackets</span><span class="p">}</span>
                    <span class="n">first_zero</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">re_brackets</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[\</span><span class="si">%s</span><span class="s1">\</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">brackets</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">re_brackets</span><span class="p">,</span> <span class="n">contents</span><span class="p">):</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="p">(((</span><span class="n">counts</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">brackets</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                             <span class="ow">and</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">brackets</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                  <span class="o">==</span> <span class="n">counts</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">brackets</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))):</span>
                            <span class="n">first_zero</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">break</span>
                    <span class="k">assert</span><span class="p">((</span><span class="n">first_zero</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">first_zero</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)))</span>
                    <span class="c1"># This is currently commented as regex&#39;s are</span>
                    <span class="c1"># sufficient so far, but this may be needed in the</span>
                    <span class="c1"># future to isolate single definitions.</span>
                    <span class="c1"># if (first_zero != 0) and first_zero != len(contents):</span>
                    <span class="c1">#     contents = contents[:first_zero]</span>
                    <span class="c1">#     match = re.search(function_regex, contents)</span>
                    <span class="c1">#     assert(match)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">io</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">io</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">io</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_var_definition</span><span class="p">(</span>
                        <span class="n">io</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="n">io</span><span class="p">],</span> <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="n">outputs_in_inputs</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;model_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_file</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span> <span class="ow">and</span> <span class="n">expected_outputs</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="n">missing_expected_outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">expected_outputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">missing_expected_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing_expected_outputs</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">missing_expected_outputs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">input2output</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">missing_expected_outputs</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Could not locate </span><span class="si">%d</span><span class="s2"> output &quot;</span>
                                  <span class="s2">&quot;variable(s) in input:  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_expected_outputs</span><span class="p">),</span>
                                    <span class="n">missing_expected_outputs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]:</span>
                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_var&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">flag_var</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">out</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;flag_var&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;flag&#39;</span><span class="p">}}</span>
            <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">flag_var</span><span class="p">[</span><span class="s1">&#39;native_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;flag_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">flag_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_json_type</span><span class="p">(</span><span class="n">flag_var</span><span class="p">[</span><span class="s1">&#39;native_type&#39;</span><span class="p">])</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;flag_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag_var</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">check_flag_var</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="n">outputs_in_inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.check_flag_var"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.check_flag_var">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">check_flag_var</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Check if the flag variable should be treated as an output.</span>

<span class="sd">        Args:</span>
<span class="sd">            info (dict): Information about the function.</span>
<span class="sd">            outputs_in_inputs (bool, optional): If True, the outputs are</span>
<span class="sd">                presented in the function definition as inputs. Defaults</span>
<span class="sd">                to False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="n">outputs_in_inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">outputs_in_inputs</span>
        <span class="n">flag_t</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">type_map</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_var&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;native_type&#39;</span><span class="p">,</span> <span class="n">flag_t</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flag_t</span><span class="p">)</span>
             <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">outputs_in_inputs</span><span class="p">))):</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="p">[]):</span>  <span class="c1"># pragma: debug</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Support for returning outputs via parameter(s) &quot;</span>
                            <span class="s2">&quot;and return value is not yet support. The return &quot;</span>
                            <span class="s2">&quot;value will be assumed to be a flag indicating &quot;</span>
                            <span class="s2">&quot;the success of the model.&quot;</span><span class="p">)</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;outputs_in_inputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;flag_var&#39;</span><span class="p">)]</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;outputs_in_inputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ModelDriver.channels2vars"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.channels2vars">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">channels2vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">channels</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Convert a list of channels to a list of variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            channels (list): List of channel dictionaries.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">channels</span><span class="p">]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span>
        
        <span class="k">def</span> <span class="nf">get_pos</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">variables</span></div>

<div class="viewcode-block" id="ModelDriver.expand_server_io"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.expand_server_io">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">expand_server_io</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">client_comms</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update inputs/outputs w/ information about server that will be</span>
<span class="sd">        using them.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs (list): List of model inputs including types.</span>
<span class="sd">            outputs (list): List of model outputs including types.</span>
<span class="sd">            client_comms (list, optional): List of the names of client comms</span>
<span class="sd">                that should be removed from the list of outputs. Defaults to [].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">client_comms</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;When wrapping a model function, client comms &quot;</span>
                          <span class="s2">&quot;must either be initialized outside the function, &quot;</span>
                          <span class="s2">&quot;pass a &#39;global_scope&#39; parameter to the &quot;</span>
                          <span class="s2">&quot;comm initialization (e.g. Python, R, Matlab), &quot;</span>
                          <span class="s2">&quot;or use a &#39;WITH_GLOBAL_SCOPE&#39; macro &quot;</span>
                          <span class="s2">&quot;(e.g. C, C++, Fortran) around the initialization &quot;</span>
                          <span class="s2">&quot;so that they are persistent &quot;</span>
                          <span class="s2">&quot;across calls and the call or recv/send methods &quot;</span>
                          <span class="s2">&quot;must be called explicitly (as opposed to the &quot;</span>
                          <span class="s2">&quot;function inputs/outputs which will be handled &quot;</span>
                          <span class="s2">&quot;by the wrapper). This model&#39;s client comms are:</span><span class="se">\n</span><span class="s2">&quot;</span>
                          <span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">client_comms</span><span class="p">)</span>
        <span class="c1"># Replace server input w/ split input/output and remove client</span>
        <span class="c1"># connections from inputs</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;server_replaces&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;server_replaces&#39;</span><span class="p">][</span><span class="s1">&#39;input_index&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;server_replaces&#39;</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">])</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;server_replaces&#39;</span><span class="p">][</span><span class="s1">&#39;output_index&#39;</span><span class="p">],</span>
                               <span class="n">x</span><span class="p">[</span><span class="s1">&#39;server_replaces&#39;</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">])</span>
        <span class="n">rm_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">client_comms</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rm_outputs</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.preparse_function"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.preparse_function">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">preparse_function</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">yml</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Extract information about inputs and outputs based on the</span>
<span class="sd">        function being wrapped.</span>

<span class="sd">        Args:</span>
<span class="sd">            yml (dict): Options that will be used to initialize the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Information about the parsed function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;function&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yml</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_server&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">yml</span><span class="p">[</span><span class="s1">&#39;is_server&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Language </span><span class="si">%s</span><span class="s2"> is not parameterized &quot;</span>
                              <span class="s2">&quot;and so functions cannot be automatically &quot;</span>
                              <span class="s2">&quot;wrapped as a model.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">source_files</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">identify_source_files</span><span class="p">(</span><span class="o">**</span><span class="n">yml</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_files</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not identify any source files.&quot;</span><span class="p">)</span>
        <span class="n">model_function_file</span> <span class="o">=</span> <span class="n">source_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">model_function_file</span><span class="p">):</span>  <span class="c1"># pragma: debug</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source file does not exist: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                             <span class="o">%</span> <span class="n">model_function_file</span><span class="p">)</span>
        
        <span class="c1"># Update input/outputs based on parsed source code</span>
        <span class="n">client_comms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yml</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;client_of&#39;</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="n">model_function_inputs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">model_function_outputs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">expand_server_io</span><span class="p">(</span>
            <span class="n">model_function_inputs</span><span class="p">,</span> <span class="n">model_function_outputs</span><span class="p">,</span>
            <span class="n">client_comms</span><span class="o">=</span><span class="n">client_comms</span><span class="p">)</span>
        <span class="n">expected_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">model_function_outputs</span><span class="p">:</span>
            <span class="n">expected_outputs</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">model_outputs_in_inputs</span> <span class="o">=</span> <span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outputs_in_inputs&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">model_function_info</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_function_definition</span><span class="p">(</span>
            <span class="n">model_function_file</span><span class="p">,</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">],</span>
            <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span>
            <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="n">model_outputs_in_inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_outputs_in_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_outputs_in_inputs</span> <span class="o">=</span> <span class="n">model_function_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;outputs_in_inputs&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">model_flag</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">update_io_from_function</span><span class="p">(</span>
            <span class="n">model_function_info</span><span class="p">,</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">],</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">model_function_inputs</span><span class="p">,</span>
            <span class="n">outputs</span><span class="o">=</span><span class="n">model_function_outputs</span><span class="p">,</span>
            <span class="n">iter_function_over</span><span class="o">=</span><span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;iter_function_over&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;preparsed_function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model_file&#39;</span><span class="p">:</span> <span class="n">model_function_info</span><span class="p">,</span>
            <span class="s1">&#39;model_function&#39;</span><span class="p">:</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">],</span>
            <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="n">model_function_inputs</span><span class="p">,</span>
            <span class="s1">&#39;outputs&#39;</span><span class="p">:</span> <span class="n">model_function_outputs</span><span class="p">,</span>
            <span class="s1">&#39;model_flag&#39;</span><span class="p">:</span> <span class="n">model_flag</span><span class="p">,</span>
            <span class="s1">&#39;outputs_in_inputs&#39;</span><span class="p">:</span> <span class="n">model_outputs_in_inputs</span><span class="p">,</span>
            <span class="s1">&#39;copies&#39;</span><span class="p">:</span> <span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;copies&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;iter_function_over&#39;</span><span class="p">:</span> <span class="n">yml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;iter_function_over&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s1">&#39;skip_update_io&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">yml</span><span class="p">[</span><span class="s1">&#39;preparsed_function&#39;</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="ModelDriver.update_io_from_function"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.update_io_from_function">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">update_io_from_function</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_file</span><span class="p">,</span> <span class="n">model_function</span><span class="p">,</span>
                                <span class="n">inputs</span><span class="o">=</span><span class="p">[],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[],</span> <span class="n">contents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iter_function_over</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update inputs/outputs from the function definition.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_file (str): Full path to the file containing the model</span>
<span class="sd">                function&#39;s declaration.</span>
<span class="sd">            model_function (str): Name of the model function.</span>
<span class="sd">            inputs (list, optional): List of model inputs including types.</span>
<span class="sd">                Defaults to [].</span>
<span class="sd">            outputs (list, optional): List of model outputs including types.</span>
<span class="sd">                Defaults to [].</span>
<span class="sd">            contents (str, optional): Contents of file to parse rather than</span>
<span class="sd">                re-reading the file. Defaults to None and is ignored.</span>
<span class="sd">            outputs_in_inputs (bool, optional): If True, the outputs are</span>
<span class="sd">                presented in the function definition as inputs. Defaults</span>
<span class="sd">                to False.</span>
<span class="sd">            iter_function_over (array, optional): Variable(s) that should be</span>
<span class="sd">                received or sent as an array, but iterated over. Defaults to</span>
<span class="sd">                an empty array and is ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict, None: Flag variable used by the model. If None, the</span>
<span class="sd">                model does not use a flag variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read info from the source code</span>
        <span class="k">if</span> <span class="p">(((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">model_file</span><span class="p">))</span>
             <span class="ow">or</span> <span class="p">(</span><span class="n">contents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))):</span>  <span class="c1"># pragma: debug</span>
            <span class="n">expected_outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="n">expected_outputs</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_function_definition</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">model_function</span><span class="p">,</span>
                                                 <span class="n">contents</span><span class="o">=</span><span class="n">contents</span><span class="p">,</span>
                                                 <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The new execution pattern reuses the parsed &quot;</span>
                        <span class="s2">&quot;source code parameters. Double check results:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">.&quot;</span>
                        <span class="o">%</span> <span class="n">pformat</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">model_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="n">outputs_in_inputs</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outputs_in_inputs&#39;</span><span class="p">,</span>
                                         <span class="bp">cls</span><span class="o">.</span><span class="n">outputs_in_inputs</span><span class="p">)</span>
        <span class="n">info_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">io</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="p">[])])</span>
                    <span class="k">for</span> <span class="n">io</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">]}</span>
        <span class="c1"># Determine flag variable</span>
        <span class="n">flag_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_var&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">flag_var</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;flag_var&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;model_flag&#39;</span><span class="p">)</span>
        <span class="c1"># Check for vars matching names of input/output channels</span>
        <span class="k">for</span> <span class="n">io</span><span class="p">,</span> <span class="n">io_var</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">==</span> <span class="s1">&#39;outputs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outputs_in_inputs</span><span class="p">:</span>
                <span class="n">io_map</span> <span class="o">=</span> <span class="n">info_map</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">io_map</span> <span class="o">=</span> <span class="n">info_map</span><span class="p">[</span><span class="n">io</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">io_var</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">continue</span>
                <span class="n">var_name</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">io_map</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;ndim&#39;</span><span class="p">]:</span>
                        <span class="n">kvar</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_var&#39;</span> <span class="o">%</span> <span class="n">k</span>
                        <span class="k">if</span> <span class="n">kvar</span> <span class="ow">in</span> <span class="n">io_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">]:</span>
                            <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">io_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="n">kvar</span><span class="p">])</span>
        <span class="c1"># Move variables if outputs in inputs</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((((</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="p">[])))</span>
                 <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vdict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)]):</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">vdict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]])</span>
                    <span class="k">assert</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="n">vdict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vdict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">):]):</span>
                    <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">vdict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]])</span>
                    <span class="k">assert</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="n">vdict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[])):</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">info_map</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
                        <span class="n">info_map</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">input2output</span><span class="p">(</span>
                            <span class="n">info_map</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">io</span><span class="p">,</span> <span class="n">io_var</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">io_var</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="s1">&#39;channel_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">x</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_channel&#39;</span> <span class="o">%</span> <span class="n">io</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[])):</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">info_map</span><span class="p">[</span><span class="n">io</span><span class="p">]:</span>
                        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_map</span><span class="p">[</span><span class="n">io</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">io_var</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">info_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">io_var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">info_map</span><span class="p">[</span><span class="n">io</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">io_var</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;vars&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">v</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]}</span>
            <span class="c1"># Check for user defined length variables and add flag to</span>
            <span class="c1"># length variables</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">io_var</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;ndim&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="n">v</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_map</span><span class="p">[</span><span class="n">io</span><span class="p">][</span><span class="n">v</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span><span class="p">]]</span>
                            <span class="c1"># v[k + &#39;_var&#39;][&#39;is_&#39; + k + &#39;_var&#39;] = True</span>
                            <span class="n">v</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span><span class="p">][</span><span class="s1">&#39;is_length_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">v</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Update datatypes</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_typed</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">io_var</span><span class="p">:</span>
                    <span class="n">non_length</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_length_var&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">non_length</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                         <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_default_typedef</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">])))):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">non_length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">non_length</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># TODO: Remove types associated with length?</span>
                            <span class="k">assert</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">)</span>
                            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">])</span>
                                   <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_length</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">non_length</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">]):</span>
                                <span class="n">v</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">non_length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_length</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">non_length</span><span class="p">]}</span>
                        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;from_function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s1">&#39;native_type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="n">v</span><span class="p">[</span><span class="s1">&#39;native_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_native_type</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span>
            <span class="c1"># Update types based on iteration</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">io_var</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">iter_function_over</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="s1">&#39;iter_datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="p">{}))</span>
                        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="p">{}):</span>
                            <span class="k">assert</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;scalar&#39;</span><span class="p">)</span>
                            <span class="n">v</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1darray&#39;</span>
                            <span class="n">v</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;native_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">v</span><span class="p">[</span><span class="s1">&#39;native_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_native_type</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span>
        <span class="c1"># Finalize io variables</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">finalize_function_io</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">finalize_function_io</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flag_var</span></div>

<div class="viewcode-block" id="ModelDriver.finalize_function_io"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.finalize_function_io">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">finalize_function_io</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Finalize info for an input/output channel following function</span>
<span class="sd">        parsing.</span>

<span class="sd">        Args:</span>
<span class="sd">            direction (str): Direction of channel (&#39;input&#39; or &#39;output&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="ModelDriver.write_model_wrapper"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_model_wrapper">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_model_wrapper</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_file</span><span class="p">,</span> <span class="n">model_function</span><span class="p">,</span>
                            <span class="n">inputs</span><span class="o">=</span><span class="p">[],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copies</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">iter_function_over</span><span class="o">=</span><span class="p">[],</span> <span class="n">verbose_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">skip_update_io</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the lines required to wrap a model function as an integrated</span>
<span class="sd">        model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_file (str): Full path to the file containing the model</span>
<span class="sd">                function&#39;s declaration.</span>
<span class="sd">            model_function (str): Name of the model function.</span>
<span class="sd">            inputs (list, optional): List of model inputs including types.</span>
<span class="sd">                Defaults to [].</span>
<span class="sd">            outputs (list, optional): List of model outputs including types.</span>
<span class="sd">                Defaults to [].</span>
<span class="sd">            model_flag (dict, optional): Information about the flag that</span>
<span class="sd">                should be used to track the success of yggdrasil send/recv</span>
<span class="sd">                calls. This should only be provided if update_io_from_function</span>
<span class="sd">                has already been called. Defaults to None and is determined</span>
<span class="sd">                by update_io_from_function.</span>
<span class="sd">            outputs_in_inputs (bool, optional): If True, the outputs are</span>
<span class="sd">                presented in the function definition as inputs. Defaults</span>
<span class="sd">                to the class attribute outputs_in_inputs.</span>
<span class="sd">            verbose (bool, optional): If True, the contents of the created file</span>
<span class="sd">                are displayed. Defaults to False.</span>
<span class="sd">            copies (int, optional): Number of times the model driver is</span>
<span class="sd">                duplicated. If more than one, no error will be raised in the</span>
<span class="sd">                event there is never a call the the function. Defaults to 1.</span>
<span class="sd">            iter_function_over (array, optional): Variable(s) that should be</span>
<span class="sd">                received or sent as an array, but iterated over. Defaults to</span>
<span class="sd">                an empty array and is ignored.</span>
<span class="sd">            skip_update_io (bool, optional): If True, update_io_from_function</span>
<span class="sd">                will not be called. Defaults to False.</span>
<span class="sd">            verbose_model (bool, optional): If True, print statements will</span>
<span class="sd">                be added after every line in the model. Defaults to False.</span>
<span class="sd">            model_name (str, optional): Name given to the model. Defaults to</span>
<span class="sd">                None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines of code wrapping the provided model with the necessary</span>
<span class="sd">                code to run it as part of an integration.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outputs_in_inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">outputs_in_inputs</span>
        <span class="c1"># TODO: Determine how to encode dependencies on external variables in models</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;function_param attribute not set for&quot;</span>
                                      <span class="s2">&quot;language &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="c1"># Update types based on the function definition for typed languages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_update_io</span><span class="p">:</span>
            <span class="n">model_flag</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">update_io_from_function</span><span class="p">(</span>
                <span class="n">model_file</span><span class="p">,</span> <span class="n">model_function</span><span class="p">,</span>
                <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
                <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="n">outputs_in_inputs</span><span class="p">,</span>
                <span class="n">iter_function_over</span><span class="o">=</span><span class="n">iter_function_over</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">model_file</span> <span class="o">=</span> <span class="n">model_file</span><span class="p">[</span><span class="s1">&#39;model_file&#39;</span><span class="p">]</span>
        <span class="c1"># Update types based on iteration</span>
        <span class="n">iter_function_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">iter_ivars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iter_ovars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">iter_function_over</span><span class="p">:</span>
            <span class="n">iter_function_idx</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;idx_func_iter&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">}}</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">zero_based</span><span class="p">:</span>
                <span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">iter_ivars</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
                               <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">iter_function_over</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">iter_ivars</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The iter_function_over model &quot;</span>
                                   <span class="s2">&quot;parameter must include an input to &quot;</span>
                                   <span class="s2">&quot;iterate over. To expand output arrays &quot;</span>
                                   <span class="s2">&quot;into component elements, use the &quot;</span>
                                   <span class="s2">&quot;&#39;iterate&#39; transformation.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="n">iter_ovars</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
                               <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">iter_function_over</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">iter_ivars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;length_var&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter_ivars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;length_var&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iter_ovars</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="s1">&#39;length_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter_ivars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;length_var&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;len&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">iter_ivars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">extra</span><span class="o">=</span><span class="n">iter_ivars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iter_ivars</span> <span class="o">+</span> <span class="n">iter_ovars</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="s1">&#39;iter_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter_function_idx</span>
        <span class="c1"># Declare variables and flag, then define flag</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">flag_var</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;flag&#39;</span><span class="p">}}</span>
        <span class="n">iter_var</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;first_iter&#39;</span><span class="p">,</span> <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;flag&#39;</span><span class="p">}}</span>
        <span class="n">free_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">definitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;declare&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="o">+</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_channel_decl</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                    <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span><span class="n">flag_var</span><span class="p">,</span>
                                           <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                                           <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span><span class="n">iter_var</span><span class="p">,</span>
                                           <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                                           <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_flag</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                    <span class="n">model_flag</span><span class="p">,</span> <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                    <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iter_function_idx</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                    <span class="n">iter_function_idx</span><span class="p">,</span> <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                    <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="o">+</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]):</span>
                    <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                        <span class="n">v</span><span class="p">,</span> <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                        <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="n">definitions</span>
        <span class="n">nline_preamble</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
            <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">flag_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;true_flag&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">])))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
            <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">iter_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;true_flag&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">])))</span>
        <span class="c1"># Declare/define input and output channels</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_channel_def</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span>
                                           <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">,</span> <span class="o">**</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_channel_def</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                           <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">,</span> <span class="o">**</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># Receive inputs before loop</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outside_loop&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_model_recv</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span>
                                              <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">)</span>
        <span class="c1"># Loop</span>
        <span class="n">loop_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Receive inputs</span>
        <span class="n">any_loop_inputs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">loop_iter_var</span> <span class="o">=</span> <span class="n">iter_var</span>
        <span class="k">if</span> <span class="n">copies</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">loop_iter_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outside_loop&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">any_loop_inputs</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">loop_lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_model_recv</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span>
                                                   <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">,</span>
                                                   <span class="n">iter_var</span><span class="o">=</span><span class="n">loop_iter_var</span><span class="p">,</span>
                                                   <span class="n">allow_failure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Prepare output array</span>
        <span class="k">if</span> <span class="n">iter_function_over</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iter_ivars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">iter_function_over</span><span class="p">:</span>
                    <span class="n">loop_lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_finalize_iiter</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iter_ovars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">iter_function_over</span><span class="p">:</span>
                    <span class="n">loop_lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_initialize_oiter</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="c1"># Call model</span>
        <span class="n">loop_lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_model_function_call</span><span class="p">(</span>
            <span class="n">model_function</span><span class="p">,</span> <span class="n">model_flag</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span>
            <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="n">outputs_in_inputs</span><span class="p">,</span>
            <span class="n">iter_function_idx</span><span class="o">=</span><span class="n">iter_function_idx</span><span class="p">)</span>
        <span class="c1"># Finalize output array</span>
        <span class="k">if</span> <span class="n">iter_function_over</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iter_ovars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">iter_function_over</span><span class="p">:</span>
                    <span class="n">loop_lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_finalize_oiter</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="c1"># Send outputs</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outside_loop&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">loop_lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_model_send</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span>
                                                   <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">)</span>
        <span class="n">loop_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
            <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">iter_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;false_flag&#39;</span><span class="p">,</span>
                                         <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">])))</span>
        <span class="c1"># Add break if there are not any inputs inside the loop</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">any_loop_inputs</span><span class="p">:</span>
            <span class="n">loop_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">flag_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s1">&#39;false_flag&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">])))</span>
        <span class="c1"># Add loop in while block</span>
        <span class="n">flag_cond</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;flag_cond&#39;</span><span class="p">,</span>
                                              <span class="n">default</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{flag_var}</span><span class="s1">&#39;</span><span class="p">,</span>
                                              <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_while_loop</span><span class="p">(</span><span class="n">flag_cond</span><span class="p">,</span> <span class="n">loop_lines</span><span class="p">)</span>
        <span class="c1"># Send outputs after loop</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outside_loop&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_model_send</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span>
                                              <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">)</span>
        <span class="c1"># Free variables</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">free_vars</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_free</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># Add prints</span>
        <span class="k">if</span> <span class="n">verbose_model</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">nline_preamble</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;else&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                    <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                                    <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()))</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                        <span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">idx</span><span class="p">))))</span>
                <span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="c1"># Wrap as executable with interface &amp; model import</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;interface&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
            <span class="n">ygglib</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">interface_library</span>
            <span class="k">if</span> <span class="n">ygglib</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">internal_libraries</span><span class="p">:</span>
                <span class="n">ygglib</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">internal_libraries</span><span class="p">[</span><span class="n">ygglib</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">interface_inside_exec</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;interface&#39;</span><span class="p">,</span> <span class="n">interface_library</span><span class="o">=</span><span class="n">ygglib</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;interface&#39;</span><span class="p">,</span> <span class="n">interface_library</span><span class="o">=</span><span class="n">ygglib</span><span class="p">)]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_executable</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                                   <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                                   <span class="n">imports</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">model_file</span><span class="p">,</span>
                                            <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">model_function</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_channel_decl"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_channel_decl">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_channel_decl</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write a channel declaration.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict): Information dictionary for the channel.</span>
<span class="sd">                being declared.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to class&#39;s</span>
<span class="sd">                write_declaration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The lines declaring the variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dont_declare_channel</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">],</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;comm&#39;</span><span class="p">},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
             <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{channel_type}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]))):</span>
            <span class="n">var</span><span class="p">[</span><span class="s1">&#39;channel_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_type&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_type_decl</span><span class="p">(</span>
                <span class="n">var</span><span class="p">[</span><span class="s1">&#39;channel_type&#39;</span><span class="p">],</span> <span class="n">var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">],</span>
                <span class="n">definitions</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;definitions&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">requires_freeing</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requires_freeing&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_type_decl"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_type_decl">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_type_decl</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">name_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">requires_freeing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">definitions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">no_decl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get lines declaring the datatype within the language.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of variable that should be declared.</span>
<span class="sd">            datatype (dict): Type definition.</span>
<span class="sd">            requires_freeing (list, optional): List that variables requiring</span>
<span class="sd">                freeing should be appended to. Defaults to None.</span>
<span class="sd">            definitions (list, optional): Existing list that variable</span>
<span class="sd">                definitions should be added to. Defaults to None if not</span>
<span class="sd">                provided and definitions will be included in the returned</span>
<span class="sd">                lines.</span>
<span class="sd">            no_decl (bool, optional): If True, the variable is not</span>
<span class="sd">                declared, but supporting variables will be. Defaults</span>
<span class="sd">                to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines required to define a type declaration.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">name_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name_base</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">in</span> <span class="n">datatype</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">))</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_items&#39;</span> <span class="o">%</span> <span class="n">name_base</span><span class="p">,</span>
                     <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="p">{</span>
                         <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;1darray&#39;</span><span class="p">,</span> <span class="s1">&#39;subtype&#39;</span><span class="p">:</span> <span class="s1">&#39;dtype&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">])}},</span>
                    <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                    <span class="n">requires_freeing</span><span class="o">=</span><span class="n">requires_freeing</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]):</span>
                    <span class="c1"># Prevent recusion</span>
                    <span class="n">x_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">x_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">x_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_type_decl</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="n">x_copy</span><span class="p">,</span>
                        <span class="n">name_base</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_item</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name_base</span><span class="p">,</span> <span class="n">i</span><span class="p">)),</span>
                        <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                        <span class="n">requires_freeing</span><span class="o">=</span><span class="n">requires_freeing</span><span class="p">,</span>
                        <span class="n">no_decl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;properties&#39;</span> <span class="ow">in</span> <span class="n">datatype</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">))</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]:</span>
                    <span class="n">precision</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                                     <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_keys&#39;</span> <span class="o">%</span> <span class="n">name_base</span><span class="p">,</span>
                     <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="p">{</span>
                         <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;1darray&#39;</span><span class="p">,</span> <span class="s1">&#39;subtype&#39;</span><span class="p">:</span> <span class="s1">&#39;bytes&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">}},</span>
                    <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                    <span class="n">requires_freeing</span><span class="o">=</span><span class="n">requires_freeing</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_vals&#39;</span> <span class="o">%</span> <span class="n">name_base</span><span class="p">,</span>
                     <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="p">{</span>
                         <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;1darray&#39;</span><span class="p">,</span> <span class="s1">&#39;subtype&#39;</span><span class="p">:</span> <span class="s1">&#39;dtype&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">])}},</span>
                    <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                    <span class="n">requires_freeing</span><span class="o">=</span><span class="n">requires_freeing</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="c1"># Prevent recusion</span>
                    <span class="n">v_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">v_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">v_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_type_decl</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="n">v_copy</span><span class="p">,</span>
                        <span class="n">name_base</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_prop</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name_base</span><span class="p">,</span> <span class="n">i</span><span class="p">)),</span>
                        <span class="n">requires_freeing</span><span class="o">=</span><span class="n">requires_freeing</span><span class="p">,</span>
                        <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                        <span class="n">no_decl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ndarray&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;shape&#39;</span> <span class="ow">in</span> <span class="n">datatype</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_shape&#39;</span> <span class="o">%</span> <span class="n">name_base</span><span class="p">,</span>
                     <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="p">{</span>
                         <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;1darray&#39;</span><span class="p">,</span> <span class="s1">&#39;subtype&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])}},</span>
                    <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                    <span class="n">requires_freeing</span><span class="o">=</span><span class="n">requires_freeing</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ply&#39;</span><span class="p">,</span> <span class="s1">&#39;obj&#39;</span><span class="p">,</span> <span class="s1">&#39;1darray&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="s1">&#39;any&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">_valid_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Cannot create </span><span class="si">%s</span><span class="s2"> version of type &quot;</span>
                              <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_decl</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dtype&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_type_def"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_type_def">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_type_def</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">name_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">use_generic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get lines declaring the data type within the language.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of variable that definition should be stored in.</span>
<span class="sd">            datatype (dict): Type definition.</span>
<span class="sd">            use_generic (bool, optional): If True variables serialized</span>
<span class="sd">                and/or deserialized by the type will be assumed to be</span>
<span class="sd">                generic objects. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines required to define a type definition.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">use_generic</span><span class="p">:</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;use_generic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;use_generic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">]</span>
        <span class="n">typename</span> <span class="o">=</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name_base</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">in</span> <span class="n">datatype</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">))</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;nitems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">])</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_items&#39;</span> <span class="o">%</span> <span class="n">name_base</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">zero_based</span><span class="p">:</span>
                    <span class="n">idx_offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx_offset</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]):</span>
                    <span class="c1"># Prevent recusion</span>
                    <span class="n">x_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">x_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">x_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_type_def</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                            <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">keys</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">],</span>
                            <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">idx_offset</span><span class="p">)),</span> <span class="n">x_copy</span><span class="p">,</span>
                        <span class="n">name_base</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_item</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name_base</span><span class="p">,</span> <span class="n">i</span><span class="p">)),</span>
                        <span class="n">use_generic</span><span class="o">=</span><span class="n">use_generic</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;nitems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;use_generic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;use_generic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;properties&#39;</span> <span class="ow">in</span> <span class="n">datatype</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">))</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;nitems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">])</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_keys&#39;</span> <span class="o">%</span> <span class="n">name_base</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_vals&#39;</span> <span class="o">%</span> <span class="n">name_base</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">zero_based</span><span class="p">:</span>
                    <span class="n">idx_offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx_offset</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="c1"># Prevent recusion</span>
                    <span class="n">v_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">v_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">v_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                        <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                            <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">keys</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">],</span>
                            <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">idx_offset</span><span class="p">))))</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_type_def</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                            <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">keys</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">],</span>
                            <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">idx_offset</span><span class="p">)),</span> <span class="n">v_copy</span><span class="p">,</span>
                        <span class="n">name_base</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_prop</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name_base</span><span class="p">,</span> <span class="n">i</span><span class="p">)),</span>
                        <span class="n">use_generic</span><span class="o">=</span><span class="n">use_generic</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;nitems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ply&#39;</span><span class="p">,</span> <span class="s1">&#39;obj&#39;</span><span class="p">]:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1darray&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;subtype&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">]:</span>
                <span class="n">keys</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">])</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ndarray&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;subtype&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">]:</span>
                <span class="n">keys</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;shape&#39;</span> <span class="ow">in</span> <span class="n">datatype</span><span class="p">:</span>
                <span class="n">shape_var</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_shape&#39;</span> <span class="o">%</span> <span class="n">name_base</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">zero_based</span><span class="p">:</span>
                    <span class="n">idx_offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx_offset</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]):</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                        <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                            <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">shape_var</span><span class="p">,</span>
                            <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">idx_offset</span><span class="p">))))</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;ndim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape_var</span>
                <span class="n">typename</span> <span class="o">=</span> <span class="s1">&#39;ndarray_arr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;ndim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">typename</span> <span class="o">==</span> <span class="s1">&#39;scalar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">typename</span> <span class="ow">in</span> <span class="n">_valid_types</span><span class="p">):</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;subtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subtype&#39;</span><span class="p">,</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;subtype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bytes&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;unicode&#39;</span><span class="p">]:</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datatype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">])</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="s1">&#39;scalar&#39;</span>
        <span class="k">elif</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">]:</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">typename</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">]):</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">typename</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="s1">&#39;pyobj&#39;</span>
        <span class="k">elif</span> <span class="n">typename</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="s1">&#39;any&#39;</span><span class="p">]:</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;use_generic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="s1">&#39;empty&#39;</span>
        <span class="k">elif</span> <span class="n">typename</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]:</span>
            <span class="n">keys</span><span class="p">[</span><span class="s1">&#39;use_generic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot create </span><span class="si">%s</span><span class="s2"> version of type &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">typename</span><span class="p">))</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;init_type_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">typename</span><span class="p">,</span> <span class="o">**</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">value</span><span class="o">=</span><span class="n">fmt</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_channel_def"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_channel_def">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_channel_def</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write an channel definition.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): Entry in cls.function_param that should be used.</span>
<span class="sd">            datatype (dict, optional): Data type associated with the channel.</span>
<span class="sd">                Defaults to None and is ignored.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed as parameters</span>
<span class="sd">                to format_function_param.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines required to declare and define an output channel.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">datatype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{channel_type}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;channel_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_type&#39;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_type_def</span><span class="p">(</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;channel_type&#39;</span><span class="p">],</span> <span class="n">datatype</span><span class="p">,</span>
                <span class="n">use_generic</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_generic&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">dir_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="s1">&#39;recv&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="s1">&#39;send&#39;</span><span class="p">}</span>
        <span class="n">try_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">dir_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_converter&#39;</span><span class="p">,</span> <span class="s1">&#39;transform&#39;</span><span class="p">]</span>
        <span class="n">try_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">try_keys</span><span class="p">]):</span>  <span class="c1"># pragma: debug</span>
            <span class="c1"># TODO: Handling merger of the transforms in yaml or</span>
            <span class="c1"># remove the *_converter options entirely</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">((</span><span class="s2">&quot;Transforms are specified in multiple &quot;</span>
                                <span class="s2">&quot;locations for this input: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
                               <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">try_keys</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">try_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">try_vals</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="c1"># This last transform is used because the others are assumed</span>
        <span class="c1"># to be applied by the connection driver</span>
        <span class="k">if</span> <span class="n">try_vals</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">try_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">try_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">try_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(((</span><span class="s1">&#39;python_interface&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">)</span>
                 <span class="ow">and</span> <span class="p">(</span><span class="n">try_key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">python_interface</span><span class="p">))):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;python_interface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">python_interface</span><span class="p">[</span><span class="n">try_key</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(((</span><span class="s1">&#39;format_str&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
                     <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;python_interface_format&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">))):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;python_interface_format&#39;</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;format_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;format_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                        <span class="s2">&quot;unicode_escape&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;python_interface&#39;</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_model_function_call"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_model_function_call">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_model_function_call</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_function</span><span class="p">,</span> <span class="n">flag_var</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span>
                                  <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_failure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">format_not_flag_cond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">format_flag_cond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">iter_function_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write lines necessary to call the model function.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_function (str): Handle of the model function that should be</span>
<span class="sd">                called.</span>
<span class="sd">            flag_var (str): Name of variable that should be used as a flag.</span>
<span class="sd">            inputs (list): List of dictionaries describing inputs to the model.</span>
<span class="sd">            outputs (list): List of dictionaries describing outputs from the model.</span>
<span class="sd">            outputs_in_inputs (bool, optional): If True, the outputs are</span>
<span class="sd">                presented in the function definition as inputs. Defaults</span>
<span class="sd">                to the class attribute outputs_in_inputs.</span>
<span class="sd">            on_failure (list, optional): Lines to be executed if the model</span>
<span class="sd">                call fails. Defaults to an error message. This variable</span>
<span class="sd">                is only used if flag_var is not None and outputs_in_inputs</span>
<span class="sd">                is True.</span>
<span class="sd">            format_not_flag_cond (str, optional): Format string that produces</span>
<span class="sd">                a conditional expression that evaluates to False when the</span>
<span class="sd">                model flag indicates a failure. Defaults to None and the</span>
<span class="sd">                class&#39;s value for &#39;not_flag_cond&#39; in function_param is used</span>
<span class="sd">                if it exists. If it does not exist, format_flag_cond is used.</span>
<span class="sd">            format_flag_cond (str, optional): Format string that produces</span>
<span class="sd">                a conditional expression that evaluates to True when the</span>
<span class="sd">                model flag indicates a success. Defaults to None and the</span>
<span class="sd">                defaults class&#39;s value for &#39;flag_cond&#39; in function_param is</span>
<span class="sd">                used if it exists. If it does not exist, the flag is</span>
<span class="sd">                directly evaluated as if it were a boolean.</span>
<span class="sd">            iter_function_idx (dict, optional): Variable that serves as an</span>
<span class="sd">                index to iterate over variables. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines required to carry out a call to a model function in</span>
<span class="sd">                this language.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="n">outputs_in_inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">outputs_in_inputs</span>
        <span class="n">func_inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">channels2vars</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">func_outputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">channels2vars</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iter_function_idx</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="p">[</span><span class="n">func_inputs</span><span class="p">,</span> <span class="n">func_outputs</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;iter_datatype&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                        <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;iter_datatype&#39;</span><span class="p">],</span>
                            <span class="n">name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                                <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                                <span class="n">index</span><span class="o">=</span><span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                                <span class="n">extra</span><span class="o">=</span><span class="n">x</span><span class="p">),</span>
                            <span class="n">length_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flag_var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">flag_var</span> <span class="o">=</span> <span class="n">flag_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_function_call</span><span class="p">(</span>
            <span class="n">model_function</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">func_inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">func_outputs</span><span class="p">,</span>
            <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">,</span> <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="n">outputs_in_inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flag_var</span> <span class="ow">and</span> <span class="n">outputs_in_inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">format_flag_cond</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;not_flag_cond&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">):</span>
                <span class="n">flag_cond</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;not_flag_cond&#39;</span><span class="p">,</span> <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">,</span>
                    <span class="n">replacement</span><span class="o">=</span><span class="n">format_not_flag_cond</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="c1"># flag_cond = &#39;%s (%s)&#39; % (</span>
                <span class="c1">#     cls.function_param[&#39;not&#39;],</span>
                <span class="c1">#     cls.format_function_param(</span>
                <span class="c1">#         &#39;flag_cond&#39;, default=&#39;{flag_var}&#39;, flag_var=flag_var,</span>
                <span class="c1">#         replacement=format_flag_cond))</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Untested code below. Uncomment &quot;</span>
                                   <span class="s2">&quot;at your own risk if you find &quot;</span>
                                   <span class="s2">&quot;use case for it.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">on_failure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">on_failure</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="s2">&quot;Model call failed.&quot;</span><span class="p">)]</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_if_block</span><span class="p">(</span><span class="n">flag_cond</span><span class="p">,</span> <span class="n">on_failure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iter_function_idx</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_for_loop</span><span class="p">(</span><span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                                     <span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">],</span>
                                     <span class="n">iter_function_idx</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">],</span>
                                     <span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_model_recv"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_model_recv">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_model_recv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">recv_var</span><span class="p">,</span> <span class="n">flag_var</span><span class="o">=</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span>
                         <span class="n">iter_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">alt_recv_function</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write a model receive call include checking the return flag.</span>

<span class="sd">        Args:</span>
<span class="sd">            channel (str): Name of variable that the channel being received from</span>
<span class="sd">                was stored in.</span>
<span class="sd">            recv_var (dict, list): Information of one or more variables that</span>
<span class="sd">                receieved information should be stored in.</span>
<span class="sd">            flag_var (str, optional): Name of flag variable that the flag should</span>
<span class="sd">                be stored in. Defaults to &#39;flag&#39;,</span>
<span class="sd">            iter_var (str, optional): Name of flag signifying when the</span>
<span class="sd">                model is in it&#39;s first iteration. If allow_failure is</span>
<span class="sd">                True and iter_var is provided, an error will be raised</span>
<span class="sd">                if iter_var is True. Defaults to None.</span>
<span class="sd">            allow_failure (bool, optional): If True, the returned lines will</span>
<span class="sd">                call a break if the flag is False. Otherwise, the returned</span>
<span class="sd">                lines will issue an error. Defaults to False.</span>
<span class="sd">            alt_recv_function (str, optional): Alternate receive function</span>
<span class="sd">                format string. Defaults to None and is ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines required to carry out a receive call in this language.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;function_param attribute not set for&quot;</span>
                                      <span class="s2">&quot;language &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">recv_var_str</span> <span class="o">=</span> <span class="n">recv_var</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recv_var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">recv_var_par</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">channels2vars</span><span class="p">(</span><span class="n">recv_var</span><span class="p">)</span>
            <span class="n">recv_var_str</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_output_variables</span><span class="p">(</span>
                <span class="n">recv_var_par</span><span class="p">,</span> <span class="n">in_inputs</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">outputs_in_inputs</span><span class="p">,</span>
                <span class="n">for_yggdrasil</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recv_var_par</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">split_variables</span><span class="p">(</span><span class="n">recv_var_str</span><span class="p">)</span>
        <span class="n">expanded_recv_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">recv_var_par</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;multiple_outputs&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">):</span>
            <span class="n">expanded_recv_var</span> <span class="o">=</span> <span class="n">recv_var_str</span>
            <span class="n">recv_var_str</span> <span class="o">=</span> <span class="s1">&#39;temp_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">recv_var_par</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flag_var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">flag_var</span> <span class="o">=</span> <span class="n">flag_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iter_var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">iter_var</span> <span class="o">=</span> <span class="n">iter_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">outputs_in_inputs</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">recv_var_str</span><span class="p">]</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag_var</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag_var</span><span class="p">,</span> <span class="n">recv_var_str</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">include_channel_obj</span><span class="p">:</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_function_call</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;recv_function&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                                      <span class="n">replacement</span><span class="o">=</span><span class="n">alt_recv_function</span><span class="p">),</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span> <span class="n">include_arg_count</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">include_arg_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;not_flag_cond&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
            <span class="n">flag_cond</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;not_flag_cond&#39;</span><span class="p">,</span>
                                                  <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag_cond</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;not&#39;</span><span class="p">],</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;flag_cond&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{flag_var}</span><span class="s1">&#39;</span><span class="p">,</span>
                                          <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">))</span>
        <span class="n">fail_message</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">escape_quotes</span><span class="p">(</span>
            <span class="s2">&quot;Could not receive </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">recv_var_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allow_failure</span><span class="p">:</span>
            <span class="n">fail_message</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">escape_quotes</span><span class="p">(</span>
                <span class="s1">&#39;End of input from </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">recv_var_str</span><span class="p">)</span>
            <span class="n">if_block</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">fail_message</span><span class="p">),</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;break&#39;</span><span class="p">,</span> <span class="s1">&#39;break&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">iter_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">if_block</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_if_block</span><span class="p">(</span>
                    <span class="n">iter_var</span><span class="p">,</span>
                    <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                        <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">escape_quotes</span><span class="p">(</span>
                            <span class="s1">&#39;No input from </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">recv_var_str</span><span class="p">))],</span>
                    <span class="n">if_block</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">if_block</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="n">fail_message</span><span class="p">)]</span>
        <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_if_block</span><span class="p">(</span><span class="n">flag_cond</span><span class="p">,</span> <span class="n">if_block</span><span class="p">)</span>
        <span class="c1"># Check if single element should be expanded</span>
        <span class="k">if</span> <span class="n">expanded_recv_var</span><span class="p">:</span>
            <span class="c1"># lines.append(cls.format_function_param(</span>
            <span class="c1">#     &#39;print_generic&#39;, object=recv_var_str))</span>
            <span class="k">if</span> <span class="s1">&#39;expand_mult&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>  <span class="c1"># pragma: matlab</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;expand_mult&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">expanded_recv_var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">recv_var_str</span><span class="p">))</span>
            <span class="k">elif</span> <span class="s1">&#39;assign_mult&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;assign_mult&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">expanded_recv_var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">recv_var_str</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">expanded_recv_var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">recv_var_str</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">recv_var_par</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_expand_single_element</span><span class="p">(</span><span class="n">recv_var_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>
    
<div class="viewcode-block" id="ModelDriver.write_model_send"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_model_send">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_model_send</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">send_var</span><span class="p">,</span> <span class="n">flag_var</span><span class="o">=</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span>
                         <span class="n">allow_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write a model send call include checking the return flag.</span>

<span class="sd">        Args:</span>
<span class="sd">            channel (str): Name of variable that the channel being sent to</span>
<span class="sd">                was stored in.</span>
<span class="sd">            send_var (dict, list): Information on one or more variables</span>
<span class="sd">                containing information that will be sent.</span>
<span class="sd">            flag_var (str, optional): Name of flag variable that the flag should</span>
<span class="sd">                be stored in. Defaults to &#39;flag&#39;,</span>
<span class="sd">            allow_failure (bool, optional): If True, the returned lines will</span>
<span class="sd">                call a break if the flag is False. Otherwise, the returned</span>
<span class="sd">                lines will issue an error. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines required to carry out a send call in this language.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;function_param attribute not set for&quot;</span>
                                      <span class="s2">&quot;language &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">send_var_str</span> <span class="o">=</span> <span class="n">send_var</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">send_var_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">send_var_par</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">channels2vars</span><span class="p">(</span><span class="n">send_var</span><span class="p">)</span>
            <span class="n">send_var_str</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_input_variables</span><span class="p">(</span>
                <span class="n">send_var_par</span><span class="p">,</span> <span class="n">for_yggdrasil</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flag_var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">flag_var</span> <span class="o">=</span> <span class="n">flag_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">include_channel_obj</span><span class="p">:</span>
            <span class="n">send_var_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel</span><span class="p">,</span> <span class="n">send_var_str</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_function_call</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;send_function&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">),</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">send_var_str</span><span class="p">,</span>
            <span class="n">outputs</span><span class="o">=</span><span class="n">flag_var</span><span class="p">,</span> <span class="n">include_arg_count</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">include_arg_count</span><span class="p">)</span>
        <span class="n">flag_cond</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;not&#39;</span><span class="p">],</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;flag_cond&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{flag_var}</span><span class="s1">&#39;</span><span class="p">,</span>
                                      <span class="n">flag_var</span><span class="o">=</span><span class="n">flag_var</span><span class="p">))</span>
        <span class="n">fail_message</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">escape_quotes</span><span class="p">(</span>
            <span class="s2">&quot;Could not send </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">send_var_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allow_failure</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="c1"># This is not particularly useful, but is included for completion</span>
            <span class="n">if_block</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">fail_message</span><span class="p">),</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;break&#39;</span><span class="p">,</span> <span class="s1">&#39;break&#39;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">if_block</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="n">fail_message</span><span class="p">)]</span>
        <span class="n">lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_if_block</span><span class="p">(</span><span class="n">flag_cond</span><span class="p">,</span> <span class="n">if_block</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="ModelDriver.write_print_var"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_print_var">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_print_var</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">prefix_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the lines necessary to print a variable in this language.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict): Variable information.</span>
<span class="sd">            prefix_msg (str, optional): Message that should be printed</span>
<span class="sd">                before the variable. Defaults to None and is ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines printing the specified variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">print_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">varname</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">varname</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;datatype&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;print_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">typename</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
                <span class="n">print_key</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;print_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">typename</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;print_generic&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
                <span class="n">print_key</span> <span class="o">=</span> <span class="s1">&#39;print_generic&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;print_generic&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
            <span class="n">print_key</span> <span class="o">=</span> <span class="s1">&#39;print_generic&#39;</span>
        <span class="k">if</span> <span class="n">print_key</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prefix_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">prefix_msg</span><span class="p">))</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="n">print_key</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="n">varname</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_print_input_var"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_print_input_var">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_print_input_var</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the lines necessary to print an input variable in this</span>
<span class="sd">        language.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict): Variable information.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to write_print_var.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines printing the specified variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_print_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="ModelDriver.write_print_output_var"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_print_output_var">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_print_output_var</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">in_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the lines necessary to print an output variable in this</span>
<span class="sd">        language.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict): Variable information.</span>
<span class="sd">            in_inputs (bool, optional): If True, the output variable</span>
<span class="sd">                is passed in as an input variable to be populated.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to write_print_var.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines printing the specified variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_print_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="ModelDriver.write_function_def"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_function_def">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_function_def</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[],</span>
                           <span class="n">input_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">function_contents</span><span class="o">=</span><span class="p">[],</span>
                           <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">opening_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">closing_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">print_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">skip_interface</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">function_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write a function definition.</span>

<span class="sd">        Args:</span>
<span class="sd">            function_name (str): Name fo the function being defined.</span>
<span class="sd">            inputs (list, optional): List of inputs to the function.</span>
<span class="sd">                Defaults to []. Ignored if input_var provided.</span>
<span class="sd">            outputs (list, optional): List of outputs from the function.</span>
<span class="sd">                Defaults to []. If not provided, no return call is</span>
<span class="sd">                added to the function body. Ignored if output_var</span>
<span class="sd">                provided.</span>
<span class="sd">            input_var (str, optional): Full string specifying input in</span>
<span class="sd">                the function definition. If not provided, this will be</span>
<span class="sd">                created based on the contents of the inputs variable.</span>
<span class="sd">            output_var (str, optional): Full string specifying output in</span>
<span class="sd">                the function definition. If not provided, this will be</span>
<span class="sd">                created based on the contents of the outputs variable.</span>
<span class="sd">            function_contents (list, optional): List of lines comprising</span>
<span class="sd">                the body of the function. Defaults to [].</span>
<span class="sd">            outputs_in_inputs (bool, optional): If True, the outputs are</span>
<span class="sd">                presented in the function definition as inputs. Defaults</span>
<span class="sd">                to False.</span>
<span class="sd">            opening_msg (str, optional): String that should be printed</span>
<span class="sd">                before the function contents (and inputs if print_inputs</span>
<span class="sd">                is True). Defaults to None and is ignored.</span>
<span class="sd">            closing_msg (str, optional): String that should be printed</span>
<span class="sd">                after the function contents (and outputs if print_outputs</span>
<span class="sd">                is True). Defaults to None and is ignored.</span>
<span class="sd">            print_inputs (bool, optional): If True, the input variables</span>
<span class="sd">                will be printed before the function contents. Defaults</span>
<span class="sd">                to False.</span>
<span class="sd">            print_outputs (bool, optional): If True, the output variables</span>
<span class="sd">                will be printed after the function contents. Defaults to</span>
<span class="sd">                False.</span>
<span class="sd">            skip_interface (bool, optional): If True, the line including</span>
<span class="sd">                the interface will be skipped. Defaults to False.</span>
<span class="sd">            function_keys (tuple, optional): 2 element tuple that</span>
<span class="sd">                specifies the keys for the function_param entries that</span>
<span class="sd">                should be used to begin &amp; end a function definition.</span>
<span class="sd">                Defaults to (&#39;function_def_begin&#39;, function_def_end&#39;).</span>
<span class="sd">            verbose (bool, optional): If True, the contents of the created file</span>
<span class="sd">                are displayed. Defaults to False.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to</span>
<span class="sd">                cls.format_function_param.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines completing the function call.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If the function_param attribute for the</span>
<span class="sd">                class is not defined.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;function_param attribute not set for&quot;</span>
                                      <span class="s2">&quot;language &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">function_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">function_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;function_def_begin&#39;</span><span class="p">,</span> <span class="s1">&#39;function_def_end&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">interface_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;interface&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">skip_interface</span><span class="p">):</span>
            <span class="n">ygglib</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">interface_library</span>
            <span class="k">if</span> <span class="n">ygglib</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">internal_libraries</span><span class="p">:</span>
                <span class="n">ygglib</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">internal_libraries</span><span class="p">[</span><span class="n">ygglib</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="n">interface_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="s1">&#39;interface&#39;</span><span class="p">,</span> <span class="n">interface_library</span><span class="o">=</span><span class="n">ygglib</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">interface_inside_exec</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">interface_lines</span>
        <span class="n">flag_var</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">input_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_var</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_input_variables</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">in_definition</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_var</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_output_variables</span><span class="p">(</span>
                <span class="n">outputs</span><span class="p">,</span> <span class="n">in_inputs</span><span class="o">=</span><span class="n">outputs_in_inputs</span><span class="p">,</span> <span class="n">in_definition</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">print_input_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">print_inputs</span> <span class="ow">and</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">print_input_lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_print_input_var</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">prefix_msg</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;INPUT[</span><span class="si">%s</span><span class="s1">]:&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
        <span class="n">print_output_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">print_outputs</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="n">print_output_lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_print_output_var</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">prefix_msg</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;OUTPUT[</span><span class="si">%s</span><span class="s1">]:&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span>
                    <span class="n">in_inputs</span><span class="o">=</span><span class="n">outputs_in_inputs</span><span class="p">)</span>
        <span class="n">old_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_var</span><span class="p">:</span>
                <span class="n">input_var</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_input_variables</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">input_var</span><span class="p">,</span> <span class="n">output_var</span><span class="p">])</span>
            <span class="n">flag_var</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_var&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flag_var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">flag_var</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">flag_var</span><span class="p">}</span>
            <span class="n">flag_var</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">)</span>
            <span class="n">flag_var</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;true_flag&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]))</span>
            <span class="n">old_outputs</span> <span class="o">=</span> <span class="n">outputs</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag_var</span><span class="p">]</span>
            <span class="n">output_var</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_output_variables</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
            <span class="n">function_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span>
            <span class="n">input_var</span><span class="o">=</span><span class="n">input_var</span><span class="p">,</span> <span class="n">output_var</span><span class="o">=</span><span class="n">output_var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">interface_inside_exec</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">interface_lines</span><span class="p">]</span>
        <span class="n">free_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;declare&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
            <span class="n">definitions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">types_in_funcdef</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="n">inputs</span> <span class="o">+</span> <span class="n">old_outputs</span><span class="p">):</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span>
                            <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                                <span class="n">o</span><span class="p">,</span> <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                                <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">,</span>
                                <span class="n">is_argument</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span>
                        <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_declaration</span><span class="p">(</span>
                            <span class="n">o</span><span class="p">,</span> <span class="n">definitions</span><span class="o">=</span><span class="n">definitions</span><span class="p">,</span>
                            <span class="n">requires_freeing</span><span class="o">=</span><span class="n">free_vars</span><span class="p">)]</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">definitions</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span>
                       <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                           <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">flag_var</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">opening_msg</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span>
                       <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                           <span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">opening_msg</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">print_inputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">print_input_lines</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">function_contents</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">print_output_lines</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">closing_msg</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span>
                       <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                           <span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">closing_msg</span><span class="p">))</span>
        <span class="c1"># This is not currently used by the tests, but may be</span>
        <span class="c1"># needed in the future</span>
        <span class="k">assert</span><span class="p">(</span><span class="ow">not</span> <span class="n">free_vars</span><span class="p">)</span>
        <span class="c1"># for x in free_vars:</span>
        <span class="c1">#     out += [cls.function_param[&#39;indent&#39;] + line</span>
        <span class="c1">#             for line in cls.write_free(x)]</span>
        <span class="k">if</span> <span class="n">output_var</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;return&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span>
                       <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                           <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="n">output_var</span><span class="o">=</span><span class="n">output_var</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">function_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="n">function_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_end&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_function_call"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_function_call">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_function_call</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[],</span>
                            <span class="n">include_arg_count</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write a function call.</span>

<span class="sd">        Args:</span>
<span class="sd">            function_name (str): Name of the function being called.</span>
<span class="sd">            inputs (list, optional): List of inputs to the function.</span>
<span class="sd">                Defaults to [].</span>
<span class="sd">            outputs (list, optional): List of outputs from the function.</span>
<span class="sd">                Defaults to [].</span>
<span class="sd">            include_arg_count (bool, optional): If True, the count of input</span>
<span class="sd">                arguments is included as the first argument. Defaults to</span>
<span class="sd">                False.</span>
<span class="sd">            outputs_in_inputs (bool, optional): If True, the outputs are</span>
<span class="sd">                presented in the function definition as inputs. Defaults</span>
<span class="sd">                to False.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to</span>
<span class="sd">                cls.format_function_param.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines completing the function call.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outputs_in_inputs</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span> <span class="o">+</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">prepare_output_variables</span><span class="p">(</span>
                <span class="n">outputs</span><span class="p">,</span> <span class="n">in_inputs</span><span class="o">=</span><span class="n">outputs_in_inputs</span><span class="p">)]</span>
            <span class="n">flag_var</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_var&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">flag_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;function_call_noout&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">):</span>
                <span class="n">flag_var</span> <span class="o">=</span> <span class="s1">&#39;flag&#39;</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">flag_var</span><span class="p">:</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag_var</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;input_var&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_input_variables</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;output_var&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_output_variables</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
        <span class="n">nout</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">split_variables</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;output_var&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">include_arg_count</span><span class="p">:</span>
            <span class="n">narg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">split_variables</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;input_var&#39;</span><span class="p">]))</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;input_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_input_variables</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">narg</span><span class="p">),</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;input_var&#39;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;function_call_noout&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">):</span>
            <span class="n">call_str</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="s1">&#39;function_call_noout&#39;</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">call_str</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="s1">&#39;function_call&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{function_name}</span><span class="s1">(</span><span class="si">{input_var}</span><span class="s1">)&#39;</span><span class="p">,</span>
                <span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">call_str</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;line_end&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">nout</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;assign_mult&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="s1">&#39;assign_mult&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;output_var&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">call_str</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;output_var&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">call_str</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">out</span></div>
        
<div class="viewcode-block" id="ModelDriver.write_executable_import"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_executable_import">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_executable_import</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Add import statements to executable lines.</span>
<span class="sd">       </span>
<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Keyword arguments for import statement.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines required to complete the import.</span>
<span class="sd"> </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This code is currently unused, but may be needed in the</span>
        <span class="c1"># future to import a dependency directly</span>
        <span class="c1"># if (&#39;filename&#39; not in kwargs) and (&#39;import_nofile&#39; in cls.function_param):</span>
        <span class="c1">#     key = &#39;import_nofile&#39;</span>
        <span class="c1"># else:</span>
        <span class="c1">#     key = &#39;import&#39;</span>
        <span class="c1"># return [cls.format_function_param(key, **kwargs)]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;import&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;import&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_executable"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_executable">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_executable</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">function_definitions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imports</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the lines required to complete a program that will run</span>
<span class="sd">        the provided lines.</span>

<span class="sd">        Args:</span>
<span class="sd">            lines (list): Lines of code to be wrapped as an executable.</span>
<span class="sd">            prefix (list, optional): Lines of code that should proceed the</span>
<span class="sd">                wrapped code. Defaults to None and is ignored. (e.g. C/C++</span>
<span class="sd">                include statements).</span>
<span class="sd">            suffix (list, optional): Lines of code that should follow the</span>
<span class="sd">                wrapped code. Defaults to None and is ignored.</span>
<span class="sd">            function_definitions (list, optional): Lines of code defining</span>
<span class="sd">                functions that will beused by the code contained in lines.</span>
<span class="sd">                Defaults to None and is ignored.</span>
<span class="sd">            imports (list, optional): Kwargs for packages that should</span>
<span class="sd">                be imported for use by the executable. Defaults to</span>
<span class="sd">                None and is ignored.</span>
<span class="sd">            model_name (str, optional): Name given to the model. Defaults to</span>
<span class="sd">                None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            lines: Lines of code wrapping the provided lines with the</span>
<span class="sd">                necessary code to run it as an executable (e.g. C/C++&#39;s main).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;function_param attribute not set for&quot;</span>
                                      <span class="s2">&quot;language &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Add imports</span>
        <span class="k">if</span> <span class="n">imports</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">imports</span> <span class="o">=</span> <span class="p">[</span><span class="n">imports</span><span class="p">]</span>
            <span class="n">import_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">kws</span> <span class="ow">in</span> <span class="n">imports</span><span class="p">:</span>
                <span class="n">import_lines</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_executable_import</span><span class="p">(</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="n">import_lines</span>
        <span class="c1"># Add standard &amp; user defined prefixes</span>
        <span class="k">if</span> <span class="p">(((</span><span class="s1">&#39;exec_prefix&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">)</span>
             <span class="ow">and</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;exec_prefix&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">))):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;exec_prefix&#39;</span><span class="p">])</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="p">[</span><span class="n">prefix</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">prefix</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(((</span><span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;functions_defined_last&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
             <span class="ow">and</span> <span class="p">(</span><span class="n">function_definitions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))):</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">function_definitions</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># Add code with begin/end book ends</span>
        <span class="k">if</span> <span class="p">(((</span><span class="s1">&#39;exec_begin&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">)</span>
             <span class="ow">and</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;exec_begin&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)))):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;exec_begin&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exec_end&#39;</span><span class="p">,</span>
                                              <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                                  <span class="s1">&#39;block_end&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">lines</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># Add standard &amp; user defined suffixes</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">suffix</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">suffix</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(((</span><span class="s1">&#39;exec_suffix&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">)</span>
             <span class="ow">and</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;exec_suffix&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">))):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;exec_suffix&#39;</span><span class="p">])</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(((</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;functions_defined_last&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
             <span class="ow">and</span> <span class="p">(</span><span class="n">function_definitions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))):</span>  <span class="c1"># pragma: matlab</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">function_definitions</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">max_line_width</span><span class="p">:</span>
            <span class="n">new_out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">iout</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">new_out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">split_line</span><span class="p">(</span><span class="n">iout</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">new_out</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.escape_quotes"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.escape_quotes">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">escape_quotes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Escape quotes in a string.</span>

<span class="sd">        Args:</span>
<span class="sd">           x (str): String to escape quotes in.</span>

<span class="sd">        Returns:</span>
<span class="sd">           str: x with escaped quotes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\&#39;</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.split_line"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.split_line">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">split_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_split</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Split a line as close to (or before) a given character as</span>
<span class="sd">        possible.</span>

<span class="sd">        Args:</span>
<span class="sd">            line (str): Line to split.</span>
<span class="sd">            length (int, optional): Maximum length of split lines. Defaults</span>
<span class="sd">                to cls.max_line_width if not provided.</span>
<span class="sd">            force_split (bool, optional): If True, force a split to</span>
<span class="sd">                occur at the specified length. Defauts to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Set of lines resulting from spliting the provided line.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
        <span class="n">nindent</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">block_end</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;block_end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">block_end</span><span class="p">):</span>
                    <span class="n">nindent</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">])</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nindent</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">new_out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">new_out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">split_line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
                                          <span class="n">force_split</span><span class="o">=</span><span class="n">force_split</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_out</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">max_line_width</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
        <span class="n">length_allow</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;continuation_before&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">force_split</span><span class="p">:</span>
            <span class="n">isplit</span> <span class="o">=</span> <span class="n">length_allow</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isplit</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">length_allow</span><span class="p">]</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isplit</span> <span class="o">&lt;</span> <span class="n">nindent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">isplit</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="n">isplit</span><span class="p">]</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;continuation_before&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">split_line</span><span class="p">(</span>
                <span class="p">((</span><span class="n">nindent</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s1">&#39;continuation_after&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">isplit</span><span class="p">:]),</span>
                <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">force_split</span><span class="o">=</span><span class="n">force_split</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.input2output"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.input2output">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">input2output</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Perform conversion necessary to turn a variable extracted from a</span>
<span class="sd">        function definition from an input to an output.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict): Variable definition.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Updated variable definition.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="ModelDriver.output2input"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.output2input">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output2input</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">in_definition</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Perform conversion necessary to turn an output variable</span>
<span class="sd">        into an corresponding input that can be used to format a</span>
<span class="sd">        function definition.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict): Variable definition.</span>
<span class="sd">            in_definition (bool, optional): If True, the returned</span>
<span class="sd">                dictionary corresponds to an input variable in a</span>
<span class="sd">                function definition. If False, the returned value</span>
<span class="sd">                will correspond to an input to a function. Defaults to</span>
<span class="sd">                True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Updated variable definition.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="ModelDriver.get_native_type"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_native_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_native_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the native type.</span>

<span class="sd">        Args:</span>
<span class="sd">            type (str, optional): Name of |yggdrasil| extended JSON</span>
<span class="sd">                type or JSONSchema dictionary defining a datatype.</span>
<span class="sd">            **kwargs: Additional keyword arguments may be used in determining</span>
<span class="sd">                the precise declaration that should be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The native type.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;native_type&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;native_type&#39;</span><span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="s1">&#39;json_type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">json_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_type</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">json_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;bytes&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">json_type</span>
            <span class="n">json_type</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s1">&#39;scalar&#39;</span><span class="p">:</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">json_type</span><span class="p">[</span><span class="s1">&#39;subtype&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">type_name</span> <span class="o">==</span> <span class="s1">&#39;flag&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">type_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">type_map</span><span class="p">):</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="s1">&#39;boolean&#39;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">type_map</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span></div>

<div class="viewcode-block" id="ModelDriver.get_json_type"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_json_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_json_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">native_type</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the JSON type from the native language type.</span>

<span class="sd">        Args:</span>
<span class="sd">            native_type (str): The native language type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str, dict: The JSON type.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_inverse_type_map</span><span class="p">()[</span><span class="n">native_type</span><span class="p">]</span></div>

<div class="viewcode-block" id="ModelDriver.write_finalize_iiter"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_finalize_iiter">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_finalize_iiter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the lines necessary to finalize an input array for iteration.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict, str): Name or information dictionary for the variable</span>
<span class="sd">                finalized.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The lines finalizing the variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="ModelDriver.write_initialize_oiter"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_initialize_oiter">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_initialize_oiter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requires_freeing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the lines necessary to initialize an array for iteration</span>
<span class="sd">        output.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict, str): Name or information dictionary for the variable</span>
<span class="sd">                being initialized.</span>
<span class="sd">            value (str, optional): Value that should be assigned to the</span>
<span class="sd">                variable.</span>
<span class="sd">            requires_freeing (list, optional): Existing list that variables</span>
<span class="sd">                requiring freeing should be appended to. Defaults to None</span>
<span class="sd">                and is ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The lines initializing the variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_initialize</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                    <span class="n">requires_freeing</span><span class="o">=</span><span class="n">requires_freeing</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.write_finalize_oiter"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_finalize_oiter">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_finalize_oiter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requires_freeing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the lines necessary to finalize an array after iteration.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict, str): Name or information dictionary for the variable</span>
<span class="sd">                being initialized.</span>
<span class="sd">            value (str, optional): Value that should be assigned to the</span>
<span class="sd">                variable.</span>
<span class="sd">            requires_freeing (list, optional): Existing list of variables</span>
<span class="sd">                requiring freeing. Defaults to None and is ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The lines finalizing the variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="ModelDriver.write_initialize"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_initialize">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_initialize</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requires_freeing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the code necessary to initialize a variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict, str): Name or information dictionary for the variable</span>
<span class="sd">                being declared.</span>
<span class="sd">            value (str, optional): Value that should be assigned to the</span>
<span class="sd">                variable after it is declared.</span>
<span class="sd">            requires_freeing (list, optional): Existing list that variables</span>
<span class="sd">                requiring freeing should be appended to. Defaults to None</span>
<span class="sd">                and is ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The lines initializing the variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">var</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">init_type</span> <span class="o">=</span> <span class="s1">&#39;init_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">free_type</span> <span class="o">=</span> <span class="s1">&#39;free_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">init_type</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">free_type</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">)</span>
                <span class="c1"># value = cls.format_function_param(init_type, **var[&#39;datatype&#39;])</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="n">init_type</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">requires_freeing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">requires_freeing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="ModelDriver.write_declaration"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_declaration">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_declaration</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requires_freeing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">definitions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_argument</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the lines required to declare a variable with a certain</span>
<span class="sd">        type.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict, str): Name or information dictionary for the variable</span>
<span class="sd">                being declared.</span>
<span class="sd">            value (str, optional): Value that should be assigned to the</span>
<span class="sd">                variable after it is declared.</span>
<span class="sd">            requires_freeing (list, optional): Existing list that variables</span>
<span class="sd">                requiring freeing should be appended to. Defaults to None</span>
<span class="sd">                and is ignored.</span>
<span class="sd">            definitions (list, optional): Existing list that variable</span>
<span class="sd">                definitions should be added to. Defaults to None if not</span>
<span class="sd">                provided and definitions will be included in the returned</span>
<span class="sd">                lines.</span>
<span class="sd">            dont_define (bool, optional): If True, the variable will not</span>
<span class="sd">                be defined. Defaults to False.</span>
<span class="sd">            is_argument (bool, optional): If True, the variable being</span>
<span class="sd">                declared is an input argument. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The lines declaring the variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">var</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">}</span>
        <span class="n">type_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_native_type</span><span class="p">(</span><span class="o">**</span><span class="n">var</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;declare&#39;</span><span class="p">,</span>
                                         <span class="n">type_name</span><span class="o">=</span><span class="n">type_name</span><span class="p">,</span>
                                         <span class="n">variable</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_name_declare</span><span class="p">(</span><span class="n">var</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">is_argument</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">if</span> <span class="n">definitions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">definitions</span> <span class="o">=</span> <span class="n">out</span>
        <span class="n">definitions</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_initialize</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                            <span class="n">requires_freeing</span><span class="o">=</span><span class="n">requires_freeing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.get_name_declare"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.get_name_declare">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_name_declare</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine the name that should be used for declaration.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (str, dict): Name of variable or dictionary of information.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Modified name for declaration.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">return</span> <span class="n">var</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="ModelDriver.write_free"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_free">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_free</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the lines required to free a variable with a certain type.</span>

<span class="sd">        Args:</span>
<span class="sd">            var (dict, str): Name or information dictionary for the variable</span>
<span class="sd">                being declared.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to format_function_param.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The lines freeing the variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">var</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">}</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dont_free&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span>
                 <span class="ow">and</span> <span class="p">((</span><span class="s1">&#39;free_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
                      <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">))):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;free_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                    <span class="n">variable</span><span class="o">=</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_assign_to_output"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_assign_to_output">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_assign_to_output</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dst_var</span><span class="p">,</span> <span class="n">src_var</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">outputs_in_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write lines assigning a value to an output variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            dst_var (str, dict): Name or information dictionary for</span>
<span class="sd">                variable being assigned to.</span>
<span class="sd">            src_var (str, dict): Name or information dictionary for</span>
<span class="sd">                value being assigned to dst_var.</span>
<span class="sd">            copy (bool, optional): If True, the assigned value is copied</span>
<span class="sd">                during assignment. Defaults to False.</span>
<span class="sd">            outputs_in_inputs (bool, optional): If True, outputs are passed</span>
<span class="sd">                as input parameters. In some languages, this means that a</span>
<span class="sd">                pointer or reference is passed (e.g. C) and so the assignment</span>
<span class="sd">                should be to the memory indicated rather than the variable.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines achieving assignment.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst_var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">datatype</span> <span class="o">=</span> <span class="n">dst_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst_var</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">datatype</span> <span class="o">=</span> <span class="n">src_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_var</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">outputs_in_inputs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst_var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
             <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
             <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;copy_&#39;</span> <span class="o">+</span> <span class="n">dst_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                  <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">))):</span>
            <span class="n">copy</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                 <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;copy_&#39;</span> <span class="o">+</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">))):</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;copy_&#39;</span> <span class="o">+</span> <span class="n">datatype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;assign_copy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span></div>

<div class="viewcode-block" id="ModelDriver.write_expand_single_element"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_expand_single_element">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_expand_single_element</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">output_var</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Write lines allowing extraction of the only element from a single</span>
<span class="sd">        element array as a stand-alone variable if the variable is an array</span>
<span class="sd">        and only has one element.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_var (str): Name of the variable that should be conditionally</span>
<span class="sd">                expanded.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines added the conditional expansion of single element</span>
<span class="sd">                arrays.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;istype&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">write_if_block</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> 1)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;istype&#39;</span><span class="p">,</span>
                                          <span class="n">variable</span><span class="o">=</span><span class="n">output_var</span><span class="p">,</span>
                                          <span class="nb">type</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">type_map</span><span class="p">[</span><span class="s1">&#39;array&#39;</span><span class="p">]),</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&amp;&#39;</span><span class="p">),</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;len&#39;</span><span class="p">,</span>
                                          <span class="n">variable</span><span class="o">=</span><span class="n">output_var</span><span class="p">),</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;equ&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">))),</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                <span class="s1">&#39;assign&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">output_var</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span>
                    <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">output_var</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;first_index&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))))</span>
        <span class="k">return</span> <span class="n">out</span></div>
        
<div class="viewcode-block" id="ModelDriver.split_variables"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.split_variables">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">split_variables</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">var_str</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Split variable string include individual variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            var_str (str): String containing multiple variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Split variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">var_str</span><span class="p">:</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">r</span><span class="s1">&#39;\[&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\]&#39;</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\(&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\)&#39;</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\}&#39;</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&#39;&quot;</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)]</span>
            <span class="n">regex_ele</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;</span>
            <span class="n">present</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([(</span><span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">var_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="n">present</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">regex_ele</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?:</span><span class="si">%s</span><span class="s1">[.\n]*?</span><span class="si">%s</span><span class="s1">)|&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">present</span><span class="p">:</span>
                <span class="n">regex_ele</span> <span class="o">+=</span> <span class="s1">&#39;(?:.+?)&#39;</span>
                <span class="n">regex_ele</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\s*(</span><span class="si">%s</span><span class="s1">)\s*(?:,|$)&#39;</span> <span class="o">%</span> <span class="n">regex_ele</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">regex_ele</span><span class="p">,</span> <span class="n">var_str</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">var_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.prepare_variables"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.prepare_variables">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">prepare_variables</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">,</span> <span class="n">in_definition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">for_yggdrasil</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Concatenate a set of input variables such that it can be passed as a</span>
<span class="sd">        single string to the function_call parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            vars_list (list): List of variable dictionaries containing info</span>
<span class="sd">                (e.g. names) that should be used to prepare a string representing</span>
<span class="sd">                input/output to/from a function call.</span>
<span class="sd">            in_definition (bool, optional): If True, the returned sequence</span>
<span class="sd">                will be of the format required for specifying variables</span>
<span class="sd">                in a function definition. Defaults to False.</span>
<span class="sd">            for_yggdrasil (bool, optional): If True, the variables will be</span>
<span class="sd">                prepared in the formated expected by calls to yggdarsil</span>
<span class="sd">                send/recv methods. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Concatentated variables list.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">vars_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vars_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">))</span>
                <span class="n">name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.prepare_input_variables"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.prepare_input_variables">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">prepare_input_variables</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">,</span> <span class="n">in_definition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">for_yggdrasil</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Concatenate a set of input variables such that it can be passed as a</span>
<span class="sd">        single string to the function_call parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            vars_list (list): List of variable dictionaries containing info</span>
<span class="sd">                (e.g. names) that should be used to prepare a string representing</span>
<span class="sd">                input to a function call.</span>
<span class="sd">            in_definition (bool, optional): If True, the returned sequence</span>
<span class="sd">                will be of the format required for specifying input</span>
<span class="sd">                variables in a function definition. Defaults to False.</span>
<span class="sd">            for_yggdrasil (bool, optional): If True, the variables will be</span>
<span class="sd">                prepared in the formated expected by calls to yggdarsil</span>
<span class="sd">                send/recv methods. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Concatentated variables list.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_variables</span><span class="p">(</span><span class="n">vars_list</span><span class="p">,</span> <span class="n">in_definition</span><span class="o">=</span><span class="n">in_definition</span><span class="p">,</span>
                                     <span class="n">for_yggdrasil</span><span class="o">=</span><span class="n">for_yggdrasil</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDriver.prepare_output_variables"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.prepare_output_variables">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">prepare_output_variables</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">,</span> <span class="n">in_definition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">in_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">for_yggdrasil</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Concatenate a set of output variables such that it can be passed as</span>
<span class="sd">        a single string to the function_call parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            vars_list (list): List of variable dictionaries containing info</span>
<span class="sd">                (e.g. names) that should be used to prepare a string representing</span>
<span class="sd">                output from a function call.</span>
<span class="sd">            in_definition (bool, optional): If True, the returned sequence</span>
<span class="sd">                will be of the format required for specifying output</span>
<span class="sd">                variables in a function definition. Defaults to False.</span>
<span class="sd">            in_inputs (bool, optional): If True, the output variables should</span>
<span class="sd">                be formated to be included as input variables. Defaults to</span>
<span class="sd">                False.</span>
<span class="sd">            for_yggdrasil (bool, optional): If True, the variables will be</span>
<span class="sd">                prepared in the formated expected by calls to yggdarsil</span>
<span class="sd">                send/recv methods. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Concatentated variables list.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">in_inputs</span><span class="p">:</span>
            <span class="n">vars_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">output2input</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">in_definition</span><span class="o">=</span><span class="n">in_definition</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vars_list</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_variables</span><span class="p">(</span><span class="n">vars_list</span><span class="p">,</span> <span class="n">in_definition</span><span class="o">=</span><span class="n">in_definition</span><span class="p">,</span>
                                    <span class="n">for_yggdrasil</span><span class="o">=</span><span class="n">for_yggdrasil</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">in_definition</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;multiple_outputs_def&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;multiple_outputs_def&#39;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;multiple_outputs&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;multiple_outputs&#39;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_if_block"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_if_block">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_if_block</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">block_contents</span><span class="p">,</span> <span class="n">else_block_contents</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the lines required to complete a conditional block.</span>

<span class="sd">        Args:</span>
<span class="sd">            cond (str): Conditional that should determine block execution.</span>
<span class="sd">            block_contents (list): Lines of code that should be executed inside</span>
<span class="sd">                the block.</span>
<span class="sd">            else_block_contents (list, optional): Lines of code that should be</span>
<span class="sd">                executed inside the else clause of the block. Defaults to False</span>
<span class="sd">                if not provided and an else clause is omitted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines of code performing conditional execution of a block.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;function_param attribute not set for&quot;</span>
                                      <span class="s2">&quot;language &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="p">[</span><span class="n">cond</span><span class="p">]</span>
            <span class="n">block_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_contents</span><span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_contents</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">icond</span><span class="p">,</span> <span class="n">iblock_contents</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">block_contents</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;if_begin&#39;</span><span class="p">,</span> <span class="n">cond</span><span class="o">=</span><span class="n">icond</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;if_elif&#39;</span><span class="p">,</span> <span class="n">cond</span><span class="o">=</span><span class="n">icond</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iblock_contents</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">iblock_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">iblock_contents</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iblock_contents</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">else_block_contents</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;if_else&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">else_block_contents</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">else_block_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">else_block_contents</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">else_block_contents</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># Close block</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;if_end&#39;</span><span class="p">,</span>
                                          <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                              <span class="s1">&#39;block_end&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">out</span></div>
                   
<div class="viewcode-block" id="ModelDriver.write_for_loop"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_for_loop">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_for_loop</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">iter_var</span><span class="p">,</span> <span class="n">iter_begin</span><span class="p">,</span> <span class="n">iter_end</span><span class="p">,</span> <span class="n">loop_contents</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the lines required to complete a for loop.</span>

<span class="sd">        Args:</span>
<span class="sd">            iter_var (str): Name of variable that iterator should use.</span>
<span class="sd">            iter_begin (int): Beginning of iteration.</span>
<span class="sd">            iter_end (int): End of iteration.</span>
<span class="sd">            loop_contents (list): Lines of code that should be executed inside</span>
<span class="sd">                the loop.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines of code performing a loop.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;function_param attribute not set for&quot;</span>
                                      <span class="s2">&quot;language &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Opening for statement line</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;for_begin&#39;</span><span class="p">,</span> <span class="n">iter_var</span><span class="o">=</span><span class="n">iter_var</span><span class="p">,</span>
                                             <span class="n">iter_begin</span><span class="o">=</span><span class="n">iter_begin</span><span class="p">,</span>
                                             <span class="n">iter_end</span><span class="o">=</span><span class="n">iter_end</span><span class="p">))</span>
        <span class="c1"># Indent loop contents</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loop_contents</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">loop_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">loop_contents</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loop_contents</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># Close block</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;for_end&#39;</span><span class="p">,</span>
                                          <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                              <span class="s1">&#39;block_end&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_while_loop"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_while_loop">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_while_loop</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">loop_contents</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the lines required to complete a for loop.</span>

<span class="sd">        Args:</span>
<span class="sd">            cond (str): Conditional that should determine loop execution.</span>
<span class="sd">            loop_contents (list): Lines of code that should be executed inside</span>
<span class="sd">                the loop.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Lines of code performing a loop.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;function_param attribute not set for&quot;</span>
                                      <span class="s2">&quot;language &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Opening for statement line</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;while_begin&#39;</span><span class="p">,</span> <span class="n">cond</span><span class="o">=</span><span class="n">cond</span><span class="p">))</span>
        <span class="c1"># Indent loop contents</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loop_contents</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">loop_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">loop_contents</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loop_contents</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># Close block</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;while_end&#39;</span><span class="p">,</span>
                                          <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                              <span class="s1">&#39;block_end&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModelDriver.write_try_except"><a class="viewcode-back" href="../../../yggdrasil.drivers.html#yggdrasil.drivers.ModelDriver.ModelDriver.write_try_except">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write_try_except</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">try_contents</span><span class="p">,</span> <span class="n">except_contents</span><span class="p">,</span> <span class="n">error_var</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">,</span>
                         <span class="n">error_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the lines required to complete a try/except block.</span>

<span class="sd">        Args:</span>
<span class="sd">            try_contents (list): Lines of code that should be executed inside</span>
<span class="sd">                the try block.</span>
<span class="sd">            except_contents (list): Lines of code that should be executed inside</span>
<span class="sd">                the except block.</span>
<span class="sd">            error_var (str, optional): Name of variable where the caught error</span>
<span class="sd">                should be stored. Defaults to &#39;e&#39;.</span>
<span class="sd">            error_type (str, optional): Name of error type that should be caught.</span>
<span class="sd">                If not provided, defaults to None and will be set based on the</span>
<span class="sd">                class function_param entry for &#39;try_error_type&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Lines of code perfoming a try/except block.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;try_begin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;function_param attribute not set for&quot;</span>
                                      <span class="s2">&quot;language &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;try_error_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Try block contents</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">try_contents</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">try_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">try_contents</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;try_begin&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">try_contents</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># Except block contents</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">except_contents</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">except_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">except_contents</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">format_function_param</span><span class="p">(</span><span class="s1">&#39;try_except&#39;</span><span class="p">,</span> <span class="n">error_var</span><span class="o">=</span><span class="n">error_var</span><span class="p">,</span>
                                             <span class="n">error_type</span><span class="o">=</span><span class="n">error_type</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">except_contents</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># Close block</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;try_end&#39;</span><span class="p">,</span>
                                          <span class="bp">cls</span><span class="o">.</span><span class="n">function_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                              <span class="s1">&#39;block_end&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">out</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, Meagan Lang, David Raila.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>